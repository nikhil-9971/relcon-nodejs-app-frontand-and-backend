<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manual Plan Creation</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 13px;
      }
      .label {
        font-weight: 600;
        color: #1f2937;
        font-size: 13px;
        margin-bottom: 4px;
        display: block;
      }
      .form-input,
      .form-select {
        width: 100%;
        padding: 0.45rem 0.6rem;
        font-size: 13px;
        border: 1px solid #cbd5e1;
        background-color: #fff;
        border-radius: 0.125rem;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .form-input[readonly] {
        background-color: #f8fafc;
      }
      .btn {
        padding: 0.45rem 1rem;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border-radius: 0.125rem;
      }
      .btn-yellow {
        background-color: #facc15;
        color: #1f2937;
      }
      .btn-yellow:hover {
        background-color: #eab308;
      }
      .btn-green {
        background: linear-gradient(to right, #22c55e, #16a34a);
        color: white;
      }
      .btn-green:hover {
        background: linear-gradient(to right, #16a34a, #15803d);
      }
      .card {
        background: #ffffff;
        padding: 1.5rem;
        margin: auto;
        max-width: 860px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.07);
        border-radius: 0.125rem;
      }
      .grid-cols-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1rem;
      }
      .header-bar {
        background-color: #22c55e;
        color: white;
        padding: 10px 16px;
        font-weight: 700;
        margin-bottom: 1.25rem;
        font-size: 14px;
        border-radius: 0.125rem;
      }
      #toast {
        transition: opacity 0.5s ease-in-out;
      }

      .spin {
        animation: spin 0.6s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="p-4">
    <div id="dailyPlan">
      <form method="post" onsubmit="handleSubmit(event)" id="formId">
        <div class="card">
          <div class="header-bar">‚ûï Manually Plan Creation</div>

          <div class="grid-cols-2 mb-4">
            <div class="col-span-2 flex gap-2">
              <input
                id="roCode"
                type="text"
                placeholder="Enter Ro Code"
                maxlength="8"
                class="form-input uppercase flex-grow rounded-lg"
              />
              <button
                id="searchBtn"
                type="button"
                onclick="fetchROInfo()"
                class="btn btn-yellow btn-animate flex items-center gap-1 px-3 py-1 rounded text-sm bg-yellow-400 hover:bg-yellow-300"
              >
                <span id="searchIcon" class="">üîç</span>
                <span>Search</span>
              </button>
            </div>

            <div>
              <label class="label">üè¢ RO NAME:</label
              ><input id="roName" type="text" class="form-input rounded-lg" />
            </div>
            <div>
              <label class="label">üåç REGION:</label
              ><input id="region" type="text" class="form-input rounded-lg" />
            </div>

            <div>
              <label class="label">üîÑ PHASE:</label>
              <select id="phase" class="form-select rounded-lg">
                <option disabled selected>Select Phase ‚¨áÔ∏è</option>
                <option>HPCL/Phase-X</option>
                <option>HPCL/Phase-IX</option>
                <option>HPCL/Phase-XI</option>
                <option>HPCL/Phase-XII</option>
                <option>HPCL/Phase-XIII</option>
                <option>RBML</option>
                <option>BPCL</option>
                <option>NPL</option>
                <option>NO PLAN</option>
                <option>IN LEAVE</option>
                <option>HPCL OFFICE</option>
              </select>
            </div>
            <div>
              <label class="label">üìÖ Schedule Date:</label
              ><input id="date" type="date" class="form-input rounded-lg" />
            </div>
            <div>
              <label class="label">‚ö†Ô∏è Issue Type:</label>
              <select id="issueType" class="form-select rounded-lg">
                <option disabled selected>Select Issue Type ‚¨áÔ∏è</option>
                <option>Issue Visit</option>
                <option>PM Visit</option>
                <option>Issue & PM Visit</option>
                <option>Survey</option>
                <option>Power ON</option>
                <option>SAT</option>
                <option>NO PLAN</option>
                <option>HPCL OFFICE</option>
              </select>
            </div>
            <div>
              <label class="label">üë∑‚Äç‚ôÇÔ∏è Engineer Name:</label>
              <select id="engineer" class="form-select rounded-lg">
                <option disabled selected>Select Engineer Name ‚¨áÔ∏è</option>
                <option>Abhishek Pathak</option>
                <option>Amit Kumar</option>
                <option>Banti Kumar</option>
                <option>Gautam Kumar</option>
                <option>Gautam Kumar (Purnia)</option>
                <option>Kaushal Pandey</option>
                <option>Raushan Kumar</option>
                <option>Shaurav Kumar</option>
                <option>Vinit Kumar</option>
              </select>
            </div>
            <div>
              <label class="label">üè¢ AMC Year_Qtr:</label
              ><input id="amcQtr" type="text" class="form-input rounded-lg" />
            </div>
            <div>
              <label class="label">üìù PURPOSE OF VISIT:</label>
              <input
                id="purpose"
                type="text"
                class="form-input uppercase rounded-lg"
                oninput="this.value = this.value.toUpperCase();"
              />
            </div>
          </div>

          <button
            id="submitBtn"
            class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded mt-4 flex items-center justify-center gap-2"
          >
            <span id="submitText">üöÄ Submit</span>
          </button>
          <p class="text-center text-gray-500 text-xs mt-4">
            üë®‚Äçüíª Developed By Advit Software| Version: 23.05.25
          </p>
        </div>
      </form>
    </div>

    <!-- Toast Notification -->
    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed top-5 right-5 z-50 hidden p-4 rounded-lg shadow-lg text-white text-sm font-semibold bg-green-600 transition-opacity duration-500 opacity-0"
    >
      ‚úÖ Plan submitted successfully!
    </div>

    <script>
      async function handleSubmit(event) {
        event.preventDefault();

        const data = {
          roCode: document.getElementById("roCode").value.trim().toUpperCase(),
          date: document.getElementById("date").value,
          roName: document.getElementById("roName").value,
          region: document.getElementById("region").value,
          phase: document.getElementById("phase").value,
          issueType: document.getElementById("issueType").value,
          engineer: document.getElementById("engineer").value,
          amcQtr: document.getElementById("amcQtr").value,
          purpose: document.getElementById("purpose").value.toUpperCase(),
        };

        const btn = document.getElementById("submitBtn");
        const text = document.getElementById("submitText");

        btn.disabled = true;
        text.innerHTML =
          '<span class="spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Submitting...';

        // ‚úÖ Check if this RO Code + Date combo already exists
        try {
          const checkRes = await fetch(
            `https://relconecz-node.onrender.com/checkDuplicate?roCode=${data.roCode}&date=${data.date}`
          );
          const exists = await checkRes.json();

          if (exists?.duplicate) {
            showToast("‚ùó Visit record already submitted", "bg-red-600");
            btn.disabled = false;
            text.innerHTML = "üöÄ Submit";
            return;
          }
        } catch (err) {
          console.error("Error checking duplicate:", err);
          showToast("‚ùå Error validating duplicate record", "bg-red-600");
          btn.disabled = false;
          text.innerHTML = "üöÄ Submit";
          return;
        }

        // ‚è≥ Proceed to submit
        const response = await fetch(
          "https://relconecz-node.onrender.com/saveDailyPlan",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          }
        );

        btn.disabled = false;
        text.innerHTML = "üöÄ Submit";

        if (response.ok) {
          showToast("‚úÖ Plan submitted successfully!");
          document.getElementById("formId").reset();
        } else {
          showToast("‚ùå Error submitting plan.", "bg-red-600");
        }
      }

      // Set current date as default in Date of Visit field
      const today = new Date().toISOString().split("T")[0];
      date.value = today;

      function showToast(message, bgColor = "bg-green-600") {
        const toast = document.getElementById("toast");
        if (!toast) return;

        toast.textContent = message;

        // Reset classes and set new background
        toast.className = `fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg text-white text-sm font-semibold transition-opacity duration-500 opacity-0 ${bgColor}`;

        toast.classList.remove("hidden");
        setTimeout(() => {
          toast.classList.add("opacity-100"); // fade in
        }, 10);

        // Auto-hide after 3 seconds
        setTimeout(() => {
          toast.classList.remove("opacity-100"); // fade out
          setTimeout(() => {
            toast.classList.add("hidden");
          }, 500); // wait for fade-out to complete
        }, 3000);
      }
      async function fetchROInfo() {
        const roCode = document
          .getElementById("roCode")
          .value.trim()
          .toUpperCase();
        if (!roCode) return alert("Please enter RO Code");

        const icon = document.getElementById("searchIcon");
        icon.classList.add("spin");

        try {
          await new Promise((resolve) => setTimeout(resolve, 2000)); // simulate delay
          //alert("üîç RO Info fetched!");
        } catch (err) {
          alert("Error fetching RO info.");
        } finally {
          icon.classList.remove("spin");
        }

        try {
          const res = await fetch(
            `https://relconecz-node.onrender.com/getROInfo/${roCode}`
          );
          if (!res.ok) throw new Error("RO Code not found");

          const data = await res.json();
          document.getElementById("roName").value = data.roName || "";
          document.getElementById("region").value = data.region || "";
          document.getElementById("phase").value = data.phase || "";
          document.getElementById("engineer").value = data.engineer || "";

          // Make fields readonly
          document.getElementById("roName").readOnly = true;
          document.getElementById("region").readOnly = true;

          // For <select> disable the dropdown
          document.getElementById("phase").disabled = true;
        } catch (err) {
          alert("RO Code not found in master data");
        }
      }

      //Issue Type visit amcQty Validation

      document
        .getElementById("issueType")
        .addEventListener("change", async function () {
          const selectedType = this.value;
          const roCode = document
            .getElementById("roCode")
            .value.trim()
            .toUpperCase();

          if (!roCode) return; // do nothing if roCode is empty

          if (
            selectedType === "PM Visit" ||
            selectedType === "Issue & PM Visit"
          ) {
            try {
              const res = await fetch(
                `https://relconecz-node.onrender.com/getROInfo/${roCode}`
              );
              if (!res.ok) throw new Error("RO Code not found");

              const data = await res.json();
              document.getElementById("amcQtr").value = data.amcQtr || "";
              document.getElementById("amcQtr").readOnly = true;
            } catch (err) {
              console.error(err);
              alert("Unable to fetch AMC Quarter for this RO Code.");
            }
          } else {
            // If any other issue type selected, make amcQtr editable
            document.getElementById("amcQtr").readOnly = false;
            document.getElementById("amcQtr").value = "Excluding PM Visit";
          }
        });
      //PHASE SELECTION
      document.getElementById("phase").addEventListener("change", function () {
        const selectedPhase = this.value;

        if (selectedPhase === "NO PLAN") {
          // Set fields
          document.getElementById("roCode").value = "N/A";
          document.getElementById("roName").value = "NO PLAN";
          document.getElementById("issueType").value = "NO PLAN";
          document.getElementById("purpose").value = "NO PLAN";
          document.getElementById("amcQtr").value = "NO PLAN";

          // Replace REGION input with dropdown
          const regionContainer =
            document.getElementById("region").parentElement;
          regionContainer.innerHTML = `
        <label class="label">üåç REGION:</label>
        <select id="region" class="form-select rounded-lg">
          <option>BEGUSARAI RET RO</option>
          <option>PATNA RETAIL RO</option>
        </select>
      `;
        } else {
          // If phase is not NO PLAN, reload form section to restore original REGION input
          const regionContainer =
            document.getElementById("region").parentElement;
          regionContainer.innerHTML = `
        <label class="label">üåç REGION:</label>
        <input id="region" type="text" class="form-input rounded-lg" />
      `;
        }
      });
    </script>
  </body>
</html>
