<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Task Management | RELCON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 12px;
      }
      .email-content {
        white-space: pre-wrap;
        font-family: monospace;
        background: #f3f4f6;
        padding: 8px;
        border-radius: 4px;
        display: none;
      }
    </style>
  </head>
  <body class="p-6">
    <div class="max-w-7xl mx-auto bg-white shadow p-6 rounded">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold">ðŸ“Œ Task Management</h1>
        <button
          onclick="fetchTasks()"
          class="bg-blue-600 text-white px-4 py-2 rounded"
        >
          ðŸ”„ Refresh
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full table-auto text-[11px] border">
          <thead class="bg-gray-200">
            <tr>
              <th class="border px-3 py-2">RO Code</th>
              <th class="border px-3 py-2">RO Name</th>
              <th class="border px-3 py-2">Issue</th>
              <th class="border px-3 py-2">Engineer</th>
              <th class="border px-3 py-2">Email</th>
              <th class="border px-3 py-2">Status</th>
              <th class="border px-3 py-2">Mail Date</th>
              <th class="border px-3 py-2">Task Completed By</th>
              <th class="border px-3 py-2">Mail Reply</th>
              <th class="border px-3 py-2">Actions</th>
            </tr>
          </thead>
          <tbody id="taskTableBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      const token = localStorage.getItem("token");

      async function fetchTasks() {
        const res = await fetch(`${baseUrl}/getTasks`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const tasks = await res.json();
        renderTasks(tasks);
      }

      function renderTasks(tasks) {
        const tbody = document.getElementById("taskTableBody");
        tbody.innerHTML = "";
        tasks.forEach((task) => {
          const row = document.createElement("tr");
          row.className = "border-b";

          const voltage = task.voltageReading
            ? ` <br/><span class='text-gray-500'>(Voltage: ${task.voltageReading}V)</span>`
            : "";
          const duRemark = task.duRemark
            ? `<br/><span class='text-gray-500'>(Remark: ${task.duRemark})</span>`
            : "";

          const issueText =
            task.issue.includes("Earthing") && task.voltageReading
              ? task.issue.replace(
                  "Earthing NOT OK",
                  `Earthing NOT OK${voltage}`
                )
              : task.issue;

          const finalIssueText =
            issueText.includes("DU Offline") && task.duRemark
              ? issueText.replace(
                  /DU Offline: \d+/,
                  (match) => `${match}${duRemark}`
                )
              : issueText;

          row.innerHTML = `
            <td class="border px-3 py-2">${task.roCode}</td>
            <td class="border px-3 py-2">${task.roName}</td>
            <td class="border px-3 py-2 text-red-600 font-semibold">${finalIssueText}</td>
            <td class="border px-3 py-2">${task.engineer}</td>
            <td class="border px-3 py-2 text-center">
              <button onclick="toggleEmail('${
                task._id
              }')" class="text-blue-600 underline">Show/Hide</button>
              <div id="email_${task._id}" class="email-content mt-1">${
            task.emailContent
          }</div>
            </td>
            <td class="border px-3 py-2">
              <select onchange="updateTaskStatus('${
                task._id
              }', this.value)" class="border px-2 py-1 rounded">
                <option value="Pending" ${
                  task.status === "Pending" ? "selected" : ""
                }>Pending</option>
                <option value="Mailed" ${
                  task.status === "Mailed" ? "selected" : ""
                }>Mailed</option>
                <option value="Resolved" ${
                  task.status === "Resolved" ? "selected" : ""
                }>Resolved</option>
              </select>
            </td>
            <td class="border px-3 py-2">
              <input type="date" value="${
                task.mailDate || ""
              }" onchange="updateTaskField('${
            task._id
          }', 'mailDate', this.value)" class="border px-2 py-1 rounded w-full" />
            </td>
            <td class="border px-3 py-2">
              <select onchange="updateTaskField('${
                task._id
              }', 'completedBy', this.value)" class="border px-2 py-1 rounded w-full">
                <option value="">Select</option>
                <option value="Anurag Mishra" ${
                  task.completedBy === "Anurag Mishra" ? "selected" : ""
                }>Anurag Mishra</option>
                <option value="Nikhil Trivedi" ${
                  task.completedBy === "Nikhil Trivedi" ? "selected" : ""
                }>Nikhil Trivedi</option>
              </select>
            </td>
            <td class="border px-3 py-2">
              <textarea onchange="updateTaskField('${
                task._id
              }', 'mailReply', this.value)" class="border w-full p-1 rounded" rows="2">${
            task.mailReply || ""
          }</textarea>
            </td>
            <td class="border px-3 py-2">
              <button onclick="copyToClipboard('${
                task._id
              }')" class="bg-green-600 text-white px-2 py-1 rounded text-xs">ðŸ“‹ Copy Email</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      function toggleEmail(taskId) {
        const emailDiv = document.getElementById("email_" + taskId);
        if (emailDiv) {
          emailDiv.style.display =
            emailDiv.style.display === "none" ? "block" : "none";
        }
      }

      function copyToClipboard(taskId) {
        const text = document.getElementById("email_" + taskId).innerText;
        navigator.clipboard.writeText(text).then(() => {
          alert("ðŸ“‹ Email content copied!");
        });
      }

      async function updateTaskStatus(id, status) {
        await fetch(`${baseUrl}/updateTask/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ status }),
        });
      }

      async function updateTaskField(id, field, value) {
        await fetch(`${baseUrl}/updateTask/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ [field]: value }),
        });
      }

      window.onload = fetchTasks;
    </script>
  </body>
</html>
