<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Task Management | RELCON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 12px;
      }
      .email-content {
        white-space: pre-wrap;
        font-family: monospace;
        background: #f3f4f6;
        padding: 8px;
        border-radius: 4px;
        display: none;
      }
    </style>
  </head>
  <body class="p-6">
    <div class="max-w-7xl mx-auto bg-white shadow p-6 rounded">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold">üìå Task Management</h1>
        <button
          onclick="fetchTasks()"
          class="bg-blue-600 text-white px-4 py-2 rounded"
        >
          üîÑ Refresh
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full table-auto text-[11px] border">
          <thead class="bg-gray-200">
            <tr>
              <th class="border px-2 py-1">RO Code</th>
              <th class="border px-2 py-1">RO Name</th>
              <th class="border px-2 py-1">Date of Visit</th>
              <th class="border px-2 py-1">Issue</th>
              <th class="border px-2 py-1">Engineer</th>
              <th class="border px-2 py-1">Email</th>
              <th class="border px-2 py-1">Status</th>
              <th class="border px-2 py-1">Mail Date</th>
              <th class="border px-2 py-1">Task Completed By</th>
              <th class="border px-2 py-1">Mail Reply</th>
              <th class="border px-2 py-1">Actions</th>
            </tr>
          </thead>
          <tbody id="taskTableBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      const token = localStorage.getItem("token");

      async function fetchTasks() {
        const res = await fetch(`${baseUrl}/getTasks`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const tasks = await res.json();

        // ‚úÖ Fix here: define isAdmin before renderTasks
        const user = JSON.parse(localStorage.getItem("user")) || {};
        const isAdmin = user.role === "admin";
        renderTasks(tasks, isAdmin);
      }

      function renderTasks(tasks, isAdmin) {
        const tbody = document.getElementById("taskTableBody");
        tbody.innerHTML = "";
        tasks.forEach((task) => {
          const row = document.createElement("tr");
          row.className = "border-b";

          let issueParts = [];
          if (task.earthingStatus && task.earthingStatus !== "OK") {
            let part = `Earthing Status ‚Üí ${task.earthingStatus}`;
            if (task.voltageReading)
              part += ` (Voltage: ${task.voltageReading})`;
            issueParts.push(part);
          }
          if (task.duOffline && task.duOffline !== "ALL OK") {
            let part = `DU Offline ‚Üí ${task.duOffline}`;
            if (task.duRemark) part += ` (Remark: ${task.duRemark})`;
            issueParts.push(part);
          }

          const issueFormatted = issueParts.length
            ? issueParts.join("<br>")
            : "-";

          let emailContent = `Dear Sir/Ma'am,\n\nDuring the recent visit on dated ${task.date} at ${task.roName} (RO Code: ${task.roCode}), the engineer observed:\n\n`;
          if (task.earthingStatus && task.earthingStatus !== "OK") {
            emailContent += `‚û°Ô∏è Earthing Status ‚Üí ${task.earthingStatus}`;
            if (task.voltageReading)
              emailContent += ` (Voltage measurement reading: ${task.voltageReading})`;
            emailContent += "\n";
          }
          if (task.duOffline && task.duOffline !== "ALL OK") {
            emailContent += `‚û°Ô∏è DU Offline ‚Üí ${task.duOffline}`;
            if (task.duRemark)
              emailContent += ` (Offline DU remark: ${task.duRemark})`;
            emailContent += "\n";
          }
          emailContent += `\nPlease resolve HPCL dependencies at the earliest and confirm on mail after resolution.\n\nRegards,\nRELCON Systems`;

          row.innerHTML = `
                  <td class="border px-3 py-2">${task.roCode}</td>
                  <td class="border px-3 py-2">${task.roName}</td>
                  <td class="border px-3 py-2">${task.date}</td>
                  <td class="border px-3 py-2 text-red-600 font-semibold text-[9px]">${issueFormatted}</td>
                  <td class="border px-3 py-2">${task.engineer}</td>
                  <td class="border text-center px-2 py-1">
        <button onclick="copyEmail('${
          task._id
        }')" class="bg-green-600 text-white px-2 py-1 rounded text-xs">
          üìã Copy Email
        </button>
      </td>

                  <td class="border px-3 py-2">
                    <select onchange="updateTaskStatus('${
                      task._id
                    }', this.value)" class="border px-2 py-1 rounded">
                      <option value="Pending" ${
                        task.status === "Pending" ? "selected" : ""
                      }>Pending</option>
                      <option value="Mailed" ${
                        task.status === "Mailed" ? "selected" : ""
                      }>Mailed</option>
                      <option value="Resolved" ${
                        task.status === "Resolved" ? "selected" : ""
                      }>Resolved</option>
                    </select>
                  </td>
                  <td class="border px-3 py-2">
                    <input type="date" value="${
                      task.mailDate || ""
                    }" onchange="updateTaskField('${
            task._id
          }', 'mailDate', this.value)" class="border px-2 py-1 rounded w-full" />
                  </td>
                  <td class="border px-3 py-2">
                    <select onchange="updateTaskField('${
                      task._id
                    }', 'completedBy', this.value)" class="border px-2 py-1 rounded w-full">
                      <option value="">Select</option>
                      <option value="Anurag Mishra" ${
                        task.completedBy === "Anurag Mishra" ? "selected" : ""
                      }>Anurag Mishra</option>
                      <option value="Nikhil Trivedi" ${
                        task.completedBy === "Nikhil Trivedi" ? "selected" : ""
                      }>Nikhil Trivedi</option>
                    </select>
                  </td>
                  <td class="border px-3 py-2">
                    <textarea onchange="updateTaskField('${
                      task._id
                    }', 'mailReply', this.value)" class="border w-full p-1 rounded" rows="2">${
            task.mailReply || ""
          }</textarea>
                  </td>
                 <td class="border text-center px-2 py-1">
        ${
          isAdmin && task.status === "Mailed"
            ? `
          <button onclick="submitTask('${task._id}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">
            ‚úÖ Submit
          </button>
        `
            : ""
        }
      </td>

                `;
          tbody.appendChild(row);
        });
      }

      function toggleEmail(taskId) {
        const emailDiv = document.getElementById("email_" + taskId);
        if (emailDiv) {
          emailDiv.style.display =
            emailDiv.style.display === "none" ? "block" : "none";
        }
      }

      async function copyEmail(id) {
        const res = await fetch(`${baseUrl}/getTasks`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const tasks = await res.json();
        const task = tasks.find((t) => t._id === id);
        if (task?.emailContent) {
          await navigator.clipboard.writeText(task.emailContent);
          alert("üìã Email copied!");
        }
      }

      async function updateTaskStatus(id, status) {
        await fetch(`${baseUrl}/updateTask/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ status }),
        });
      }

      async function updateTaskField(id, field, value) {
        await fetch(`${baseUrl}/updateTask/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ [field]: value }),
        });
      }

      async function submitTask(id) {
        const row = document
          .querySelector(`button[onclick="submitTask('${id}')"]`)
          .closest("tr");
        const statusSelect = row.querySelector("select");
        const status = statusSelect ? statusSelect.value : "";

        if (status !== "Mailed") {
          alert("‚ùå You can only submit a task when its status is 'Mailed'.");
          return;
        }

        const mailDate = row.querySelector('input[type="date"]').value;
        const completedBy = row.querySelectorAll("select")[1].value;
        const mailReply = row.querySelector("textarea").value;

        const res = await fetch(`${baseUrl}/updateTask/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            status: "Resolved",
            mailDate,
            completedBy,
            mailReply,
          }),
        });

        if (res.ok) {
          alert("‚úÖ Task submitted and marked as Resolved");
          fetchTasks();
        } else {
          alert("‚ùå Failed to submit task");
        }
      }

      window.onload = fetchTasks;
    </script>
  </body>
</html>
