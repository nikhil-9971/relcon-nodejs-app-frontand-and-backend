<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Jio BP Status Records</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 12px;
      }
      th,
      td {
        white-space: nowrap;
      }
      thead th {
        position: sticky;
        top: 0;
        background-color: #f3f4f6;
        z-index: 1;
      }
    </style>
  </head>
  <body class="p-6 bg-gray-100 text-[9px]">
    <div class="max-w-7xl mx-auto bg-white p-6 shadow rounded">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold">üìÑ Jio BP Status Report</h1>
        <div class="flex items-center gap-2">
          <img src="./assets/JioBP.png" alt="JIO BP" class="h-16" />
        </div>
        <button
          onclick="exportToExcel()"
          class="bg-green-600 text-white px-4 py-2 rounded"
        >
          üì§ Export
        </button>
      </div>

      <!-- Filter -->
      <div class="flex flex-wrap items-center gap-4 mb-4">
        <div>
          <label
            for="fromDate"
            class="block text-[12px] font-medium text-gray-700"
            >üìÖ From:</label
          >
          <input
            type="date"
            id="fromDate"
            class="border border-gray-300 rounded px-2 py-1 text-[12px]"
            onchange="applyDateRangeFilter()"
          />
        </div>
        <div>
          <label
            for="toDate"
            class="block text-[12px] font-medium text-gray-700"
            >üìÖ To:</label
          >
          <input
            type="date"
            id="toDate"
            class="border border-gray-300 rounded px-2 py-1 text-[12px]"
            onchange="applyDateRangeFilter()"
          />
        </div>
        <div class="self-end">
          <button
            onclick="clearDateRangeFilter()"
            class="bg-yellow-500 text-white px-4 py-2 rounded"
          >
            ‚ôªÔ∏è Clear Filter
          </button>
        </div>
      </div>

      <!-- ‚úÖ Search Bar -->
      <div class="mb-4">
        <input
          type="text"
          id="searchInput"
          oninput="applySearch()"
          placeholder="üîé Search anything..."
          class="w-full border px-3 py-2 rounded"
        />
      </div>

      <div
        class="overflow-x-auto max-h-[70vh] overflow-y-auto border border-gray-300 rounded"
      >
        <table class="min-w-full text-xs" id="jioTable">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-3 py-2 border">Engineer</th>
              <th class="px-3 py-2 border">Region</th>
              <th class="px-3 py-2 border">RO Code</th>
              <th class="px-3 py-2 border">RO Name</th>
              <th class="px-3 py-2 border">Purpose of Visit</th>
              <th class="px-3 py-2 border">Date</th>
              <th class="px-3 py-2 border">HPSD ID</th>
              <th class="px-3 py-2 border">Diagnosis</th>
              <th class="px-3 py-2 border">Solution</th>
              <th class="px-3 py-2 border">Active Material Used</th>
              <th class="px-3 py-2 border">Used Material Name & Code</th>
              <th class="px-3 py-2 border">Faulty Material Name & Code</th>
              <th class="px-3 py-2 border">Spare Requirement</th>
              <th class="px-3 py-2 border">Observation (in Hours)</th>
              <th class="px-3 py-2 border">Material Requirement Name</th>
              <th class="px-3 py-2 border">Status</th>
            </tr>
          </thead>
          <tbody id="jioBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      let jioData = [];
      let currentUser = {};

      async function fetchData() {
        const token = localStorage.getItem("token");
        currentUser = JSON.parse(localStorage.getItem("user")) || {};

        const res = await fetch(`${baseUrl}/getAllJioBPStatus`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await res.json();

        // üë∑ Only show engineer's own data
        if (currentUser.role === "engineer") {
          jioData = data.filter((d) => d.createdBy === currentUser.username);
        } else {
          jioData = data.map((d) => ({ ...d, ...d.planId }));
        }

        renderTable(jioData);
      }

      function renderTable(data) {
        const tbody = document.getElementById("jioBody");
        tbody.innerHTML = data
          .map((row) => {
            return `
              <tr>
                <td class="border px-2 py-1">${row.engineer || ""}</td>
                <td class="border px-2 py-1">${row.region || ""}</td>
                <td class="border px-2 py-1">${row.roCode || ""}</td>
                <td class="border px-2 py-1">${row.roName || ""}</td>
                <td class="border px-2 py-1">${row.purpose || ""}</td>
                <td class="border px-2 py-1" data-date="${row.date || ""}">${
              row.date || ""
            }</td>
                <td class="border px-2 py-1">${row.hpsdId || ""}</td>
                <td class="border px-2 py-1">${row.diagnosis || ""}</td>
                <td class="border px-2 py-1">${row.solution || ""}</td>
                <td class="border px-2 py-1">${
                  row.activeMaterialUsed || ""
                }</td>
                <td class="border px-2 py-1">${
                  row.usedMaterialDetails || ""
                }</td>
                <td class="border px-2 py-1">${
                  row.faultyMaterialDetails || ""
                }</td>
                <td class="border px-2 py-1">${row.spareRequired || ""}</td>
                <td class="border px-2 py-1">${row.observationHours || ""}</td>
                <td class="border px-2 py-1">${
                  row.materialRequirement || ""
                }</td>
                <td class="border px-2 py-1">${row.status || ""}</td>
              </tr>
            `;
          })
          .join("");
      }

      function applyDateRangeFilter() {
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;
        const rows = document.querySelectorAll("table tbody tr");

        rows.forEach((row) => {
          const dateCell = row.querySelector("td[data-date]"); // Add this attribute in your date <td>
          if (!dateCell) return;

          const rowDate = dateCell.getAttribute("data-date");

          if (
            (!fromDate || rowDate >= fromDate) &&
            (!toDate || rowDate <= toDate)
          ) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      function clearDateRangeFilter() {
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";
        applyDateRangeFilter(); // Reset filters
      }

      function applySearch() {
        const searchValue = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();
        const rows = document.querySelectorAll("table tbody tr");

        rows.forEach((row) => {
          const rowText = row.textContent.toLowerCase();
          row.style.display = rowText.includes(searchValue) ? "" : "none";
        });
      }

      function exportToExcel() {
        const ws = XLSX.utils.table_to_sheet(
          document.getElementById("jioTable")
        );
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "JioBP Status");
        XLSX.writeFile(
          wb,
          `JioBP_Report_${new Date().toISOString().slice(0, 10)}.xlsx`
        );
      }

      fetchData();
    </script>
  </body>
</html>
