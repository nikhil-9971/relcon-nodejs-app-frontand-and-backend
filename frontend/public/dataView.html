<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Daily Plan Data View</title>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 12px;
      }
      .toast-show {
        display: block !important;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }

      @keyframes fadein {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeout {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }
      table {
        font-size: 10px !important; /* chhota font */
        table-layout: auto !important; /* auto-width columns */
        width: max-content !important; /* content ke according width */
      }

      table th,
      table td {
        white-space: nowrap !important; /* wrap band */
        text-align: center !important; /* ‚úÖ center align */
        vertical-align: middle !important;
        padding: 4px 6px !important;
        font-size: 10px !important;
      }

      #statusModal label {
        font-size: 11px !important;
      }
    </style>
  </head>

  <body class="bg-gray-100 p-6 text-[11px]">
    <div class="max-w-6xl mx-auto bg-white p-6 shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold">üìã Visit Records</h1>
        <div class="text-right">
          <div id="userInfo" class="font-medium text-blue-700 mb-1"></div>

          <!-- <button
            onclick="logout()"
            class="bg-red-500 text-white px-3 py-1 text-sm rounded"
          >
            üö™ Logout
          </button> -->
        </div>
      </div>

      <!-- ‚úÖ Filter Section -->
      <div class="flex flex-wrap items-end gap-4 mb-4">
        <div id="engineerFilterWrapper">
          <label class="block font-semibold mb-1">Engineer:</label>
          <select id="engineerFilter" class="border px-2 py-1 rounded">
            <option value="">All</option>
          </select>
        </div>
        <div>
          <label class="block font-semibold mb-1">From Date:</label>
          <input
            type="date"
            id="fromDate"
            class="border px-2 py-1 rounded"
            onchange="checkFilterValidity()"
          />
        </div>
        <div>
          <label class="block font-semibold mb-1">To Date:</label>
          <input
            type="date"
            id="toDate"
            class="border px-2 py-1 rounded"
            onchange="checkFilterValidity()"
          />
        </div>
        <div>
          <button
            id="applyBtn"
            onclick="applyFilter(this)"
            class="bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2"
            disabled
          >
            <span id="applyIcon">üîç</span> Apply Filter
          </button>
        </div>
        <div>
          <button
            onclick="clearFilter()"
            class="bg-yellow-500 text-white px-4 py-2 rounded"
          >
            ‚ôªÔ∏è Clear Filter
          </button>
        </div>
      </div>

      <!-- ‚úÖ Search Bar -->
      <div class="mb-4">
        <input
          type="text"
          id="searchInput"
          oninput="applySearch()"
          placeholder="üîé Search anything..."
          class="w-full border px-3 py-2 rounded"
        />
      </div>

      <button
        onclick="exportStyledExcel()"
        class="bg-green-600 text-white px-3 py-1 rounded"
      >
        <i class="fa-solid fa-file-excel"></i>
      </button>
      <br />

      <div
        class="overflow-x-auto max-h-[500px] border border-gray-300 rounded-lg"
      >
        <table
          id="dataTable"
          class="min-w-full bg-white border border-gray-300 table-auto"
        >
          <thead class="bg-gray-200 sticky top-0 z-10 shadow text-[11px]">
            <tr>
              <th class="px-1 py-1">Region</th>
              <th
                class="px-1 py-1 cursor-pointer"
                data-key="engineer"
                onclick="sortTable(this)"
              >
                Engineer
              </th>
              <th class="px-1 py-1">Phase</th>
              <th class="px-1 py-1">RO Code</th>
              <th class="px-1 py-1">RO Name</th>
              <th class="px-1 py-1">Purpose</th>
              <th class="px-1 py-1">Date</th>
              <th class="px-1 py-1">Issue Type</th>
              <th class="px-1 py-1">AMC Qtr</th>
              <th class="px-1 py-1">Completion Status</th>
              <th class="px-1 py-1">Update Status</th>
              <th class="px-1 py-1" id="atgHeader">Update ATG Status</th>
              <th class="px-1 py-1" id="actionHeader">Action</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="text-[10px]"></tbody>
        </table>

        <!-- Pignation add
          -->
        <div
          id="pagination"
          class="flex justify-center mt-4 gap-1 text-sm text-gray-700"
        ></div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div
      id="editModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-lg w-full max-w-xl">
        <h2 class="text-lg font-bold mb-4">‚úèÔ∏è Edit Visit Record</h2>
        <input type="hidden" id="editPlanId" />
        <div class="grid grid-cols-2 gap-4 text-sm">
          <input
            id="editRegion"
            placeholder="Region"
            class="border px-3 py-1 rounded"
          />
          <input
            id="editEngineer"
            placeholder="Engineer"
            class="border px-3 py-1 rounded"
          />
          <input
            id="editPhase"
            placeholder="Phase"
            class="border px-3 py-1 rounded"
          />
          <input
            id="editRoCode"
            placeholder="RO Code"
            class="border px-3 py-1 rounded"
          />
          <input
            id="editRoName"
            placeholder="RO Name"
            class="border px-3 py-1 rounded"
          />
          <input
            id="editPurpose"
            placeholder="Purpose"
            class="border px-3 py-1 rounded"
          />
          <input
            id="editDate"
            placeholder="Date"
            class="border px-3 py-1 rounded"
          />
          <input
            id="editIssueType"
            placeholder="Issue Type"
            class="border px-3 py-1 rounded"
          />
          <input
            id="editAmcQtr"
            placeholder="AMC Qtr"
            class="border px-3 py-1 rounded"
          />
        </div>
        <div class="mt-4 text-right space-x-2">
          <button
            onclick="closeEditModal()"
            class="bg-gray-300 px-4 py-2 rounded"
          >
            Cancel
          </button>
          <button
            onclick="saveEdit()"
            class="bg-blue-600 text-white px-4 py-2 rounded"
          >
            üíæ Save
          </button>
        </div>
      </div>
    </div>

    <!-- Status Modal -->
    <div
      id="statusModal"
      class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50"
    >
      <!-- Modal Wrapper -->
      <div
        class="bg-white max-h-[90vh] overflow-y-auto rounded shadow-lg w-full max-w-3xl p-6 relative text-[11px]"
      >
        <div class="flex items-center justify-center mb-4">
          <img src="./assets/HPCL.png" alt="HPCL Logo" class="h-10 w-auto" />
        </div>
        <h2 class="text-xl font-bold mb-4 text-center text-gray-800">
          Add Visit Status
        </h2>
        <input type="hidden" id="statusPlanId" />

        <div class="space-y-4">
          <form id="statusForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- First Row -->
            <div>
              <label class="text-sm font-semibold">Probe Make</label>
              <select
                id="probeMake"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>SI</option>
                <option>SBEM</option>
                <option>Alisonic</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold"
                >Product and Probe Size</label
              >
              <textarea
                id="probeSize"
                required
                placeholder="Example: T1-MS-16KL, T2-HSD-35KL....."
                class="w-full p-2 mt-1 border rounded"
              ></textarea>
            </div>

            <div>
              <label class="text-sm font-semibold">Low Product Lock Set</label>
              <select
                id="lowProductLock"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>350mm/STP</option>
                <option>150mm/Non STP</option>
                <option>350mm&150mm /Non STP</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold"
                >High Water Set at 50mm</label
              >
              <select
                id="highWaterSet"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold"
                >All DU Serial Number Updated</label
              >
              <select
                id="duSerialNumber"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold">DG Status</label>
              <select
                id="dgStatus"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>Standard DG</option>
                <option>Non Standard DG</option>
                <option>No DG Available</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold">Connectivity Type</label>
              <select
                id="connectivityType"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>VSAT</option>
                <option>Broadband</option>
                <option>RELCON SIM</option>
                <option>SDWAN</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold"
                >SIM-1 Service Provider</label
              >
              <select
                id="sim1Provider"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>JIO</option>
                <option>AIRTEL</option>
                <option>VI</option>
                <option>NA</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold">SIM 1 Number</label>
              <input
                type="text"
                id="sim1Number"
                required
                class="w-full p-2 mt-1 border rounded"
              />
            </div>

            <div>
              <label class="text-sm font-semibold"
                >SIM-2 Service Provider</label
              >
              <select
                id="sim2Provider"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>JIO</option>
                <option>AIRTEL</option>
                <option>VI</option>
                <option>NA</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold">SIM 2 Number</label>
              <input
                type="text"
                id="sim2Number"
                required
                class="w-full p-2 mt-1 border rounded"
              />
            </div>

            <div>
              <label class="text-sm font-semibold">IEMI Number</label>
              <input
                type="text"
                id="iemiNumber"
                required
                class="w-full p-2 mt-1 border rounded"
              />
            </div>

            <div>
              <label class="text-sm font-semibold">BOS Version with Date</label>
              <select
                id="bosVersion"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>1.0.30(01-Nov-2023)</option>
                <option>1.0.5(08-Jul-2024)</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold">FCC Version with Date</label>
              <select
                id="fccVersion"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>1.0.30(01-Nov-2023)</option>
                <option>1.0.5(08-Jul-2024)</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold"
                >Wireless Slave Version</label
              >
              <textarea
                id="wirelessSlave"
                required
                placeholder="Example: 1-02.00.60, 2-03.00.70"
                class="w-full p-2 mt-1 border rounded"
              ></textarea>
            </div>

            <div>
              <label class="text-sm font-semibold">SFTP Config</label>
              <select
                id="sftpConfig"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold"
                >Admin Password Updated</label
              >
              <select
                id="adminPassword"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold"
                >Work Completion Status</label
              >
              <select
                id="workCompletion"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>Partial</option>
                <option>All</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold">Earthing Status</label>
              <select
                id="earthingStatus"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>OK</option>
                <option>NOT OK</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold"
                >Voltage Measurment Reading</label
              >
              <textarea
                id="voltageReading"
                required
                placeholder="Example: Earthing OK, PN=234V, PE=233V, NE=1V-> (Need Seperate Earthing /Need Existing Earthing Restore)"
                class="w-full p-2 mt-1 border rounded"
              ></textarea>
            </div>

            <!-- DU Offline Section -->
            <div>
              <label class="text-sm font-semibold">No of DU Offline</label>
              <select
                id="duOffline"
                required
                class="w-full p-2 mt-1 border rounded"
              >
                <option value="">Select</option>
                <option>ALL OK</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>ALL DU ISSUE</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold">Reason for DU Offline</label>
              <textarea
                id="duRemark"
                required
                placeholder="Example: DU-01 POS Card Issue"
                class="w-full p-2 mt-1 border rounded"
              ></textarea>
            </div>

            <!-- location finder -->

            <div>
              <label class="text-sm font-semibold text-red-500"
                >Site Location (Lat, Lng)</label
              >
              <input
                type="text"
                id="locationField"
                class="w-full p-2 mt-1 border rounded bg-gray-100"
                readonly
                placeholder="Fetching location..."
              />
            </div>
          </form>

          <!-- button code -->
          <div
            class="flex justify-end gap-3 mt-6 sticky bottom-0 bg-white pt-4 pb-2"
          >
            <button
              onclick="closeStatusModal()"
              class="bg-gray-300 px-4 py-2 rounded shadow"
            >
              Cancel
            </button>
            <button
              onclick="saveStatus()"
              class="bg-green-600 text-white px-4 py-2 rounded shadow"
            >
              üíæ Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Completion Modal -->
    <div
      id="completionModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded w-full max-w-md">
        <h2 class="text-lg font-semibold mb-3">üìù Enter Completion Status</h2>
        <input type="hidden" id="completionPlanId" />
        <textarea
          id="completionInput"
          rows="3"
          class="w-full border rounded p-2"
        ></textarea>
        <div class="mt-4 text-right">
          <button
            onclick="closeCompletionModal()"
            class="bg-gray-300 px-4 py-2 rounded"
          >
            Cancel
          </button>
          <button
            onclick="saveCompletionStatus()"
            class="bg-green-600 text-white px-4 py-2 rounded"
          >
            üíæ Save
          </button>
        </div>
      </div>
    </div>

    <!-- ATG Status Modal -->
    <div
      id="atgModal"
      class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden"
    >
      <div
        class="bg-white w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-xl shadow-lg p-6 text-[11px]"
      >
        <h2
          class="text-xl font-semibold mb-4 text-center text-gray-800 border-b pb-2"
        >
          üîß Update ATG Status
        </h2>

        <input type="hidden" id="atgPlanId" />

        <form
          id="atgForm"
          class="grid grid-cols-1 md:grid-cols-2 gap-4 text-[11px]"
        >
          <!-- Zone -->
          <div>
            <label class="font-semibold">Zone</label>
            <select id="zone" class="w-full mt-1 border p-2 rounded">
              <option value="">Select</option>
              <option>ECZ</option>
            </select>
          </div>

          <!-- ATG Related Issue -->
          <div>
            <label class="font-semibold">ATG Related Issue</label>
            <input
              type="text"
              id="atgIssuetype"
              class="w-full mt-1 border p-2 rounded"
            />
          </div>

          <!-- TIME TO REACH ENG -->
          <div>
            <label class="font-semibold">Time to Reach Engineer</label>
            <input
              type="time"
              id="startTime"
              class="w-full mt-1 border p-2 rounded"
              step="60"
            />
          </div>

          <!-- Status of Site Before Visit -->
          <div>
            <label class="font-semibold">Status Before Visit</label>
            <input
              type="text"
              id="bfrStatus"
              class="w-full mt-1 border p-2 rounded"
            />
          </div>

          <!-- Action on Site -->
          <div class="md:col-span-2">
            <label class="font-semibold">Action Taken on Site</label>
            <textarea
              id="actionSite"
              rows="3"
              class="w-full mt-1 border p-2 rounded"
            ></textarea>
          </div>

          <!-- Support Taken -->
          <div>
            <label class="font-semibold">Support Taken? With Whom</label>
            <select id="supportPerson" class="w-full mt-1 border p-2 rounded">
              <option value="">Select</option>
              <option>YES/VIREN</option>
              <option>YES/BALDEV</option>
              <option>YES/SAGAR</option>
              <option>YES/DHAVAL</option>
            </select>
          </div>

          <!-- Earthing Status -->
          <div>
            <label class="font-semibold">Earthing Status</label>
            <select id="earthingStatus1" class="w-full mt-1 border p-2 rounded">
              <option value="">Select</option>
              <option>OK</option>
              <option>NOT OK</option>
            </select>
          </div>

          <!-- Resolved Status -->
          <div>
            <label class="font-semibold">Resolved Status</label>
            <select id="resolvedStatus" class="w-full mt-1 border p-2 rounded">
              <option value="">Select</option>
              <option>YES</option>
              <option>NO</option>
            </select>
          </div>

          <!-- Resolved Time -->
          <div>
            <label class="font-semibold">Resolved at What Time?</label>
            <input
              type="time"
              id="endTime"
              class="w-full mt-1 border p-2 rounded"
              step="60"
            />
          </div>

          <!-- Next Action -->
          <div class="md:col-span-2">
            <label class="font-semibold">Next Action (if any)</label>
            <textarea
              id="nextAction"
              rows="2"
              class="w-full mt-1 border p-2 rounded"
            ></textarea>
          </div>

          <!-- Remarks -->
          <div class="md:col-span-2">
            <label class="font-semibold">Remarks</label>
            <textarea
              id="remark"
              rows="2"
              placeholder="Any additional notes"
              class="w-full mt-1 border p-2 rounded"
            ></textarea>
          </div>
        </form>

        <!-- Buttons -->
        <!-- Sticky Bottom Buttons -->
        <div
          class="sticky bottom-0 bg-white py-4 mt-6 border-t border-gray-200 flex justify-end space-x-3"
        >
          <button
            onclick="closeATGModal()"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-5 py-2 rounded shadow"
          >
            Cancel
          </button>
          <button
            onclick="submitATGStatus()"
            class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded shadow"
          >
            üíæ Save
          </button>
        </div>
      </div>
    </div>

    <!-- JIO BP Status Model -->
    <!-- ‚úÖ Jio BP Modal Updated with Grid Layout and Icon -->
    <div
      id="jioBPModal"
      class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white max-h-[90vh] overflow-y-auto rounded shadow-lg w-full max-w-2xl p-6 relative text-[11px]"
      >
        <div class="flex items-center justify-center mb-4">
          <img src="./assets/JioBP.png" alt="JioBP Logo" class="h-10 w-auto" />
        </div>
        <h2 class="text-xl font-bold mb-4 text-center text-gray-800">
          Add Jio BP Visit Status
        </h2>

        <input type="hidden" id="jioBPPlanId" />
        <form id="jioBPForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="font-semibold">HPSD ID</label>
            <input
              type="text"
              id="hpsdId"
              class="w-full p-2 mt-1 border rounded"
            />
          </div>

          <div class="md:col-span-2">
            <label class="font-semibold">Diagnosis</label>
            <textarea
              id="diagnosis"
              class="w-full p-2 mt-1 border rounded"
              placeholder="Explain what is issue and which material faulty"
            ></textarea>
          </div>

          <div class="md:col-span-2">
            <label class="font-semibold">Solution</label>
            <textarea
              id="solution"
              class="w-full p-2 mt-1 border rounded"
              placeholder="Issue Resolved or not and share name of material you have changed"
            ></textarea>
          </div>

          <div>
            <label class="font-semibold">Active Material Used</label>
            <select
              id="activeMaterialUsed"
              class="w-full p-2 mt-1 border rounded"
            >
              <option value="">Select</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>

          <div>
            <label class="font-semibold">Used Material Name & Code</label>
            <input
              type="text"
              id="usedMaterialDetails"
              class="w-full p-2 mt-1 border rounded"
              placeholder="1-CARD READER (H0Q72506220)"
            />
          </div>

          <div class="md:col-span-2">
            <label class="font-semibold">Faulty Material Name & Code</label>
            <input
              type="text"
              id="faultyMaterialDetails"
              class="w-full p-2 mt-1 border rounded"
              placeholder="1-CARD READER (J2Q72506220)"
            />
          </div>

          <div>
            <label class="font-semibold">Observation (in Hours)</label>
            <input
              type="text"
              id="observationHours"
              class="w-full p-2 mt-1 border rounded"
            />
          </div>

          <div>
            <label class="font-semibold">Spare Requirement</label>
            <select id="spareRequired" class="w-full p-2 mt-1 border rounded">
              <option value="">Select</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="font-semibold">Material Requirement Name</label>
            <input
              type="text"
              id="materialRequirement"
              class="w-full p-2 mt-1 border rounded"
              placeholder="Share material name which have required"
            />
          </div>

          <div class="md:col-span-2">
            <label class="font-semibold">Status</label>
            <select id="jioStatus" class="w-full p-2 mt-1 border rounded">
              <option value="">Select</option>
              <option>Resolved</option>
              <option>Unresolved</option>
            </select>
          </div>
        </form>

        <div class="flex justify-end gap-3 mt-6">
          <button
            onclick="closeJioBPModal()"
            class="bg-gray-300 px-4 py-2 rounded shadow"
          >
            Cancel
          </button>
          <button
            onclick="saveJioBPStatus()"
            class="bg-green-600 text-white px-4 py-2 rounded shadow"
          >
            üìè Save
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toast"
      class="fixed top-4 right-4 z-50 hidden rounded-lg px-4 py-2 text-white shadow-lg text-sm"
    ></div>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";

      let fullData = [];
      let filteredData = [];
      let loggedInUser = null;
      let currentPage = 1;
      const rowsPerPage = 10;

      async function fetchUserSession() {
        const token = localStorage.getItem("token");
        const res = await fetch(`${baseUrl}/user`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        if (res.status !== 200) {
          alert("Please log in first.");
          window.location.href = "login.html";
          return;
        }

        const user = await res.json();
        loggedInUser = user;

        document.getElementById("userInfo").innerText = `üë§ Logged in as: ${
          user.engineerName || user.username
        } (${user.role})`;

        if (user.role === "engineer") {
          document.getElementById("engineerFilterWrapper").style.display =
            "none";
          // Hide Action column header for engineers
          const actionHeader = document.getElementById("actionHeader");
          if (actionHeader) actionHeader.style.display = "none";

          // Hide Update ATG Status column
          const atgHeader = document.getElementById("atgHeader");
          if (atgHeader) atgHeader.style.display = "none";
        }
      }

      async function fetchAndStoreData() {
        const token = localStorage.getItem("token");
        const res = await fetch(`${baseUrl}/getDailyPlans`, {
          // credentials: "include",// ‚úÖ this must
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await res.json();
        fullData = data;

        if (loggedInUser.role === "admin") {
          populateEngineerFilter(data);
        }
      }

      function populateEngineerFilter(data) {
        const engineerSelect = document.getElementById("engineerFilter");
        const engineers = [...new Set(data.map((p) => p.engineer))];
        engineers.forEach((name) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          engineerSelect.appendChild(option);
        });
      }

      function applyFilter(
        btnElement = null,
        selectedEngineer = "",
        from = "",
        to = ""
      ) {
        const fromDate = from || document.getElementById("fromDate").value;
        const toDate = to || document.getElementById("toDate").value;

        if (new Date(fromDate) > new Date(toDate)) {
          alert("‚ùå From Date cannot be after To Date.");
          return;
        }

        // Animate only if triggered from UI
        if (btnElement) {
          btnElement.classList.add("pulse");
          btnElement.disabled = true;
          document.getElementById("applyIcon").innerHTML = "‚è≥";
        }

        setTimeout(() => {
          const engineer =
            selectedEngineer || document.getElementById("engineerFilter").value;
          filteredData = fullData;

          if (loggedInUser.role === "engineer") {
            filteredData = filteredData.filter(
              (p) => p.engineer === loggedInUser.engineerName
            );
          }

          if (engineer && loggedInUser.role === "admin" && engineer !== "All") {
            filteredData = filteredData.filter((p) => p.engineer === engineer);
          }

          if (fromDate) {
            filteredData = filteredData.filter(
              (p) => new Date(p.date) >= new Date(fromDate)
            );
          }

          if (toDate) {
            filteredData = filteredData.filter(
              (p) => new Date(p.date) <= new Date(toDate)
            );
          }

          applySearch(); // üîç text search if any

          // Restore button only if it exists
          if (btnElement) {
            btnElement.disabled = false;
            btnElement.classList.remove("pulse");
            document.getElementById("applyIcon").innerHTML = "üîç";
          }
        }, 600);
      }

      function applySearch() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase();

        const finalFiltered = filteredData.filter((plan) =>
          Object.values(plan).some((val) =>
            String(val).toLowerCase().includes(query)
          )
        );
        populateTable(finalFiltered);
      }

      function populateTable(data) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        data.forEach((plan, index) => {
          const row = document.createElement("tr");
          row.className = index % 2 === 0 ? "bg-white" : "bg-gray-50";

          let statusBtn = "";

          if (plan.statusSaved || plan.jioBPStatusSaved) {
            statusBtn = `<button onclick="downloadPDF('${plan._id}')" class="bg-pink-600 hover:bg-pink-700 text-white px-2 py-1 rounded"><i class="fa-solid fa-circle-down"></i> Status</button>`;
          } else if (plan.phase && plan.phase.includes("HPCL/")) {
            statusBtn = `<button onclick="openStatusModal('${plan._id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded"><i class="fa-solid fa-plus"></i> HPCL</button>`;
          } else if (
            (plan.phase && plan.phase.includes("RBML")) ||
            plan.jioBPStatusSaved
          ) {
            statusBtn = `<button onclick="openJioBPModal('${plan._id}')" class="bg-green-600 hover:bg-green-500 text-yellow-400 px-2 py-1 rounded"><i class="fa-solid fa-plus"></i> JioBP</button>`;
          } else {
            statusBtn = `<span class="text-gray-400">Not required</span>`;
          }

          //check ATG Status
          async function checkATGStatus(planId) {
            try {
              const res = await fetch(`${baseUrl}/checkATGStatus/${planId}`, {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
              });
              const data = await res.json();
              return data.exists;
            } catch {
              return false;
            }
          }

          // ATG status check & button logic
          let atgStatusBtn = "";

          if (
            loggedInUser.role === "admin" &&
            (plan.issueType === "ATG Visit" ||
              plan.issueType === "ATG & PM Visit")
          ) {
            atgStatusBtn = `<span class="text-gray-400 italic">Loading...</span>`; // placeholder

            checkATGStatus(plan._id).then((exists) => {
              const btnHtml = `
             <button onclick="handleATGButtonClick('${plan._id}', ${
                exists ? "true" : "false"
              })"

        class="text-white px-2 py-1 rounded text-[10px] ${
          exists
            ? "bg-green-500 cursor-not-allowed"
            : "bg-orange-500 hover:bg-orange-600"
        }"
        ${exists ? "disabled" : ""}>
        ${exists ? "‚úÖ Added" : "‚ûï Add ATG Status"}
      </button>`;

              const cell = row.querySelector(".atg-status-cell");
              if (cell) cell.innerHTML = btnHtml;
            });
          }

          row.innerHTML = `
                        <td class="border px-1 py-1">${plan.region}</td>
                        <td class="border px-1 py-1">${plan.engineer}</td>
                        <td class="border px-1 py-1">${plan.phase}</td>
                        <td class="border px-1 py-1">${plan.roCode}</td>
                        <td class="border px-1 py-1">${plan.roName}</td>
                        <td class="border px-1 py-1">${plan.purpose}</td>
                        <td class="border px-1 py-1">${plan.date}</td>
                        <td class="border px-1 py-1">${plan.issueType}</td>
                        <td class="border px-1 py-1">${plan.amcQtr}</td>
                        <td class="border px-1 py-1">
          ${
            loggedInUser.role === "admin"
              ? `<span class="text-blue-500  cursor-pointer" onclick="openCompletionModal('${
                  plan._id
                }', \`${plan.completionStatus || ""}\`)">
           ${plan.completionStatus ? plan.completionStatus : "‚ûï Click to Add"}
         </span>`
              : plan.completionStatus || "-"
          }
       </td>

                        <td class="border px-1 py-1 text-center">${statusBtn}</td>
                        <td class="border px-1 py-1 text-center atg-status-cell">${atgStatusBtn}</td>

                         <td class="border px-2 py-1 text-center space-x-1">
        ${
          loggedInUser?.role === "admin"
            ? `
            <button onclick='openEditModal(${JSON.stringify(plan)})'
                    class="text-sm bg-blue-500 text-white px-1 py-1 rounded"
                    title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick='confirmDelete("${plan._id}")'
                    class="text-sm bg-red-500 text-white px-1 py-1 rounded"
                    title="Delete">
              <i class="fas fa-trash-alt"></i>
            </button>`
            : ""
        }
      </td>


                      `;
          tbody.appendChild(row);
        });
      }

      //Editied option

      function openEditModal(plan) {
        document.getElementById("editPlanId").value = plan._id;
        document.getElementById("editRegion").value = plan.region || "";
        document.getElementById("editEngineer").value = plan.engineer || "";
        document.getElementById("editPhase").value = plan.phase || "";
        document.getElementById("editRoCode").value = plan.roCode || "";
        document.getElementById("editRoName").value = plan.roName || "";
        document.getElementById("editPurpose").value = plan.purpose || "";
        document.getElementById("editDate").value = plan.date || "";
        document.getElementById("editIssueType").value = plan.issueType || "";
        document.getElementById("editAmcQtr").value = plan.amcQtr || "";
        document.getElementById("editModal").classList.remove("hidden");
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
      }

      async function saveEdit() {
        const token = localStorage.getItem("token");
        const id = document.getElementById("editPlanId").value;
        const updated = {
          region: document.getElementById("editRegion").value,
          engineer: document.getElementById("editEngineer").value,
          phase: document.getElementById("editPhase").value,
          roCode: document.getElementById("editRoCode").value,
          roName: document.getElementById("editRoName").value,
          purpose: document.getElementById("editPurpose").value,
          date: document.getElementById("editDate").value,
          issueType: document.getElementById("editIssueType").value,
          amcQtr: document.getElementById("editAmcQtr").value,
        };

        const res = await fetch(`${baseUrl}/updateDailyPlan/` + id, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(updated),
          credentials: "include",
        });

        if (res.ok) {
          alert("‚úÖ Record updated!");
          closeEditModal();
          fetchData();
        } else {
          alert("‚ùå Update failed");
        }
      }

      function clearFilter() {
        document.getElementById("searchInput").value = "";
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";
        document.getElementById("engineerFilter").value = "";
        document.getElementById("applyBtn").disabled = true;
        document.getElementById("tableBody").innerHTML = "";
        filteredData = [];
      }

      // delete option
      async function confirmDelete(planId) {
        if (!confirm("Are you sure you want to delete this record?")) return;

        try {
          const res = await fetch(`${baseUrl}/deleteDailyPlan/${planId}`, {
            method: "DELETE",
            credentials: "include",
          });

          if (res.ok) {
            showToast("üóëÔ∏è Record deleted successfully", "bg-red-600");
            await fetchAndStoreData();
            applyFilter(document.getElementById("applyBtn"));
          } else {
            showToast("‚ùå Failed to delete the record", "error");
          }
        } catch (err) {
          showToast("‚ùå Error occurred during delete", "error");
        }
      }

      function exportStyledExcel() {
        const wb = XLSX.utils.book_new();
        const date = new Date().toISOString().slice(0, 10);

        const titleRow = [
          ["Coordinator Name: Nikhil Trivedi", "", "", "", "", "Date: " + date],
        ];

        const headerRow = [
          [
            "Region",
            "Engineer Name",
            "Customer/Phase",
            "RO Code",
            "RO Name",
            "Plan/Remarks/Comp.ID",
            "Issue Type",
            "AMC_QTR_DETAIL",
            "Date of Visit",
            "Completion Status",
          ],
        ];

        const tableRows = filteredData.map((d) => [
          (d.region || "").trim(),
          (d.engineer || "").trim(),
          (d.phase || "").trim(),
          (d.roCode || "").trim(),
          (d.roName || "").trim(),
          (d.purpose || "").trim(),
          (d.issueType || "").trim(),
          (d.amcQtr || "").trim(),
          (d.date || "").trim(),
          (d.completionStatus || "").trim(),
        ]);

        const allRows = [...titleRow, ...headerRow, ...tableRows];
        const ws = XLSX.utils.aoa_to_sheet(allRows);

        ws["!merges"] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }];

        // Format title row
        for (let c = 0; c <= 9; c++) {
          const cell = ws[XLSX.utils.encode_cell({ r: 0, c })];
          if (cell) {
            cell.s = {
              font: { name: "Calibri", sz: 11, bold: true },
              fill: { fgColor: { rgb: "00FF00" } },
              alignment: { vertical: "center", horizontal: "left" },
            };
          }
        }

        // Format header row
        for (let c = 0; c <= 9; c++) {
          const cell = ws[XLSX.utils.encode_cell({ r: 1, c })];
          if (cell) {
            cell.s = {
              font: { name: "Calibri", sz: 11, bold: true },
              fill: { fgColor: { rgb: "FFFF00" } },
              border: {
                top: { style: "thin", color: { rgb: "000000" } },
                bottom: { style: "thin", color: { rgb: "000000" } },
                left: { style: "thin", color: { rgb: "000000" } },
                right: { style: "thin", color: { rgb: "000000" } },
              },
              alignment: { vertical: "center", horizontal: "center" },
            };
          }
        }

        // Format data rows
        for (let r = 2; r < allRows.length; r++) {
          for (let c = 0; c <= 9; c++) {
            const cell = ws[XLSX.utils.encode_cell({ r, c })];
            if (cell) {
              cell.s = {
                font: { name: "Calibri", sz: 9 },
                alignment: {
                  vertical: "center",
                  horizontal: "left",
                  wrapText: true,
                },
              };
            }
          }
        }

        ws["!cols"] = Array(10).fill({ wch: 25 });

        const userName =
          loggedInUser.engineerName || loggedInUser.username || "User";
        const safeName = userName.replace(/\s+/g, "_");

        XLSX.utils.book_append_sheet(wb, ws, "Visit Records");
        XLSX.writeFile(wb, `${safeName}_VisitRecords_${date}.xlsx`);
      }

      function logout() {
        fetch(`${baseUrl}/logout`, {
          method: "POST",
          credentials: "include",
        }).finally(() => {
          window.location.href = "login.html";
        });
      }

      function checkFilterValidity() {
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;
        const applyBtn = document.getElementById("applyBtn");
        applyBtn.disabled = !(fromDate && toDate);
      }

      //Status model

      function openStatusModal(planId) {
        document.getElementById("statusPlanId").value = planId;
        document.getElementById("statusModal").classList.remove("hidden");

        document
          .getElementById("connectivityType")
          .addEventListener("change", function () {
            const selected = this.value;

            const sim1Provider = document.getElementById("sim1Provider");
            const sim1Number = document.getElementById("sim1Number");
            const sim2Provider = document.getElementById("sim2Provider");
            const sim2Number = document.getElementById("sim2Number");
            const iemiNumber = document.getElementById("iemiNumber");

            if (selected !== "RELCON SIM") {
              sim1Provider.value = "NA";
              sim1Number.value = "NA";
              sim2Provider.value = "NA";
              sim2Number.value = "NA";
              iemiNumber.value = "NA";

              sim1Provider.setAttribute("disabled", true);
              sim1Number.setAttribute("disabled", true);
              sim2Provider.setAttribute("disabled", true);
              sim2Number.setAttribute("disabled", true);
              iemiNumber.setAttribute("disabled", true);
            } else {
              sim1Provider.removeAttribute("disabled");
              sim1Number.removeAttribute("disabled");
              sim2Provider.removeAttribute("disabled");
              sim2Number.removeAttribute("disabled");
              iemiNumber.removeAttribute("disabled");

              sim1Provider.value = "";
              sim1Number.value = "";
              sim2Provider.value = "";
              sim2Number.value = "";
              iemiNumber.value = "";
            }
          });

        //Capital Letter
        document.querySelectorAll("textarea").forEach((el) => {
          el.addEventListener("input", function () {
            this.value = this.value.toUpperCase();
          });
        });
        // Clear fields if adding
        if (typeof isViewOnly === "undefined" || !isViewOnly) {
          document.getElementById("statusForm").reset();
        }

        // üõ∞Ô∏è Fetch and set current location
        const locationField = document.getElementById("locationField");
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude.toFixed(6);
              const lng = position.coords.longitude.toFixed(6);
              locationField.value = `${lat}, ${lng}`;
            },
            (err) => {
              console.warn("Location access denied or error:", err.message);
              locationField.value = "Unable to fetch location";
            }
          );
        } else {
          locationField.value = "Geolocation not supported";
        }
      }

      function closeStatusModal() {
        document.getElementById("statusModal").classList.add("hidden");
      }

      async function saveStatus() {
        const requiredFields = [
          "probeMake",
          "probeSize",
          "lowProductLock",
          "highWaterSet",
          "duSerialNumber",
          "dgStatus",
          "connectivityType",
          "sim1Provider",
          "sim1Number",
          "sim2Provider",
          "sim2Number",
          "iemiNumber",
          "bosVersion",
          "fccVersion",
          "wirelessSlave",
          "sftpConfig",
          "adminPassword",
          "workCompletion",
          "earthingStatus",
          "voltageReading",
          "duOffline",
          "duRemark",
          "locationField",
        ];
        // ‚õî Check if location is valid before save
        const location = document.getElementById("locationField").value;
        if (
          !location ||
          location === "Fetching location..." ||
          location === "Unable to fetch location" ||
          location === "Geolocation not supported"
        ) {
          alert(
            "‚ùå Location not available. Please allow location access before saving."
          );
          return;
        }

        // Validate all required fields
        for (const id of requiredFields) {
          const el = document.getElementById(id);
          if (!el || !el.value.trim()) {
            alert(`‚ùå Please fill in ${id.replace(/([A-Z])/g, " $1")} field`);
            el.focus();
            return;
          }
        }
        const statusData = {
          planId: document.getElementById("statusPlanId").value,
          probeMake: document.getElementById("probeMake").value,
          probeSize: document.getElementById("probeSize").value,
          lowProductLock: document.getElementById("lowProductLock").value,
          highWaterSet: document.getElementById("highWaterSet").value,
          duSerialNumber: document.getElementById("duSerialNumber").value,
          dgStatus: document.getElementById("dgStatus").value,
          connectivityType: document.getElementById("connectivityType").value,
          sim1Provider: document.getElementById("sim1Provider").value,
          sim1Number: document.getElementById("sim1Number").value,
          sim2Provider: document.getElementById("sim2Provider").value,
          sim2Number: document.getElementById("sim2Number").value,
          iemiNumber: document.getElementById("iemiNumber").value,
          bosVersion: document.getElementById("bosVersion").value,
          fccVersion: document.getElementById("fccVersion").value,
          wirelessSlave: document.getElementById("wirelessSlave").value,
          sftpConfig: document.getElementById("sftpConfig").value,
          adminPassword: document.getElementById("adminPassword").value,
          workCompletion: document.getElementById("workCompletion").value,
          earthingStatus: document.getElementById("earthingStatus").value,
          voltageReading: document.getElementById("voltageReading").value,
          duOffline: document.getElementById("duOffline").value,
          duRemark: document.getElementById("duRemark").value,
          locationField: document.getElementById("locationField").value,
        };

        //if (!workDone) return alert("Please enter work done");

        const res = await fetch(`${baseUrl}/saveStatus`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(statusData),
          credentials: "include", // ‚úÖ add this
        });

        if (res.ok) {
          alert("‚úÖ Status saved");
          closeStatusModal();
          await fetchAndStoreData(); // Reload to reflect status
          applyFilter(document.getElementById("applyBtn"));
        } else {
          alert("‚ùå Error saving status");
        }
      }

      //acs and decending logic added

      let currentSort = {
        key: null,
        direction: null, // 'asc' or 'desc'
      };
      function sortTable(headerEl) {
        const key = headerEl.getAttribute("data-key");
        if (!key) return;

        // Toggle direction
        if (currentSort.key === key) {
          currentSort.direction =
            currentSort.direction === "asc"
              ? "desc"
              : currentSort.direction === "desc"
              ? null
              : "asc";
        } else {
          currentSort.key = key;
          currentSort.direction = "asc";
        }

        let data = [...filteredData];

        if (currentSort.direction) {
          data.sort((a, b) => {
            const aVal = (a[key] || "").toString().toLowerCase();
            const bVal = (b[key] || "").toString().toLowerCase();

            if (aVal < bVal) return currentSort.direction === "asc" ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === "asc" ? 1 : -1;
            return 0;
          });
        }

        populateTable(data);
      }

      window.onload = async () => {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("fromDate").value = today;
        document.getElementById("toDate").value = today;

        await fetchUserSession();
        await fetchAndStoreData();

        checkFilterValidity();

        // üîÑ Auto-run the filter on page load
        document.getElementById("applyBtn").click();
      };

      //pdf generation code

      // üîß Helper function to clean special characters
      function cleanText(text) {
        if (text === null || text === undefined) return "";
        return String(text).replace(/[\u0000-\u001F\u007F-\u009F]/g, "");
      }

      async function downloadPDF(planId) {
        try {
          const resPlan = await fetch(`${baseUrl}/getPlanById/${planId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          if (!resPlan.ok) {
            alert("‚ùå Failed to fetch visit data");
            return;
          }

          const plan = await resPlan.json();
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          const pageWidth = doc.internal.pageSize.getWidth();

          // Load logo as base64 helper
          const loadLogo = async (url) => {
            const res = await fetch(url);
            const blob = await res.blob();
            return await new Promise((resolve) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.readAsDataURL(blob);
            });
          };

          // JioBP PDF
          if (!!plan.jioBPStatusSaved) {
            const resStatus = await fetch(
              `${baseUrl}/getJioBPStatusByPlan/${planId}`,
              {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
              }
            );

            if (!resStatus.ok) {
              alert("‚ùå Failed to fetch Jio BP status data");
              return;
            }

            const status = await resStatus.json();
            const logo = await loadLogo("./assets/JioBP.png"); // or /images/JioBP.png
            doc.addImage(logo, "PNG", pageWidth / 2 - 15, 10, 30, 20);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("Jio BP Visit Report", pageWidth / 2, 35, {
              align: "center",
            });

            const visitData = [
              ["Engineer", cleanText(plan.engineer)],
              ["Region", cleanText(plan.region)],
              ["Phase", cleanText(plan.phase)],
              ["RO Code", cleanText(plan.roCode)],
              ["RO Name", cleanText(plan.roName)],
              ["Date", cleanText(plan.date)],
              ["AMC Qtr", cleanText(plan.amcQtr)],
              ["Purpose", cleanText(plan.purpose)],
              ["HPSD ID", cleanText(status?.hpsdId)],
              ["Diagnosis", cleanText(status?.diagnosis)],
              ["Solution", cleanText(status?.solution)],
              ["Active Material Used", cleanText(status?.activeMaterialUsed)],
              [
                "Used Material Name & Code",
                cleanText(status?.usedMaterialDetails),
              ],
              [
                "Faulty Material Name & Code",
                cleanText(status?.faultyMaterialDetails),
              ],
              ["Spare Requirement", cleanText(status?.spareRequired)],
              ["Observation (in Hours)", cleanText(status?.observationHours)],
              [
                "Material Requirement Name",
                cleanText(status?.materialRequirement),
              ],
              ["Status", cleanText(status?.status)],
            ];

            doc.autoTable({
              startY: 45,
              head: [["Field", "Value"]],
              body: visitData,
              theme: "grid",
              styles: { fontSize: 9, cellPadding: 3 },
              headStyles: { fillColor: [22, 163, 74], textColor: 255 },
              alternateRowStyles: { fillColor: [245, 245, 245] },
            });

            const userName =
              localStorage.getItem("engineerName") || "Unknown User";
            const now = new Date();
            const formattedDate = now
              .toLocaleDateString("en-GB")
              .replace(/ /g, "-");
            const formattedTime = now.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
              hour12: true,
            });

            const footerText = `Generated by: ${userName} on ${formattedDate} at ${formattedTime}`;
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.setTextColor(150);
              doc.text(`Page ${i} of ${pageCount}`, 195, 290, {
                align: "right",
              });
              doc.text(footerText, 15, 290);
            }

            doc.save(`JioBP_Report_${plan.roCode}_${plan.date}.pdf`);
          }

          // HPCL fallback
          else {
            const resStatus = await fetch(
              `${baseUrl}/getStatusByPlan/${planId}`,
              {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
              }
            );

            if (!resStatus.ok) {
              alert("‚ùå Failed to fetch HPCL status data");
              return;
            }

            const status = await resStatus.json();
            const logo = await loadLogo("./assets/HPCL.png"); // or /images/relconLogo.png
            doc.addImage(logo, "PNG", pageWidth / 2 - 15, 10, 30, 20);

            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("RELCON SYSTEMS", 105, 35, { align: "center" });
            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            doc.text("Visit Report", 105, 42, { align: "center" });

            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.line(15, 45, 195, 45);

            const visitData = [
              ["Engineer", cleanText(plan.engineer)],
              ["Region", cleanText(plan.region)],
              ["Phase", cleanText(plan.phase)],
              ["RO Code", cleanText(plan.roCode)],
              ["RO Name", cleanText(plan.roName)],
              ["Date", cleanText(plan.date)],
              ["AMC Qtr", cleanText(plan.amcQtr)],
              ["Purpose", cleanText(plan.purpose)],
              ["Probe Make", cleanText(status?.probeMake)],
              ["Product & Probe Size", cleanText(status?.probeSize)],
              ["Low Product Lock", cleanText(status?.lowProductLock)],
              ["High water Lock", cleanText(status?.highWaterSet)],
              ["DU Serial Number Updated", cleanText(status?.duSerialNumber)],
              ["Outlet DG Status", cleanText(status?.dgStatus)],
              ["Connectivity Type", cleanText(status?.connectivityType)],
              ["Sim 1 Provider Name", cleanText(status?.sim1Provider)],
              ["Sim 1 Number", cleanText(status?.sim1Number)],
              ["Sim 2 Provider Name", cleanText(status?.sim2Provider)],
              ["Sim 2 Number", cleanText(status?.sim2Number)],
              ["IEMI Number", cleanText(status?.iemiNumber)],
              ["BOS Version", cleanText(status?.bosVersion)],
              ["FCC Version", cleanText(status?.fccVersion)],
              ["Wireless Slave Version", cleanText(status?.wirelessSlave)],
              ["SFTP Config", cleanText(status?.sftpConfig)],
              ["Admin Password Updated", cleanText(status?.adminPassword)],
              ["Work Completion Status", cleanText(status?.workCompletion)],
              ["Earthing Status", cleanText(status?.earthingStatus)],
              ["Voltage Reading", cleanText(status?.voltageReading)],
              ["No of DU offline", cleanText(status?.duOffline)],
              ["DU offline remark", cleanText(status?.duRemark)],
              ["Site Location", cleanText(status?.locationField)],
            ];

            doc.autoTable({
              startY: 50,
              head: [["Field", "Value"]],
              body: visitData,
              theme: "grid",
              headStyles: {
                fillColor: [22, 163, 74],
                textColor: 255,
                fontSize: 10,
              },
              bodyStyles: { fontSize: 9, cellPadding: 3 },
              alternateRowStyles: { fillColor: [245, 245, 245] },
              styles: {
                cellWidth: "wrap",
                valign: "middle",
                overflow: "linebreak",
              },
              columnStyles: {
                0: { fontStyle: "bold", halign: "left" },
                1: { halign: "left" },
              },
            });

            const userName =
              localStorage.getItem("engineerName") || "Unknown User";
            const now = new Date();
            const formattedDate = now
              .toLocaleDateString("en-GB", {
                day: "2-digit",
                month: "short",
                year: "numeric",
              })
              .replace(/ /g, "-");
            const formattedTime = now.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
              hour12: true,
            });

            const footerText = `Generated by: ${userName} on ${formattedDate} at ${formattedTime}`;
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.setTextColor(150);
              doc.text(`Page ${i} of ${pageCount}`, 195, 290, {
                align: "right",
              });
              doc.text(footerText, 15, 290);
            }

            doc.save(`Status_Report_${plan.roCode}_${plan.date}.pdf`);
          }
        } catch (err) {
          console.error("‚ùå PDF Generation Error:", err);
          alert("‚ùå Error generating PDF");
        }
      }

      //Completion model Feature for admin only

      function openCompletionModal(planId, currentText) {
        document.getElementById("completionPlanId").value = planId;
        document.getElementById("completionInput").value = currentText || "";
        document.getElementById("completionModal").classList.remove("hidden");
      }

      function closeCompletionModal() {
        document.getElementById("completionModal").classList.add("hidden");
      }

      async function saveCompletionStatus() {
        const id = document.getElementById("completionPlanId").value;
        const text = document.getElementById("completionInput").value;

        const res = await fetch(`${baseUrl}/updateCompletion/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ completionStatus: text }),
        });

        if (res.ok) {
          alert("‚úÖ Completion status saved");
          closeCompletionModal();
          await fetchAndStoreData();
          applyFilter(document.getElementById("applyBtn")); // refresh
        } else {
          alert("‚ùå Error saving completion status");
        }
      }

      // Toaster

      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.innerText = message;

        toast.className =
          "fixed top-4 right-4 z-50 rounded-lg px-4 py-2 text-white shadow-lg text-sm " +
          (type === "error" ? "bg-red-500" : "bg-green-600");

        toast.classList.remove("hidden");

        // Automatically hide toast after 3 seconds
        setTimeout(() => {
          toast.classList.add("hidden");
        }, 3000);
      }

      // ATG STATUS MODAL HANDLER
      let allowATGModalOpen = false;

      function openATGModal(planId) {
        if (!allowATGModalOpen) return;
        allowATGModalOpen = false;

        document.getElementById("atgPlanId").value = planId;
        document.getElementById("atgForm").reset();

        const fields = [
          "zone",
          "atgIssuetype",
          "startTime",
          "bfrStatus",
          "actionSite",
          "supportPerson",
          "earthingStatus1",
          "resolvedStatus",
          "endTime",
          "nextAction",
          "remark",
        ];
        fields.forEach((id) => (document.getElementById(id).value = ""));

        document.getElementById("atgModal").classList.remove("hidden");
      }

      function closeATGModal() {
        document.getElementById("atgModal").classList.add("hidden");
      }

      async function submitATGStatus() {
        const planId = document.getElementById("atgPlanId").value;
        const payload = {
          planId,
          zone: document.getElementById("zone").value,
          atgIssuetype: document.getElementById("atgIssuetype").value,
          startTime: document.getElementById("startTime").value,
          bfrStatus: document.getElementById("bfrStatus").value,
          actionSite: document.getElementById("actionSite").value,
          supportPerson: document.getElementById("supportPerson").value,
          earthingStatus1: document.getElementById("earthingStatus1").value,
          resolvedStatus: document.getElementById("resolvedStatus").value,
          endTime: document.getElementById("endTime").value,
          nextAction: document.getElementById("nextAction").value,
          remark: document.getElementById("remark").value,
        };

        try {
          const res = await fetch(`${baseUrl}/saveATGStatus`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            alert("‚úÖ ATG status saved successfully");
            closeATGModal();

            await fetchAndStoreData?.(); // optional chaining if defined
            applyFilter?.(document.getElementById("applyBtn"));
          } else {
            const errorText = await res.text();
            alert("‚ùå Failed to save ATG status: " + errorText);
          }
        } catch (err) {
          console.error("ATG save error:", err);
          alert("‚ùå Network error saving ATG status");
        }
      }

      function handleATGButtonClick(planId, exists) {
        if (exists) return;
        allowATGModalOpen = true;
        openATGModal(planId);
      }

      //JIO BP JS

      function openJioBPModal(planId) {
        document.getElementById("jioBPPlanId").value = planId;
        document.getElementById("jioBPModal").classList.remove("hidden");
        document.getElementById("jioBPForm").reset();
      }

      function closeJioBPModal() {
        document.getElementById("jioBPModal").classList.add("hidden");
      }

      async function saveJioBPStatus() {
        const requiredFields = [
          "hpsdId",
          "diagnosis",
          "solution",
          "activeMaterialUsed",
          "spareRequired",
          "jioStatus",
        ];
        for (const id of requiredFields) {
          const el = document.getElementById(id);
          if (!el.value.trim()) {
            alert(`Please fill in ${id}`);
            el.focus();
            return;
          }
        }

        const data = {
          planId: document.getElementById("jioBPPlanId").value,
          hpsdId: document.getElementById("hpsdId").value.trim(),
          diagnosis: document.getElementById("diagnosis").value.trim(),
          solution: document.getElementById("solution").value.trim(),
          activeMaterialUsed:
            document.getElementById("activeMaterialUsed").value,
          usedMaterialDetails: document
            .getElementById("usedMaterialDetails")
            .value.trim(),
          faultyMaterialDetails: document
            .getElementById("faultyMaterialDetails")
            .value.trim(),
          spareRequired: document.getElementById("spareRequired").value,
          observationHours: document
            .getElementById("observationHours")
            .value.trim(),
          materialRequirement: document
            .getElementById("materialRequirement")
            .value.trim(),
          status: document.getElementById("jioStatus").value,
        };

        const token = localStorage.getItem("token");
        try {
          const res = await fetch(`${baseUrl}/saveJioBPStatus`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            credentials: "include",
            body: JSON.stringify(data),
          });

          if (res.ok) {
            alert("‚úÖ Jio BP Status saved successfully");
            closeJioBPModal();

            await fetchAndStoreData(); // ‚úÖ fixes PDF button state issue
            applyFilter(document.getElementById("applyBtn"));
          } else {
            alert("‚ùå Error saving Jio BP Status");
          }
        } catch (err) {
          console.error("Save Error:", err);
          alert("‚ùå Network or server error");
        }
      }
    </script>
  </body>
</html>
