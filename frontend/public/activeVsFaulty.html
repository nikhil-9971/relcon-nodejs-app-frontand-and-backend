<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Active vs Faulty - Report</title>

    <!-- Poppins -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --muted: #6b7280;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: #f5f7fa;
        margin: 0;
        padding: 20px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 8px 18px rgba(2, 6, 23, 0.06);
        border: 1px solid rgba(2, 6, 23, 0.04);
      }
      .small {
        font-size: 13px;
        color: var(--muted);
      }
      table th,
      table td {
        white-space: nowrap;
      }
    </style>
  </head>

  <body>
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">üîÅ Active vs Faulty ‚Äî Report</h1>
        <div class="flex gap-2 items-center">
          <button
            id="exportAll"
            class="bg-green-600 text-white px-3 py-2 rounded"
          >
            üì§ Export Both
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex gap-4 mb-4 flex-wrap">
        <div>
          <label class="small block mb-1">From</label>
          <input id="fromDate" type="date" class="border rounded px-3 py-2" />
        </div>
        <div>
          <label class="small block mb-1">To</label>
          <input id="toDate" type="date" class="border rounded px-3 py-2" />
        </div>
        <div>
          <label class="small block mb-1">Engineer</label>
          <select id="engineerFilter" class="border rounded px-3 py-2">
            <option value="ALL">All Engineers</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="small block mb-1">Search</label>
          <input
            id="globalSearch"
            placeholder="Search RO, engineer, codes..."
            class="w-full border rounded px-3 py-2"
          />
        </div>
        <div class="self-end">
          <button
            id="clearFilters"
            class="bg-yellow-500 text-white px-4 py-2 rounded"
          >
            ‚ôªÔ∏è Clear
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- HPCL -->
        <section class="card">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="font-semibold">HPCL ‚Äî Spare (Active vs Faulty)</h2>
              <div class="small">
                Fields: spareUsed, activeSpare, faultySpare
              </div>
            </div>
            <div class="text-right">
              <div id="hpclCount" class="text-sm font-medium"></div>
              <div class="small text-gray-500">Showing filtered</div>
            </div>
          </div>

          <div class="overflow-x-auto border rounded">
            <table id="hpclTable" class="min-w-full table-auto text-[13px]">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left">Engineer</th>
                  <th class="px-3 py-2 text-left">RO Code</th>
                  <th class="px-3 py-2 text-left">RO Name</th>
                  <th class="px-3 py-2 text-left">Spare Used</th>
                  <th class="px-3 py-2 text-left">Active Spare</th>
                  <th class="px-3 py-2 text-left">Faulty Spare</th>
                  <th class="px-3 py-2 text-left">Verified</th>
                  <th class="px-3 py-2 text-left">Date</th>
                </tr>
              </thead>
              <tbody id="hpclBody"></tbody>
            </table>
          </div>

          <div class="mt-3 flex justify-end gap-2">
            <button
              id="exportHPCL"
              class="bg-blue-600 text-white px-3 py-2 rounded"
            >
              Export HPCL
            </button>
          </div>
        </section>

        <!-- JIO -->
        <section class="card">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="font-semibold">
                Jio BP ‚Äî Material (Active vs Faulty)
              </h2>
              <div class="small">
                Fields: activeMaterialUsed, usedMaterialDetails,
                faultyMaterialDetails
              </div>
            </div>
            <div class="text-right">
              <div id="jioCount" class="text-sm font-medium"></div>
              <div class="small text-gray-500">Showing filtered</div>
            </div>
          </div>

          <div class="overflow-x-auto border rounded">
            <table id="jioTable" class="min-w-full table-auto text-[13px]">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left">Engineer</th>
                  <th class="px-3 py-2 text-left">RO Code</th>
                  <th class="px-3 py-2 text-left">RO Name</th>
                  <th class="px-3 py-2 text-left">Active Material Used</th>
                  <th class="px-3 py-2 text-left">Used Material Details</th>
                  <th class="px-3 py-2 text-left">Faulty Material Details</th>
                  <th class="px-3 py-2 text-left">Verified</th>
                  <th class="px-3 py-2 text-left">Date</th>
                </tr>
              </thead>
              <tbody id="jioBody"></tbody>
            </table>
          </div>

          <div class="mt-3 flex justify-end gap-2">
            <button
              id="exportJio"
              class="bg-blue-600 text-white px-3 py-2 rounded"
            >
              Export JIO
            </button>
          </div>
        </section>
      </div>
    </div>

    <script>
      // Active vs Faulty UI
      const baseUrl = "https://relcon-backend-jwt-backup.onrender.com";
      const token = localStorage.getItem("token");
      let hpclData = []; // merged status records (HPCL)
      let jioData = [];
      let filteredHPCL = [];
      let filteredJIO = [];

      // Helpers
      function show(el) {
        if (el) el.classList.remove("hidden");
      }
      function hide(el) {
        if (el) el.classList.add("hidden");
      }
      function text(id, v) {
        const e = document.getElementById(id);
        if (e) e.textContent = v;
      }

      // Fetch HPCL merged (uses same endpoint used in statusRecords)
      async function fetchHPCL() {
        try {
          const res = await fetch(`${baseUrl}/getMergedStatusRecords`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          // HPCL fields: spareUsed, activeSpare, faultySpare - these come from status model (spareUsed etc.)
          hpclData = (data || []).map((d) => ({
            engineer: d.engineer,
            roCode: d.roCode,
            roName: d.roName,
            date: d.date,
            spareUsed: d.spareUsed || d.spareUsed === "" ? d.spareUsed : "",
            activeSpare: d.activeSpare || "",
            faultySpare: d.faultySpare || "",
            isVerified: !!d.isVerified,
            raw: d,
          }));
          // default initial filter: show spareUsed === "Yes" OR activeSpare/faultySpare present
          filteredHPCL = hpclData.filter((r) => {
            const spareYes =
              typeof r.spareUsed === "string" &&
              r.spareUsed.toLowerCase() === "yes";
            const hasActive =
              r.activeSpare && String(r.activeSpare).trim().length > 0;
            const hasFaulty =
              r.faultySpare && String(r.faultySpare).trim().length > 0;
            return spareYes || hasActive || hasFaulty;
          });
          populateEngineerSelect();
          applyFiltersAndRender();
        } catch (err) {
          console.error("HPCL fetch error:", err);
        }
      }

      // Fetch JIO BP statuses
      async function fetchJIO() {
        try {
          const res = await fetch(`${baseUrl}/jioBP/getAllJioBPStatus`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          // map similar fields
          jioData = (data || []).map((d) => ({
            engineer: d.engineer || (d.planId && d.planId.engineer) || "",
            roCode: d.roCode || (d.planId && d.planId.roCode) || "",
            roName: d.roName || (d.planId && d.planId.roName) || "",
            date: d.date || (d.planId && d.planId.date) || "",
            activeMaterialUsed: d.activeMaterialUsed || "",
            usedMaterialDetails: d.usedMaterialDetails || "",
            faultyMaterialDetails: d.faultyMaterialDetails || "",
            isVerified: !!d.isVerified,
            raw: d,
          }));
          // default filter: activeMaterialUsed === "Yes" OR used/faulty details present
          filteredJIO = jioData.filter((r) => {
            const yes =
              typeof r.activeMaterialUsed === "string" &&
              r.activeMaterialUsed.toLowerCase() === "yes";
            const used =
              r.usedMaterialDetails &&
              String(r.usedMaterialDetails).trim().length > 0;
            const faulty =
              r.faultyMaterialDetails &&
              String(r.faultyMaterialDetails).trim().length > 0;
            return yes || used || faulty;
          });
          populateEngineerSelect();
          applyFiltersAndRender();
        } catch (err) {
          console.error("JIO fetch error:", err);
        }
      }

      function populateEngineerSelect() {
        const sel = document.getElementById("engineerFilter");
        if (!sel) return;
        const combined = [
          ...hpclData.map((d) => d.engineer),
          ...jioData.map((d) => d.engineer),
        ];
        const uniq = Array.from(new Set(combined.filter(Boolean))).sort();
        // preserve selection
        const current = sel.value || "ALL";
        sel.innerHTML = '<option value="ALL">All Engineers</option>';
        uniq.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
        if (uniq.includes(current)) sel.value = current;
      }

      function renderHPCL(list) {
        const tbody = document.getElementById("hpclBody");
        tbody.innerHTML = list
          .map((r) => {
            return `<tr>
            <td class="px-3 py-2 text-left">${escapeHTML(r.engineer)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.roCode)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.roName)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.spareUsed)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.activeSpare)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.faultySpare)}</td>
            <td class="px-3 py-2 text-left">${
              r.isVerified ? "‚úÖ Verified" : "‚ùå"
            }</td>
            <td class="px-3 py-2 text-left">${escapeHTML(
              formatDate(r.date)
            )}</td>
          </tr>`;
          })
          .join("");
        text("hpclCount", `${list.length} rows`);
      }

      function renderJIO(list) {
        const tbody = document.getElementById("jioBody");
        tbody.innerHTML = list
          .map((r) => {
            return `<tr>
            <td class="px-3 py-2 text-left">${escapeHTML(r.engineer)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.roCode)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.roName)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(
              r.activeMaterialUsed
            )}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(
              r.usedMaterialDetails
            )}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(
              r.faultyMaterialDetails
            )}</td>
            <td class="px-3 py-2 text-left">${
              r.isVerified ? "‚úÖ Verified" : "‚ùå"
            }</td>
            <td class="px-3 py-2 text-left">${escapeHTML(
              formatDate(r.date)
            )}</td>
          </tr>`;
          })
          .join("");
        text("jioCount", `${list.length} rows`);
      }

      function escapeHTML(s) {
        if (s === null || s === undefined) return "";
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }

      function formatDate(d) {
        if (!d) return "";
        const dd = new Date(d);
        if (isNaN(dd)) return d;
        return dd.toISOString().slice(0, 10);
      }

      // Combined filter logic
      function applyFiltersAndRender() {
        const fromVal = document.getElementById("fromDate").value;
        const toVal = document.getElementById("toDate").value;
        const eng = document.getElementById("engineerFilter").value || "ALL";
        const q = (document.getElementById("globalSearch").value || "")
          .toLowerCase()
          .trim();

        const fromDate = fromVal ? new Date(fromVal) : null;
        const toDate = toVal ? new Date(toVal) : null;

        filteredHPCL = hpclData.filter((r) => {
          if (eng !== "ALL" && r.engineer !== eng) return false;
          if (fromDate || toDate) {
            const d = r.date ? new Date(r.date) : null;
            if (d && fromDate && d < fromDate) return false;
            if (d && toDate && d > toDate) return false;
          }
          // ensure we only show HPCL relevant fields (as requested): show rows where spareUsed=yes or active/faulty present
          const spareYes =
            typeof r.spareUsed === "string" &&
            r.spareUsed.toLowerCase() === "yes";
          const hasActive =
            r.activeSpare && String(r.activeSpare).trim().length > 0;
          const hasFaulty =
            r.faultySpare && String(r.faultySpare).trim().length > 0;
          if (!(spareYes || hasActive || hasFaulty)) return false;
          // search
          if (q) {
            const hay =
              `${r.engineer} ${r.roCode} ${r.roName} ${r.spareUsed} ${r.activeSpare} ${r.faultySpare}`.toLowerCase();
            return hay.includes(q);
          }
          return true;
        });

        filteredJIO = jioData.filter((r) => {
          if (eng !== "ALL" && r.engineer !== eng) return false;
          if (fromDate || toDate) {
            const d = r.date ? new Date(r.date) : null;
            if (d && fromDate && d < fromDate) return false;
            if (d && toDate && d > toDate) return false;
          }
          const yes =
            typeof r.activeMaterialUsed === "string" &&
            r.activeMaterialUsed.toLowerCase() === "yes";
          const used =
            r.usedMaterialDetails &&
            String(r.usedMaterialDetails).trim().length > 0;
          const faulty =
            r.faultyMaterialDetails &&
            String(r.faultyMaterialDetails).trim().length > 0;
          if (!(yes || used || faulty)) return false;
          if (q) {
            const hay =
              `${r.engineer} ${r.roCode} ${r.roName} ${r.activeMaterialUsed} ${r.usedMaterialDetails} ${r.faultyMaterialDetails}`.toLowerCase();
            return hay.includes(q);
          }
          return true;
        });

        renderHPCL(filteredHPCL);
        renderJIO(filteredJIO);
      }

      // Export helpers
      function exportSheet(name, rows) {
        if (!rows || rows.length === 0) {
          alert("No rows to export");
          return;
        }
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, name);
        XLSX.writeFile(
          wb,
          `${name}_${new Date().toLocaleDateString("en-CA")}.xlsx`
        );
      }

      document.getElementById("exportHPCL").addEventListener("click", () => {
        // Convert filteredHPCL to export rows
        const rows = filteredHPCL.map((r) => ({
          Engineer: r.engineer,
          RO_Code: r.roCode,
          RO_Name: r.roName,
          SpareUsed: r.spareUsed,
          ActiveSpare: r.activeSpare,
          FaultySpare: r.faultySpare,
          Verified: r.isVerified ? "Yes" : "No",
          Date: formatDate(r.date),
        }));
        exportSheet("HPCL_ActiveVsFaulty", rows);
      });

      document.getElementById("exportJio").addEventListener("click", () => {
        const rows = filteredJIO.map((r) => ({
          Engineer: r.engineer,
          RO_Code: r.roCode,
          RO_Name: r.roName,
          ActiveMaterialUsed: r.activeMaterialUsed,
          UsedMaterialDetails: r.usedMaterialDetails,
          FaultyMaterialDetails: r.faultyMaterialDetails,
          Verified: r.isVerified ? "Yes" : "No",
          Date: formatDate(r.date),
        }));
        exportSheet("JIO_ActiveVsFaulty", rows);
      });

      document.getElementById("exportAll").addEventListener("click", () => {
        // Download two sheets in same workbook
        const wb = XLSX.utils.book_new();

        const hpclRows = filteredHPCL.map((r) => ({
          Engineer: r.engineer,
          RO_Code: r.roCode,
          RO_Name: r.roName,
          SpareUsed: r.spareUsed,
          ActiveSpare: r.activeSpare,
          FaultySpare: r.faultySpare,
          Verified: r.isVerified ? "Yes" : "No",
          Date: formatDate(r.date),
        }));
        const jioRows = filteredJIO.map((r) => ({
          Engineer: r.engineer,
          RO_Code: r.roCode,
          RO_Name: r.roName,
          ActiveMaterialUsed: r.activeMaterialUsed,
          UsedMaterialDetails: r.usedMaterialDetails,
          FaultyMaterialDetails: r.faultyMaterialDetails,
          Verified: r.isVerified ? "Yes" : "No",
          Date: formatDate(r.date),
        }));

        XLSX.utils.book_append_sheet(
          wb,
          XLSX.utils.json_to_sheet(hpclRows),
          "HPCL_ActiveVsFaulty"
        );
        XLSX.utils.book_append_sheet(
          wb,
          XLSX.utils.json_to_sheet(jioRows),
          "JIO_ActiveVsFaulty"
        );
        XLSX.writeFile(
          wb,
          `ActiveVsFaulty_${new Date().toLocaleDateString("en-CA")}.xlsx`
        );
      });

      // Wire form controls
      document.getElementById("globalSearch").addEventListener("input", () => {
        applyFiltersAndRender();
      });
      document
        .getElementById("engineerFilter")
        .addEventListener("change", () => applyFiltersAndRender());
      document
        .getElementById("fromDate")
        .addEventListener("change", () => applyFiltersAndRender());
      document
        .getElementById("toDate")
        .addEventListener("change", () => applyFiltersAndRender());
      document.getElementById("clearFilters").addEventListener("click", () => {
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";
        document.getElementById("engineerFilter").value = "ALL";
        document.getElementById("globalSearch").value = "";
        applyFiltersAndRender();
      });

      // Init - fetch both sources and then render
      (async function init() {
        await Promise.all([fetchHPCL(), fetchJIO()]);
        // ensure initial render even if one fetch returns later
        applyFiltersAndRender();
      })();
    </script>
  </body>
</html>
