<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Active vs Faulty - Report</title>

    <!-- Poppins -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --muted: #6b7280;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: #f5f7fa;
        margin: 0;
        padding: 20px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 8px 18px rgba(2, 6, 23, 0.06);
        border: 1px solid rgba(2, 6, 23, 0.04);
      }
      .small {
        font-size: 13px;
        color: var(--muted);
      }
      table th,
      table td {
        white-space: nowrap;
      }

      /* small UI tweaks */
      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .chip {
        padding: 6px 10px;
        border-radius: 8px;
        background: #f3f4f6;
        border: 1px solid rgba(15, 23, 42, 0.04);
        cursor: pointer;
      }
      .chip.active {
        background: linear-gradient(90deg, #06b6a4, #059669);
        color: #fff;
        border-color: rgba(5, 150, 105, 0.8);
      }
      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .count-badge {
        font-size: 13px;
        color: #374151;
        font-weight: 700;
      }
      .table-wrapper {
        max-height: 62vh;
        overflow: auto;
      }
    </style>
  </head>

  <body>
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">üîÅ Active vs Faulty ‚Äî Report</h1>
        <div class="flex gap-2 items-center">
          <button
            id="exportDisplayed"
            class="bg-green-600 text-white px-3 py-2 rounded"
          >
            üì§ Export Displayed
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex gap-4 mb-4 flex-wrap">
        <div>
          <label class="small block mb-1">From</label>
          <input id="fromDate" type="date" class="border rounded px-3 py-2" />
        </div>
        <div>
          <label class="small block mb-1">To</label>
          <input id="toDate" type="date" class="border rounded px-3 py-2" />
        </div>

        <div>
          <label class="small block mb-1">Source</label>
          <div class="controls" role="tablist" aria-label="Select source">
            <div class="chip active" data-source="both" tabindex="0">Both</div>
            <div class="chip" data-source="hpcl" tabindex="0">HPCL</div>
            <div class="chip" data-source="jio" tabindex="0">Jio BP</div>
          </div>
        </div>

        <div>
          <label class="small block mb-1">Engineer</label>
          <select id="engineerFilter" class="border rounded px-3 py-2">
            <option value="ALL">All Engineers</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="small block mb-1">Search</label>
          <input
            id="globalSearch"
            placeholder="Search RO, engineer, codes..."
            class="w-full border rounded px-3 py-2"
          />
        </div>
        <div class="self-end">
          <button
            id="clearFilters"
            class="bg-yellow-500 text-white px-4 py-2 rounded"
          >
            ‚ôªÔ∏è Clear
          </button>
        </div>
      </div>

      <!-- unified table -->
      <div class="card mb-4">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="font-semibold">Active vs Faulty ‚Äî Combined View</h2>
            <div class="small">
              Shows HPCL or Jio BP entries (condition:
              SpareUsed/ActiveMaterialUsed = Yes & Verified)
            </div>
          </div>
          <div class="toolbar">
            <div class="count-badge" id="combinedCount">0 rows</div>
          </div>
        </div>

        <div class="table-wrapper overflow-x-auto border rounded">
          <table id="combinedTable" class="min-w-full table-auto text-[13px]">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left">Source</th>
                <th class="px-3 py-2 text-left">Engineer</th>
                <th class="px-3 py-2 text-left">RO Code</th>
                <th class="px-3 py-2 text-left">RO Name</th>
                <th class="px-3 py-2 text-left">Active</th>
                <th class="px-3 py-2 text-left">Used / Details</th>
                <th class="px-3 py-2 text-left">Faulty</th>
                <th class="px-3 py-2 text-left">Verified</th>
                <th class="px-3 py-2 text-left">Date</th>
              </tr>
            </thead>
            <tbody id="combinedBody"></tbody>
          </table>
        </div>

        <div class="mt-3 flex justify-end gap-2">
          <button
            id="exportCombined"
            class="bg-blue-600 text-white px-3 py-2 rounded"
          >
            Export Shown
          </button>
        </div>
      </div>
    </div>

    <script>
      // Active vs Faulty unified view
      const baseUrl = "https://relcon-backend-jwt-backup.onrender.com";
      const token = localStorage.getItem("token");
      let hpclData = []; // merged status records (HPCL)
      let jioData = [];
      let combinedDisplayed = []; // rows currently shown

      // UI refs
      const chips = Array.from(document.querySelectorAll(".chip"));

      // Helpers
      function text(id, v) {
        const e = document.getElementById(id);
        if (e) e.textContent = v;
      }
      function escapeHTML(s) {
        if (s === null || s === undefined) return "";
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }
      function formatDate(d) {
        if (!d) return "";
        const dd = new Date(d);
        if (isNaN(dd)) return d;
        return dd.toISOString().slice(0, 10);
      }

      // fetch HPCL merged (same endpoint)
      async function fetchHPCL() {
        try {
          const res = await fetch(`${baseUrl}/getMergedStatusRecords`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          hpclData = (data || []).map((d) => ({
            source: "HPCL",
            engineer: d.engineer || "",
            roCode: d.roCode || "",
            roName: d.roName || "",
            date: d.date || "",
            active: (d.spareUsed || "").toString(), // spareUsed field
            usedDetails: d.activeSpare || "",
            faulty: d.faultySpare || "",
            isVerified: !!d.isVerified,
            raw: d,
          }));
        } catch (err) {
          console.error("HPCL fetch error:", err);
        }
      }

      // fetch JIO BP statuses
      async function fetchJIO() {
        try {
          const res = await fetch(`${baseUrl}/jioBP/getAllJioBPStatus`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          jioData = (data || []).map((d) => ({
            source: "JIO",
            engineer: d.engineer || (d.planId && d.planId.engineer) || "",
            roCode: d.roCode || (d.planId && d.planId.roCode) || "",
            roName: d.roName || (d.planId && d.planId.roName) || "",
            date: d.date || (d.planId && d.planId.date) || "",
            active: (d.activeMaterialUsed || "").toString(),
            usedDetails: d.usedMaterialDetails || "",
            faulty: d.faultyMaterialDetails || "",
            isVerified: !!d.isVerified,
            raw: d,
          }));
        } catch (err) {
          console.error("JIO fetch error:", err);
        }
      }

      function populateEngineerSelect() {
        const sel = document.getElementById("engineerFilter");
        if (!sel) return;
        const combined = [
          ...hpclData.map((d) => d.engineer),
          ...jioData.map((d) => d.engineer),
        ];
        const uniq = Array.from(new Set(combined.filter(Boolean))).sort();
        const current = sel.value || "ALL";
        sel.innerHTML = '<option value="ALL">All Engineers</option>';
        uniq.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
        if (uniq.includes(current)) sel.value = current;
      }

      // Build combined rows according to selected source and filter conditions:
      // Condition: Verified must be true AND (for HPCL spareUsed === "yes") OR (for JIO activeMaterialUsed === "yes")
      function buildCombinedRows(sourceFilter, fromDate, toDate, eng, q) {
        const rows = [];

        // normalize date range
        const f = fromDate ? new Date(fromDate) : null;
        const t = toDate ? new Date(toDate) : null;

        if (sourceFilter === "both" || sourceFilter === "hpcl") {
          hpclData.forEach((r) => {
            // Verified + spareUsed === "yes"
            if (!r.isVerified) return;
            const activeYes =
              (r.active || "").toString().toLowerCase() === "yes";
            if (!activeYes) return;
            if (eng && eng !== "ALL" && r.engineer !== eng) return;
            if (f || t) {
              const d = r.date ? new Date(r.date) : null;
              if (d && f && d < f) return;
              if (d && t && d > t) return;
            }
            if (q) {
              const hay =
                `${r.source} ${r.engineer} ${r.roCode} ${r.roName} ${r.active} ${r.usedDetails} ${r.faulty}`.toLowerCase();
              if (!hay.includes(q)) return;
            }
            rows.push({
              source: r.source,
              engineer: r.engineer,
              roCode: r.roCode,
              roName: r.roName,
              active: r.active,
              usedDetails: r.usedDetails,
              faulty: r.faulty,
              isVerified: r.isVerified,
              date: r.date,
            });
          });
        }

        if (sourceFilter === "both" || sourceFilter === "jio") {
          jioData.forEach((r) => {
            if (!r.isVerified) return;
            const activeYes =
              (r.active || "").toString().toLowerCase() === "yes";
            if (!activeYes) return;
            if (eng && eng !== "ALL" && r.engineer !== eng) return;
            if (f || t) {
              const d = r.date ? new Date(r.date) : null;
              if (d && f && d < f) return;
              if (d && t && d > t) return;
            }
            if (q) {
              const hay =
                `${r.source} ${r.engineer} ${r.roCode} ${r.roName} ${r.active} ${r.usedDetails} ${r.faulty}`.toLowerCase();
              if (!hay.includes(q)) return;
            }
            rows.push({
              source: r.source,
              engineer: r.engineer,
              roCode: r.roCode,
              roName: r.roName,
              active: r.active,
              usedDetails: r.usedDetails,
              faulty: r.faulty,
              isVerified: r.isVerified,
              date: r.date,
            });
          });
        }

        return rows;
      }

      function renderCombined(rows) {
        const tbody = document.getElementById("combinedBody");
        tbody.innerHTML = rows
          .map(
            (r) => `<tr>
            <td class="px-3 py-2 text-left">${escapeHTML(r.source)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.engineer)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.roCode)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.roName)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.active)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.usedDetails)}</td>
            <td class="px-3 py-2 text-left">${escapeHTML(r.faulty)}</td>
            <td class="px-3 py-2 text-left">${
              r.isVerified ? "‚úÖ Verified" : "‚ùå"
            }</td>
            <td class="px-3 py-2 text-left">${escapeHTML(
              formatDate(r.date)
            )}</td>
          </tr>`
          )
          .join("");
        text("combinedCount", `${rows.length} rows`);
        combinedDisplayed = rows;
      }

      // read UI and re-render
      function applyFiltersAndRender() {
        const activeChip = document.querySelector(".chip.active");
        const source = activeChip ? activeChip.dataset.source : "both";
        const from = document.getElementById("fromDate").value || null;
        const to = document.getElementById("toDate").value || null;
        const eng = document.getElementById("engineerFilter").value || "ALL";
        const q = (document.getElementById("globalSearch").value || "")
          .toLowerCase()
          .trim();

        const rows = buildCombinedRows(source, from, to, eng, q);
        renderCombined(rows);
      }

      // quick export of currently displayed rows
      function exportDisplayed() {
        if (!combinedDisplayed || combinedDisplayed.length === 0)
          return alert("No records to export");
        const rows = combinedDisplayed.map((r) => ({
          Source: r.source,
          Engineer: r.engineer,
          RO_Code: r.roCode,
          RO_Name: r.roName,
          Active: r.active,
          UsedDetails: r.usedDetails,
          Faulty: r.faulty,
          Verified: r.isVerified ? "Yes" : "No",
          Date: formatDate(r.date),
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ActiveVsFaulty");
        XLSX.writeFile(
          wb,
          `ActiveVsFaulty_${new Date().toLocaleDateString("en-CA")}.xlsx`
        );
      }

      // wire up chips (source selectors)
      chips.forEach((c) => {
        c.addEventListener("click", () => {
          chips.forEach((ch) => ch.classList.remove("active"));
          c.classList.add("active");
          applyFiltersAndRender();
        });
        c.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            c.click();
          }
        });
      });

      // wire other controls
      document
        .getElementById("globalSearch")
        .addEventListener("input", () => applyFiltersAndRender());
      document
        .getElementById("engineerFilter")
        .addEventListener("change", () => applyFiltersAndRender());
      document
        .getElementById("fromDate")
        .addEventListener("change", () => applyFiltersAndRender());
      document
        .getElementById("toDate")
        .addEventListener("change", () => applyFiltersAndRender());
      document.getElementById("clearFilters").addEventListener("click", () => {
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";
        document.getElementById("engineerFilter").value = "ALL";
        document.getElementById("globalSearch").value = "";
        // reset to Both
        chips.forEach((ch) => ch.classList.remove("active"));
        document
          .querySelector(".chip[data-source='both']")
          .classList.add("active");
        applyFiltersAndRender();
      });

      document
        .getElementById("exportCombined")
        .addEventListener("click", exportDisplayed);
      document
        .getElementById("exportDisplayed")
        .addEventListener("click", exportDisplayed);

      // init
      (async function init() {
        await Promise.all([fetchHPCL(), fetchJIO()]);
        populateEngineerSelect();
        applyFiltersAndRender();
      })();
    </script>
  </body>
</html>
