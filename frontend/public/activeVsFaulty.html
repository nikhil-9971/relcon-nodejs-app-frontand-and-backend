<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Active vs Faulty ‚Äî Report</title>

    <!-- Fonts + SheetJS + Tailwind (for convenience) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --bg: #f6f7fb;
        --card: #ffffff;
        --muted: #6b7280;
        --primary: #06b6a4;
        --primary-600: #059669;
        --accent: #06b6a4;
        --surface: #eef2f6;
        --radius: 12px;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: var(--bg);
        color: #0b1220;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .container {
        max-width: 1200px;
        margin: 22px auto;
        padding: 16px;
      }

      /* Top filter card */
      .filter-card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 18px;
        box-shadow: 0 8px 26px rgba(10, 20, 40, 0.06);
        border: 1px solid rgba(2, 6, 23, 0.04);
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 16px;
        align-items: center;
      }

      .filter-left {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
      }

      .title {
        font-weight: 600;
        font-size: 18px;
        display: flex;
        gap: 10px;
        align-items: center;
        color: #0f172a;
      }

      .controls-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(120px, 1fr));
        gap: 12px;
        align-items: center;
        width: 100%;
      }

      .control {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      label.small {
        font-size: 12px;
        color: var(--muted);
      }

      input[type="date"],
      select,
      input[type="text"],
      textarea {
        height: 40px;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(15, 23, 42, 0.08);
        background: #fff;
        font-size: 13px;
        outline: none;
      }

      textarea {
        height: auto;
        min-height: 80px;
        resize: vertical;
      }

      input[type="text"].search {
        min-width: 260px;
      }

      .chips {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .chip {
        padding: 8px 12px;
        border-radius: 999px;
        background: #f3f4f6;
        border: 1px solid rgba(15, 23, 42, 0.04);
        cursor: pointer;
        font-size: 13px;
      }

      .chip.active {
        background: linear-gradient(90deg, var(--primary), var(--primary-600));
        color: white;
        box-shadow: 0 6px 16px rgba(6, 182, 164, 0.12);
        border-color: rgba(5, 150, 105, 0.85);
      }

      .actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        align-items: center;
      }

      .btn {
        height: 40px;
        padding: 8px 12px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        font-weight: 600;
      }

      .btn.ghost {
        background: transparent;
        border: 1px solid rgba(15, 23, 42, 0.06);
        color: var(--muted);
      }

      .btn.primary {
        background: linear-gradient(90deg, var(--primary), var(--primary-600));
        color: white;
        box-shadow: 0 8px 20px rgba(6, 182, 164, 0.08);
      }

      /* Card / Table */
      .card {
        margin-top: 18px;
        border-radius: var(--radius);
        background: var(--card);
        padding: 12px;
        box-shadow: 0 8px 26px rgba(10, 20, 40, 0.06);
        border: 1px solid rgba(2, 6, 23, 0.04);
      }

      .card h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .table-wrapper {
        margin-top: 12px;
        border-radius: 10px;
        overflow: auto;
        border: 1px solid rgba(15, 23, 42, 0.06);
        background: white;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
      }

      thead th {
        position: sticky;
        top: 0;
        background: linear-gradient(180deg, #ffffff, #fbfdff);
        color: #0f172a;
        font-weight: 700;
        font-size: 13px;
        text-align: left;
        padding: 12px 14px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      }

      tbody td {
        padding: 12px 14px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.04);
        font-size: 13px;
        color: #0f172a;
        vertical-align: top;
      }

      tbody tr:hover {
        background: rgba(2, 6, 23, 0.02);
      }

      .count-badge {
        color: #374151;
        font-weight: 700;
        font-size: 13px;
      }

      .paginator {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
        padding: 14px 6px 2px;
      }

      .paginator button {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(15, 23, 42, 0.06);
        background: #f3f4f6;
        cursor: pointer;
      }

      .oms-select {
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid rgba(15, 23, 42, 0.06);
        background: white;
      }

      /* modal helpers */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 60;
      }
      .modal {
        background: white;
        border-radius: 8px;
        padding: 16px;
        width: 720px;
        max-width: calc(100% - 40px);
        box-shadow: 0 12px 40px rgba(2, 6, 23, 0.4);
      }
      .modal h3 {
        margin: 0 0 8px 0;
      }

      /* small helpers */
      .right {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 980px) {
        .filter-card {
          grid-template-columns: 1fr;
        }
        .controls-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .title {
          font-size: 16px;
        }

        .modal {
          width: 95%;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Filters -->
      <div class="filter-card" role="region" aria-label="Filters">
        <div>
          <div class="title">
            <svg
              width="26"
              height="26"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden
            >
              <rect
                x="3"
                y="4"
                width="7"
                height="7"
                rx="2"
                fill="#06b6a4"
              ></rect>
              <rect
                x="14"
                y="4"
                width="7"
                height="7"
                rx="2"
                fill="#60a5fa"
              ></rect>
              <rect
                x="3"
                y="13"
                width="7"
                height="7"
                rx="2"
                fill="#a78bfa"
              ></rect>
              <rect
                x="14"
                y="13"
                width="7"
                height="7"
                rx="2"
                fill="#f59e0b"
              ></rect>
            </svg>
            Active vs Faulty ‚Äî Report
          </div>

          <div class="controls-grid" style="margin-top: 12px">
            <div class="control">
              <label class="small">From</label>
              <input id="fromDate" type="date" />
            </div>

            <div class="control">
              <label class="small">To</label>
              <input id="toDate" type="date" />
            </div>

            <div class="control">
              <label class="small">Source</label>
              <div class="chips" role="tablist" aria-label="Source selector">
                <div class="chip active" data-source="both" tabindex="0">
                  Both
                </div>
                <div class="chip" data-source="hpcl" tabindex="0">HPCL</div>
                <div class="chip" data-source="jio" tabindex="0">Jio BP</div>
              </div>
            </div>

            <div class="control">
              <label class="small">Engineer</label>
              <select id="engineerFilter">
                <option value="ALL">All Engineers</option>
              </select>
            </div>

            <div class="control" style="grid-column: span 2">
              <label class="small">Search</label>
              <input
                id="globalSearch"
                class="search"
                type="text"
                placeholder="Search RO, engineer, codes..."
              />
            </div>

            <div
              style="
                display: flex;
                gap: 8px;
                align-items: center;
                justify-self: end;
              "
            >
              <button id="clearFilters" class="btn ghost" type="button">
                ‚ôªÔ∏è Clear
              </button>
              <button
                id="exportCombined"
                class="btn primary"
                type="button"
                title="Export all filtered rows"
              >
                üì§ Export Shown
              </button>
            </div>
          </div>
        </div>

        <div class="right" aria-hidden>
          <div class="muted" style="text-align: right">
            <div style="font-weight: 600">Showing results</div>
            <div class="muted">Use the filters to narrow down the list</div>
          </div>
        </div>
      </div>

      <!-- Combined card / table -->
      <div class="card" aria-live="polite">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <h2>Active vs Faulty ‚Äî Combined View</h2>
            <div class="muted">
              Shows HPCL or Jio BP entries (condition:
              SpareUsed/ActiveMaterialUsed = Yes & Verified)
            </div>
          </div>
          <div class="count-badge" id="combinedCount">0 rows</div>
        </div>

        <div
          class="table-wrapper"
          role="region"
          aria-label="Results table"
          style="margin-top: 12px"
        >
          <table id="combinedTable" aria-describedby="combinedCount">
            <thead>
              <tr>
                <th>Source</th>
                <th>Engineer</th>
                <th>RO Code</th>
                <th>RO Name</th>
                <th>Active</th>
                <th>Used / Details</th>
                <th>Faulty</th>
                <th>Verified</th>
                <th>Date</th>
                <th>Faulty Code added in OMS</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="combinedBody">
              <tr>
                <td colspan="11" class="empty-row">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="paginator" id="paginator" aria-hidden="false"></div>

        <div
          style="
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
          "
        >
          <button id="exportDisplayed" class="btn ghost" type="button">
            Export Current Page
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Modal (consistent UI with bpclStatusreport.html) -->
    <div id="editModalBackdrop" class="modal-backdrop" aria-hidden="true">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="editModalTitle"
      >
        <h3 id="editModalTitle">Edit Record</h3>
        <form
          id="editForm"
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 8px;
          "
        >
          <input type="hidden" name="id" id="edit_id" />
          <input type="hidden" name="source" id="edit_source" />

          <div style="grid-column: 1 / 3">
            <label class="small">Engineer</label>
            <input type="text" id="edit_engineer" disabled />
          </div>

          <div>
            <label class="small">RO Code</label>
            <input type="text" id="edit_roCode" disabled />
          </div>

          <div>
            <label class="small">RO Name</label>
            <input type="text" id="edit_roName" disabled />
          </div>

          <div>
            <label class="small">Active</label>
            <select name="active" id="edit_active" class="oms-select">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>

          <div>
            <label class="small">Used / Details</label>
            <textarea
              name="usedDetails"
              id="edit_usedDetails"
              placeholder="Used material details"
            ></textarea>
          </div>

          <div>
            <label class="small">Faulty</label>
            <textarea
              name="faulty"
              id="edit_faulty"
              placeholder="Faulty material details"
            ></textarea>
          </div>
        </form>

        <div
          style="
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
          "
        >
          <button id="editCancelBtn" class="btn ghost">Cancel</button>
          <button id="editSaveBtn" class="btn primary">Save</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

    <!-- Loader -->
    <div
      id="modalLoader"
      class="hidden"
      style="
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 70;
      "
    >
      <div
        style="
          width: 48px;
          height: 48px;
          border: 6px solid rgba(0, 0, 0, 0.08);
          border-top-color: var(--primary);
          border-radius: 50%;
          animation: spin 1s linear infinite;
        "
      ></div>
    </div>
    <style>
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>

    <script>
      // Endpoints used by this script:
      // GET  /getMergedStatusRecords         -> HPCL merged status records
      // GET  /jioBP/getAllJioBPStatus       -> Jio records
      // PUT  /updateStatus/:id              -> update status (HPCL)
      // PUT  /jioBP/updateJioBPStatus/:id   -> update jioBP status

      const baseUrl = "https://relcon-backend-jwt-backup.onrender.com";
      const token = localStorage.getItem("token");

      // data containers
      let hpclData = [],
        jioData = [],
        combinedFiltered = [],
        combinedDisplayed = [];
      let currentPage = 1;
      const rowsPerPage = 50;

      // UI refs
      let combinedBody,
        combinedCountEl,
        chips,
        paginatorEl,
        exportCombinedBtn,
        exportDisplayedBtn,
        engineerSelect,
        searchInput,
        fromDateEl,
        toDateEl,
        clearBtn,
        toastEl;

      // modal refs
      const editModalBackdrop = document.getElementById("editModalBackdrop");
      const editForm = () => document.getElementById("editForm");
      const modalLoader = document.getElementById("modalLoader");

      // small helpers
      function escapeHTML(s) {
        if (s === null || s === undefined) return "";
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }
      function escapeCSVCell(s) {
        if (s == null) return "";
        const str = String(s);
        if (str.includes('"') || str.includes(",") || str.includes("\n"))
          return '"' + str.replaceAll('"', '""') + '"';
        return str;
      }
      function downloadCSV(filename, csv) {
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      function formatDate(d) {
        if (!d) return "";
        const dt = new Date(d);
        if (isNaN(dt)) return d;
        return dt.toISOString().slice(0, 10);
      }
      function showToast(msg, timeout = 2500) {
        if (!toastEl) return;
        toastEl.textContent = msg;
        toastEl.classList.remove("hidden");
        clearTimeout(window._toastTimer);
        window._toastTimer = setTimeout(
          () => toastEl.classList.add("hidden"),
          timeout
        );
      }

      function getUserFromToken(tkn) {
        try {
          if (!tkn) return {};
          const payload = JSON.parse(atob(tkn.split(".")[1]));
          return {
            username: (payload.username || payload.name || "").toString(),
            role: (payload.role || "").toString().toLowerCase(),
          };
        } catch {
          return {};
        }
      }
      const currentUser = getUserFromToken(token);

      // fetchers
      async function fetchHPCL() {
        try {
          const res = await fetch(`${baseUrl}/getMergedStatusRecords`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("HPCL fetch failed: " + res.status);
          const data = await res.json();
          hpclData = (data || []).map((d) => ({
            id: d._id || "",
            source: "HPCL",
            engineer: d.engineer || "",
            roCode: d.roCode || "",
            roName: d.roName || "",
            date: d.date || "",
            active: (d.spareUsed || "").toString(),
            usedDetails: d.activeSpare || "",
            faulty: d.faultySpare || "",
            isVerified: !!d.isVerified,
            oms03: d.oms03 || "No",
            raw: d,
          }));
        } catch (e) {
          console.error("HPCL fetch error", e);
          hpclData = [];
        }
      }

      async function fetchJIO() {
        try {
          const res = await fetch(`${baseUrl}/jioBP/getAllJioBPStatus`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("JIO fetch failed: " + res.status);
          const data = await res.json();
          jioData = (data || []).map((d) => ({
            id: d._id || "",
            source: "JIO",
            engineer: d.engineer || (d.planId && d.planId.engineer) || "",
            roCode: d.roCode || (d.planId && d.planId.roCode) || "",
            roName: d.roName || (d.planId && d.planId.roName) || "",
            date: d.date || (d.planId && d.planId.date) || "",
            active: (d.activeMaterialUsed || "").toString(),
            usedDetails: d.usedMaterialDetails || "",
            faulty: d.faultyMaterialDetails || "",
            isVerified: !!d.isVerified,
            oms03: d.oms03 || "No",
            raw: d,
          }));
        } catch (e) {
          console.error("JIO fetch error", e);
          jioData = [];
        }
      }

      // populate engineer select
      function populateEngineerSelect() {
        const sel = engineerSelect;
        if (!sel) return;
        const combined = [
          ...hpclData.map((d) => d.engineer),
          ...jioData.map((d) => d.engineer),
        ];
        const uniq = Array.from(new Set(combined.filter(Boolean))).sort();
        const cur = sel.value || "ALL";

        // If logged user is engineer, show only their name and disable select
        if (
          currentUser &&
          currentUser.role === "engineer" &&
          currentUser.username
        ) {
          sel.innerHTML = "";
          const o = document.createElement("option");
          o.value = currentUser.username;
          o.textContent = currentUser.username;
          sel.appendChild(o);
          sel.value = currentUser.username;
          sel.disabled = true;
          return;
        }

        sel.disabled = false;
        sel.innerHTML = '<option value="ALL">All Engineers</option>';
        uniq.forEach((v) => {
          const o = document.createElement("option");
          o.value = v;
          o.textContent = v;
          sel.appendChild(o);
        });
        if (uniq.includes(cur)) sel.value = cur;
      }

      // build rows applying Verified & Active=yes rules + filters
      function buildCombinedRows(sourceFilter, fromDate, toDate, eng, q) {
        const rows = [];
        const f = fromDate ? new Date(fromDate) : null;
        const t = toDate ? new Date(toDate) : null;

        // If logged in as engineer, force engineer filter to current user
        if (
          currentUser &&
          currentUser.role === "engineer" &&
          currentUser.username
        ) {
          eng = currentUser.username;
        }

        const addRow = (r) => {
          if (!r.isVerified) return;
          if ((r.active || "").toString().toLowerCase() !== "yes") return;
          if (eng && eng !== "ALL" && r.engineer !== eng) return;
          if (f || t) {
            const d = r.date ? new Date(r.date) : null;
            if (d && f && d < f) return;
            if (d && t && d > t) return;
          }
          if (q) {
            const hay =
              `${r.source} ${r.engineer} ${r.roCode} ${r.roName} ${r.active} ${r.usedDetails} ${r.faulty}`.toLowerCase();
            if (!hay.includes(q)) return;
          }
          rows.push({
            id: r.id,
            source: r.source,
            engineer: r.engineer,
            roCode: r.roCode,
            roName: r.roName,
            active: r.active,
            usedDetails: r.usedDetails,
            faulty: r.faulty,
            isVerified: r.isVerified,
            date: r.date,
            oms03: r.oms03 || "No",
          });
        };
        if (sourceFilter === "both" || sourceFilter === "hpcl")
          hpclData.forEach(addRow);
        if (sourceFilter === "both" || sourceFilter === "jio")
          jioData.forEach(addRow);
        return rows;
      }

      // rendering and pagination
      function renderPage(rows) {
        combinedFiltered = rows || [];
        const total = combinedFiltered.length;
        const totalPages = Math.max(1, Math.ceil(total / rowsPerPage));
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * rowsPerPage;
        const pageData = combinedFiltered.slice(start, start + rowsPerPage);
        combinedDisplayed = pageData;

        if (!pageData || pageData.length === 0) {
          combinedBody.innerHTML =
            '<tr><td colspan="11" class="empty-row">No records found</td></tr>';
        } else {
          const isAdmin = currentUser.role === "admin";
          combinedBody.innerHTML = pageData
            .map((r) => {
              const omsCell = isAdmin
                ? `<select class="oms-select" data-id="${r.id}" data-source="${
                    r.source
                  }">${["No", "Yes", "PO Basis"]
                    .map(
                      (opt) =>
                        `<option value="${opt}" ${
                          (r.oms03 || "No") === opt ? "selected" : ""
                        }>${opt}</option>`
                    )
                    .join("")}</select>`
                : escapeHTML(r.oms03 || "No");

              const actionsCell = isAdmin
                ? `<button class="btn ghost edit-btn" data-id="${r.id}" data-source="${r.source}" type="button">‚úèÔ∏è Edit</button>`
                : "";

              return `<tr>
              <td>${escapeHTML(r.source)}</td>
              <td>${escapeHTML(r.engineer)}</td>
              <td>${escapeHTML(r.roCode)}</td>
              <td>${escapeHTML(r.roName)}</td>
              <td>${escapeHTML(r.active)}</td>
              <td>${escapeHTML(r.usedDetails)}</td>
              <td>${escapeHTML(r.faulty)}</td>
              <td>${r.isVerified ? "‚úÖ Verified" : "‚ùå"}</td>
              <td>${escapeHTML(formatDate(r.date))}</td>
              <td>${omsCell}</td>
              <td>${actionsCell}</td>
            </tr>`;
            })
            .join("");
        }

        combinedCountEl.textContent = `${total} rows`;
        renderPaginator(total, Math.max(1, Math.ceil(total / rowsPerPage)));
      }

      function renderPaginator(totalRows, totalPages) {
        paginatorEl.innerHTML = "";
        const prev = document.createElement("button");
        prev.textContent = "‚¨Ö Prev";
        prev.disabled = currentPage === 1;
        prev.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderPage(combinedFiltered);
            document.querySelector(".table-wrapper").scrollTop = 0;
          }
        };
        paginatorEl.appendChild(prev);

        const maxButtons = 7;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage < maxButtons - 1)
          startPage = Math.max(1, endPage - maxButtons + 1);

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          if (i === currentPage) btn.classList.add("active");
          btn.onclick = (() => {
            const page = i;
            return () => {
              currentPage = page;
              renderPage(combinedFiltered);
              document.querySelector(".table-wrapper").scrollTop = 0;
            };
          })();
          paginatorEl.appendChild(btn);
        }

        const next = document.createElement("button");
        next.textContent = "Next ‚û°";
        next.disabled = currentPage === totalPages;
        next.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderPage(combinedFiltered);
            document.querySelector(".table-wrapper").scrollTop = 0;
          }
        };
        paginatorEl.appendChild(next);

        const summary = document.createElement("div");
        summary.style.marginLeft = "12px";
        summary.style.color = "#374151";
        summary.style.fontSize = "13px";
        const from = totalRows === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
        const to = Math.min(totalRows, currentPage * rowsPerPage);
        summary.textContent = `Showing ${from} - ${to} of ${totalRows}`;
        paginatorEl.appendChild(summary);
      }

      // OMS change handler (delegated)
      async function onOmsChange(e) {
        const sel = e.target;
        if (!sel || !sel.classList || !sel.classList.contains("oms-select"))
          return;
        const val = sel.value || "No";
        const id = sel.dataset.id;
        const source = sel.dataset.source;
        if (!id) {
          showToast("Missing id - cannot save");
          return;
        }

        // optimistic update
        [hpclData, jioData].forEach((arr) => {
          const it = arr.find((x) => String(x.id) === String(id));
          if (it) it.oms03 = val;
        });
        combinedFiltered.forEach((r) => {
          if (String(r.id) === String(id)) r.oms03 = val;
        });
        renderPage(combinedFiltered);

        try {
          let url = "",
            body = { oms03: val };
          if (source === "HPCL")
            url = `${baseUrl}/updateStatus/${encodeURIComponent(id)}`;
          else
            url = `${baseUrl}/jioBP/updateJioBPStatus/${encodeURIComponent(
              id
            )}`;
          const res = await fetch(url, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            console.error("OMS save failed", res.status, txt);
            showToast("Failed to save OMS");
            await reloadSources();
          } else showToast("Saved");
        } catch (err) {
          console.error("OMS update error", err);
          showToast("Save error");
          await reloadSources();
        }
      }

      // ---- Modal-based edit (consistent with bpclStatusreport.html), updated: modal edits Active instead of OMS ----
      function openEditModalById(id, source) {
        if (!id) return;
        const arr = source === "HPCL" ? hpclData : jioData;
        const it = arr.find((x) => String(x.id) === String(id));
        if (!it) {
          showToast("Record not found");
          return;
        }

        // populate form
        document.getElementById("edit_id").value = it.id || "";
        document.getElementById("edit_source").value = it.source || "";
        document.getElementById("edit_engineer").value = it.engineer || "";
        document.getElementById("edit_roCode").value = it.roCode || "";
        document.getElementById("edit_roName").value = it.roName || "";
        document.getElementById("edit_usedDetails").value =
          it.usedDetails || "";
        document.getElementById("edit_faulty").value = it.faulty || "";
        // IMPORTANT: show Active (Yes/No) here instead of OMS
        document.getElementById("edit_active").value = it.active || "Yes";

        // show modal
        editModalBackdrop.style.display = "flex";
        editModalBackdrop.setAttribute("aria-hidden", "false");
      }

      function closeEditModal() {
        editModalBackdrop.style.display = "none";
        editModalBackdrop.setAttribute("aria-hidden", "true");
      }

      async function saveEditModal() {
        const id = document.getElementById("edit_id").value;
        const source = document.getElementById("edit_source").value;
        if (!id || !source) {
          showToast("Missing id/source");
          return;
        }

        const newActive = (
          document.getElementById("edit_active").value || "No"
        ).toString();
        const newUsed = document.getElementById("edit_usedDetails").value || "";
        const newFaulty = document.getElementById("edit_faulty").value || "";

        // optimistic update in memory
        const arr = source === "HPCL" ? hpclData : jioData;
        const it = arr.find((x) => String(x.id) === String(id));
        if (it) {
          it.usedDetails = newUsed;
          it.faulty = newFaulty;
          it.active = newActive;
        }
        combinedFiltered.forEach((r) => {
          if (String(r.id) === String(id)) {
            r.usedDetails = newUsed;
            r.faulty = newFaulty;
            r.active = newActive;
          }
        });
        renderPage(combinedFiltered);
        closeEditModal();
        modalLoader.classList.remove("hidden");

        try {
          let url = "";
          let body = {};
          if (source === "HPCL") {
            url = `${baseUrl}/updateStatus/${encodeURIComponent(id)}`;
            // For HPCL: spareUsed -> active field, activeSpare -> usedDetails, faultySpare -> faulty
            body = {
              spareUsed: newActive,
              activeSpare: newUsed,
              faultySpare: newFaulty,
            };
          } else {
            url = `${baseUrl}/jioBP/updateJioBPStatus/${encodeURIComponent(
              id
            )}`;
            // For JIO: activeMaterialUsed -> active, usedMaterialDetails -> usedDetails, faultyMaterialDetails -> faulty
            body = {
              activeMaterialUsed: newActive,
              usedMaterialDetails: newUsed,
              faultyMaterialDetails: newFaulty,
            };
          }

          const res = await fetch(url, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
          });

          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            console.error("Edit save failed", res.status, txt);
            showToast("Failed to save changes");
            await reloadSources();
          } else {
            showToast("Saved");
          }
        } catch (err) {
          console.error("Edit update error", err);
          showToast("Save error");
          await reloadSources();
        } finally {
          modalLoader.classList.add("hidden");
        }
      }

      // reload both sources (used if saving fails to re-sync)
      async function reloadSources() {
        await Promise.all([fetchHPCL(), fetchJIO()]);
        populateEngineerSelect();
        applyFiltersAndRender();
      }

      // Export helpers (CSV)
      function buildExportRows(rows) {
        return rows.map((r) => ({
          Source: r.source,
          Engineer: r.engineer,
          RO_Code: r.roCode,
          RO_Name: r.roName,
          Active_Material_Used_in_RO: r.active,
          Used_Material_Details: r.usedDetails,
          Faulty_Material_Details: r.faulty,
          Verified: r.isVerified ? "Yes" : "No",
          Visit_Date: formatDate(r.date),
          Faulty_Code_added_in_OMS_portal: r.oms03 || "No",
        }));
      }

      function exportRowsAsCSV(rows, filename) {
        if (!rows || rows.length === 0) {
          alert("No rows to export");
          return;
        }
        const header = Object.keys(rows[0]);
        const csv = [header.map((h) => escapeCSVCell(h)).join(",")]
          .concat(
            rows.map((r) =>
              header.map((h) => escapeCSVCell(r[h] || "")).join(",")
            )
          )
          .join("\n");
        downloadCSV(filename, csv);
      }

      function onExportAllFiltered() {
        const activeChip = document.querySelector(".chip.active");
        const source = activeChip ? activeChip.dataset.source : "both";
        const from = fromDateEl.value || null;
        const to = toDateEl.value || null;
        let eng = engineerSelect.value || "ALL";
        const q = (searchInput.value || "").toLowerCase().trim();

        // if engineer role, force engineer to current user
        if (
          currentUser &&
          currentUser.role === "engineer" &&
          currentUser.username
        )
          eng = currentUser.username;

        const rows = buildCombinedRows(source, from, to, eng, q);
        if (!rows || rows.length === 0) {
          alert("No rows to export");
          return;
        }
        exportRowsAsCSV(
          buildExportRows(rows),
          `ActiveVsFaulty_${new Date().toISOString().slice(0, 10)}.csv`
        );
      }

      function onExportCurrentPage() {
        if (!combinedDisplayed || combinedDisplayed.length === 0) {
          alert("No rows to export");
          return;
        }
        exportRowsAsCSV(
          buildExportRows(combinedDisplayed),
          `ActiveVsFaulty_Page_${currentPage}_${new Date()
            .toISOString()
            .slice(0, 10)}.csv`
        );
      }

      // UI wiring & filters
      function applyFiltersAndRender() {
        const activeChip = document.querySelector(".chip.active");
        const source = activeChip ? activeChip.dataset.source : "both";
        const from = fromDateEl.value || null;
        const to = toDateEl.value || null;

        // If engineer user, force eng to current username
        let eng = engineerSelect.value || "ALL";
        if (
          currentUser &&
          currentUser.role === "engineer" &&
          currentUser.username
        ) {
          eng = currentUser.username;
          // ensure select shows that
          if (engineerSelect) {
            engineerSelect.value = eng;
            engineerSelect.disabled = true;
          }
        }

        const q = (searchInput.value || "").toLowerCase().trim();
        const rows = buildCombinedRows(source, from, to, eng, q);
        currentPage = 1;
        renderPage(rows);
      }

      function wireControls() {
        // source chips
        chips.forEach((c) => {
          c.addEventListener("click", () => {
            chips.forEach((ch) => ch.classList.remove("active"));
            c.classList.add("active");
            applyFiltersAndRender();
          });
          c.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              c.click();
            }
          });
        });

        // inputs
        searchInput.addEventListener("input", () => {
          clearTimeout(window._searchTimer);
          window._searchTimer = setTimeout(() => applyFiltersAndRender(), 200);
        });
        engineerSelect.addEventListener("change", applyFiltersAndRender);
        fromDateEl.addEventListener("change", applyFiltersAndRender);
        toDateEl.addEventListener("change", applyFiltersAndRender);
        clearBtn.addEventListener("click", () => {
          fromDateEl.value = "";
          toDateEl.value = "";
          searchInput.value = "";
          chips.forEach((ch) => ch.classList.remove("active"));
          document
            .querySelector(".chip[data-source='both']")
            .classList.add("active");
          currentPage = 1;
          // if engineer, keep engineer select limited to their name
          if (
            currentUser &&
            currentUser.role === "engineer" &&
            currentUser.username
          ) {
            engineerSelect.value = currentUser.username;
            engineerSelect.disabled = true;
          } else {
            engineerSelect.value = "ALL";
            engineerSelect.disabled = false;
          }
          applyFiltersAndRender();
        });

        exportCombinedBtn.addEventListener("click", (e) => {
          e.preventDefault();
          onExportAllFiltered();
        });
        exportDisplayedBtn.addEventListener("click", (e) => {
          e.preventDefault();
          onExportCurrentPage();
        });

        // delegate OMS changes and edit button clicks
        document
          .querySelector(".table-wrapper")
          .addEventListener("change", onOmsChange);

        document
          .querySelector(".table-wrapper")
          .addEventListener("click", (e) => {
            const btn = e.target;
            if (!btn) return;
            if (btn.classList && btn.classList.contains("edit-btn")) {
              const id = btn.dataset.id;
              const source = btn.dataset.source;
              openEditModalById(id, source);
            }
          });

        // modal buttons
        document
          .getElementById("editCancelBtn")
          .addEventListener("click", (ev) => {
            ev.preventDefault();
            closeEditModal();
          });
        document
          .getElementById("editSaveBtn")
          .addEventListener("click", async (ev) => {
            ev.preventDefault();
            await saveEditModal();
          });

        // allow backdrop click to close
        editModalBackdrop.addEventListener("click", (ev) => {
          if (ev.target === editModalBackdrop) closeEditModal();
        });
      }

      // init
      (async function init() {
        combinedBody = document.getElementById("combinedBody");
        combinedCountEl = document.getElementById("combinedCount");
        chips = Array.from(document.querySelectorAll(".chip"));
        paginatorEl = document.getElementById("paginator");
        exportCombinedBtn = document.getElementById("exportCombined");
        exportDisplayedBtn = document.getElementById("exportDisplayed");
        engineerSelect = document.getElementById("engineerFilter");
        searchInput = document.getElementById("globalSearch");
        fromDateEl = document.getElementById("fromDate");
        toDateEl = document.getElementById("toDate");
        clearBtn = document.getElementById("clearFilters");
        toastEl = document.getElementById("toast");

        // fetch and render
        await Promise.all([fetchHPCL(), fetchJIO()]);
        populateEngineerSelect();
        wireControls();
        applyFiltersAndRender();
      })();
    </script>
  </body>
</html>
