<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Overview</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #f1f5f9;
        font-size: 12px;
      }
      .dark body {
        background: #1f2937;
      }

      /* Force black text in light mode */
      body * {
        color: #000000 !important;
      }

      /* Dark mode overrides */
      .dark body * {
        color: inherit !important;
      }

      /* Smoky white background for cards in light mode */
      body .bg-white {
        background-color: #f8fafc !important;
      }

      /* Specific overrides for elements that should keep their colors */
      body .bg-green-600,
      body .bg-blue-600,
      body .bg-red-600,
      body .bg-amber-600,
      body .bg-teal-600,
      body .bg-purple-600,
      body .bg-orange-600,
      body .bg-lime-600,
      body .bg-emerald-600,
      body .bg-sky-600,
      body .bg-indigo-600,
      body .bg-rose-600,
      body .bg-pink-600,
      body .bg-violet-600,
      body .bg-cyan-600,
      body .bg-yellow-600,
      body .bg-gray-600,
      body .bg-green-100,
      body .bg-blue-100,
      body .bg-red-100,
      body .bg-amber-100,
      body .bg-teal-100,
      body .bg-purple-100,
      body .bg-orange-100,
      body .bg-lime-100,
      body .bg-emerald-100,
      body .bg-sky-100,
      body .bg-indigo-100,
      body .bg-rose-100,
      body .bg-pink-100,
      body .bg-violet-100,
      body .bg-cyan-100,
      body .bg-yellow-100,
      body .bg-gray-100,
      body .bg-green-700,
      body .bg-blue-700,
      body .bg-red-700,
      body .bg-amber-700,
      body .bg-teal-700,
      body .bg-purple-700,
      body .bg-orange-700,
      body .bg-lime-700,
      body .bg-emerald-700,
      body .bg-sky-700,
      body .bg-indigo-700,
      body .bg-rose-700,
      body .bg-pink-700,
      body .bg-violet-700,
      body .bg-cyan-700,
      body .bg-yellow-700,
      body .bg-gray-700,
      body .bg-green-800,
      body .bg-blue-800,
      body .bg-red-800,
      body .bg-amber-800,
      body .bg-teal-800,
      body .bg-purple-800,
      body .bg-orange-800,
      body .bg-lime-800,
      body .bg-emerald-800,
      body .bg-sky-800,
      body .bg-indigo-800,
      body .bg-rose-800,
      body .bg-pink-800,
      body .bg-violet-800,
      body .bg-cyan-800,
      body .bg-yellow-800,
      body .bg-gray-800,
      body .bg-green-900,
      body .bg-blue-900,
      body .bg-red-900,
      body .bg-amber-900,
      body .bg-teal-900,
      body .bg-purple-900,
      body .bg-orange-900,
      body .bg-lime-900,
      body .bg-emerald-900,
      body .bg-sky-900,
      body .bg-indigo-900,
      body .bg-rose-900,
      body .bg-pink-900,
      body .bg-violet-900,
      body .bg-cyan-900,
      body .bg-yellow-900,
      body .bg-gray-900,
      body .text-white,
      body .text-green-700,
      body .text-blue-700,
      body .text-red-700,
      body .text-amber-700,
      body .text-teal-700,
      body .text-purple-700,
      body .text-orange-700,
      body .text-lime-700,
      body .text-emerald-700,
      body .text-sky-700,
      body .text-indigo-700,
      body .text-rose-700,
      body .text-pink-700,
      body .text-violet-700,
      body .text-cyan-700,
      body .text-yellow-700,
      body .text-gray-700,
      body .text-green-300,
      body .text-blue-300,
      body .text-red-300,
      body .text-amber-300,
      body .text-teal-300,
      body .text-purple-300,
      body .text-orange-300,
      body .text-lime-300,
      body .text-emerald-300,
      body .text-sky-300,
      body .text-indigo-300,
      body .text-rose-300,
      body .text-pink-300,
      body .text-violet-300,
      body .text-cyan-300,
      body .text-yellow-300,
      body .text-gray-300 {
        color: inherit !important;
      }

      /* Show CSV icon only on hover over KPI cards (admin only buttons remain hidden for non-admin via JS) */
      .kpi-card .kpi-export {
        opacity: 0;
        visibility: hidden;
        transform: translateY(2px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .kpi-card:hover .kpi-export {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      /* Icon color tuning */
      .kpi-export i {
        color: #2563eb;
      }
      .dark .kpi-export,
      .dark .kpi-export i {
        color: var(--accent) !important;
      }
    </style>
  </head>
  <body class="p-4">
    <section class="space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-black dark:text-gray-200">
          Dashboard Overview
        </h2>
        <div id="lastUpdated" class="text-xs text-black dark:text-gray-400">
          —
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex items-center gap-3 kpi-card border border-gray-200 dark:border-gray-600"
        >
          <div
            class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 flex items-center justify-center"
          >
            <i class="fa-solid fa-calendar-check"></i>
          </div>
          <div>
            <div class="text-xs text-black dark:text-gray-400 font-medium">
              Plans Today
            </div>
            <div class="flex items-center gap-2">
              <div
                id="kpiPlansToday"
                class="text-xl font-semibold text-black dark:text-gray-200"
              >
                —
              </div>
              <button
                id="exportPlansToday"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Hold Engineers (NO PLAN + IN LEAVE) -->
        <div
          id="holdEngineersCard"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex items-center gap-3 kpi-card border border-gray-200 dark:border-gray-600"
        >
          <div
            class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 flex items-center justify-center"
          >
            <i class="fa-solid fa-user-slash"></i>
          </div>
          <div>
            <div class="text-xs text-black dark:text-gray-400">
              Hold Engineers
            </div>
            <div class="flex items-center gap-2">
              <div
                id="kpiHold"
                class="text-xl font-semibold text-black dark:text-gray-200"
              >
                —
              </div>
              <button
                id="exportHold"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
            <div
              id="kpiHoldBreakdown"
              class="text-[10px] text-black dark:text-gray-400"
            >
              —
            </div>
          </div>
        </div>

        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex items-center gap-3 kpi-card border border-gray-200 dark:border-gray-600"
        >
          <div
            class="w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 flex items-center justify-center"
          >
            <i class="fa-solid fa-triangle-exclamation"></i>
          </div>
          <div>
            <div class="text-xs text-black dark:text-gray-400 font-medium">
              Unverified Status
            </div>
            <div class="flex items-center gap-2">
              <div
                id="kpiUnverified"
                class="text-xl font-semibold text-black dark:text-gray-200"
              >
                —
              </div>
              <button
                id="exportUnverified"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>

              <!-- mail clipboard added -->

              <button
                id="copyUnverifiedMail"
                class="text-[10px] text-green-600 kpi-export"
                title="Copy Mail Content"
              >
                <i class="fa-solid fa-copy text-[11px]"></i>
              </button>
            </div>
            <!-- ✅ Breakdown line add karo -->
            <div
              id="kpiUnverifiedBreakdown"
              class="text-[10px] text-black dark:text-gray-400"
            >
              —
            </div>
          </div>
        </div>

        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex items-center gap-3 kpi-card border border-gray-200 dark:border-gray-600"
        >
          <div
            class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 flex items-center justify-center"
          >
            <i class="fa-solid fa-bell"></i>
          </div>
          <div>
            <div class="text-xs text-black dark:text-gray-400 font-medium">
              Open Incidents
            </div>
            <div class="flex items-center gap-2">
              <div
                id="kpiOpenIncidents"
                class="text-xl font-semibold text-black dark:text-gray-200"
              >
                —
              </div>
              <button
                id="exportOpenInc"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Today Pending Status (HPCL + RBML) -->
        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex items-center gap-3 kpi-card border border-gray-200 dark:border-gray-600"
        >
          <div
            class="w-10 h-10 rounded-full bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 flex items-center justify-center"
          >
            <i class="fa-solid fa-hourglass-half"></i>
          </div>
          <div>
            <div class="text-xs text-black dark:text-gray-400 font-medium">
              Status Pending (HPCL + RBML)
            </div>
            <div class="flex items-center gap-2">
              <div
                id="kpiPendingToday"
                class="text-xl font-semibold text-black dark:text-gray-200"
              >
                —
              </div>
              <button
                id="exportPending"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
            <div
              id="kpiPendingBreakdown"
              class="text-[10px] text-black dark:text-gray-400"
            >
              —
            </div>
          </div>
        </div>

        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex items-center gap-3 kpi-card border border-gray-200 dark:border-gray-600"
        >
          <div
            class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 flex items-center justify-center"
          >
            <i class="fa-solid fa-user-check"></i>
          </div>
          <div>
            <div class="text-xs text-black dark:text-gray-400 font-medium">
              Active Users Today
            </div>
            <div class="flex items-center gap-2">
              <div
                id="kpiActiveUsers"
                class="text-xl font-semibold text-black dark:text-gray-200"
              >
                —
              </div>
              <button
                id="exportActiveUsers"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-200 dark:border-gray-600"
        >
          <div class="text-sm font-semibold text-black dark:text-gray-200 mb-2">
            Verification Split
          </div>
          <canvas id="chartVerify" height="160"></canvas>
        </div>
        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 lg:col-span-2 border border-gray-200 dark:border-gray-600"
        >
          <div class="text-sm font-semibold text-black dark:text-gray-200 mb-2">
            Plans by Region (Today)
          </div>
          <canvas id="chartPlansRegion" height="80"></canvas>
        </div>
      </div>

      <!-- Customer-wise visits -->
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-200 dark:border-gray-600"
      >
        <div class="text-sm font-semibold text-black dark:text-gray-200 mb-2">
          Customer-wise Visits (Today)
        </div>
        <canvas id="chartCustomer" height="80"></canvas>
        <div
          id="customerCards"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3 mt-3"
        ></div>
      </div>

      <!-- AMC Visit Status -->
      <div
        id="amcVisitStatusCard"
        class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-200 dark:border-gray-600"
      >
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-sm font-semibold text-black dark:text-gray-200">
              AMC Visit Status
            </div>
            <div class="flex items-center gap-4 mt-1">
              <div class="text-xs text-black dark:text-gray-400">
                <label for="amcStartDate" class="mr-2">Start Date:</label>
                <input
                  type="date"
                  id="amcStartDate"
                  class="border rounded px-2 py-1 text-xs"
                  value="2025-10-01"
                />
              </div>
              <div class="text-xs text-black dark:text-gray-400">
                <label for="amcEndDate" class="mr-2">End Date:</label>
                <input
                  type="date"
                  id="amcEndDate"
                  class="border rounded px-2 py-1 text-xs"
                  value="2025-12-31"
                />
              </div>
              <button
                onclick="loadAMCVisitStatus()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs shadow"
              >
                Load Data
              </button>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button
              onclick="exportAMCVisitStatusCSV()"
              class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow"
            >
              Export CSV
            </button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead
              class="bg-gradient-to-r from-purple-600 to-indigo-600 dark:from-gray-700 dark:to-gray-600"
            >
              <tr>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Engineer Name
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Total AMC Assigned
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Total AMC Completed
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Pending AMC
                </th>

                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  AMC Completion %
                </th>
              </tr>
            </thead>
            <tbody
              id="amcVisitStatusBody"
              class="text-sm text-black dark:text-gray-200"
            ></tbody>
          </table>
        </div>
      </div>

      <!-- RELCON Connectivity Provided (All Time) -->
      <div
        id="relconConnectivityCard"
        class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-200 dark:border-gray-600"
      >
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-sm font-semibold text-black dark:text-gray-200">
              RELCON Connectivity Provided (All Time)
            </div>
            <div
              id="relconOverallCount"
              class="text-xs text-black dark:text-gray-400 mt-1"
            >
              Total RELCON Connectivity Sites:
              <span class="font-semibold text-black dark:text-gray-200">0</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button
              onclick="exportRelconConnectivityCSV()"
              class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow"
            >
              Export CSV
            </button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead
              class="bg-gradient-to-r from-emerald-600 to-green-600 dark:from-gray-700 dark:to-gray-600"
            >
              <tr id="relconConnectivityHeader">
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Region
                </th>
              </tr>
            </thead>
            <tbody
              id="relconConnectivityBody"
              class="text-sm text-black dark:text-gray-200"
            ></tbody>
          </table>
        </div>
      </div>

      <!-- Power Protection PCB Installation Status (All Time) -->
      <div
        id="pcbInstallationCard"
        class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-200 dark:border-gray-600"
      >
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold text-black dark:text-gray-200">
            Power Protection PCB Installation Status (All Time)
          </div>
          <div class="flex items-center gap-2">
            <button
              onclick="exportPcbInstallationExcel()"
              class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow"
            >
              Export xlsx
            </button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead
              class="bg-gradient-to-r from-orange-600 to-amber-600 dark:from-gray-700 dark:to-gray-600"
            >
              <tr>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Engineer Name
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Total PCB Provided (A)
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Today PCB Installation
                </th>

                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Total PCB Install (B)
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Total PCB Installation Pending
                </th>
              </tr>
            </thead>
            <tbody
              id="pcbInstallationBody"
              class="text-sm text-black dark:text-gray-200"
            ></tbody>
          </table>
          <div class="flex justify-end mt-2">
            <button
              id="savePcbProvidedBtn"
              onclick="savePcbProvidedCounts()"
              class="hidden bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs shadow"
            >
              Save
            </button>
          </div>
        </div>
      </div>

      <!-- Engineer Monthly Visits by Customer -->
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-200 dark:border-gray-600"
      >
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold text-black dark:text-gray-200">
            Engineer Monthly Visits by Customer
          </div>
          <div class="flex items-center gap-2">
            <button
              id="exportEngMonth"
              onclick="exportEngineerMonthlyCSV()"
              class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow"
            >
              Export Excel
            </button>
            <label
              for="monthSelect"
              class="text-xs text-black dark:text-gray-500"
              >Select Month</label
            >
            <select
              id="monthSelect"
              class="border rounded px-2 py-1 text-xs"
            ></select>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead
              class="bg-gradient-to-r from-lime-600 to-green-600 dark:from-gray-700 dark:to-gray-600"
            >
              <tr>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Engineer
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  HPCL
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  RBML
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  BPCL
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  NPL
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  OTHER
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  IN LEAVE
                </th>
                <th
                  class="px-3 py-2 text-left text-white dark:text-gray-200 font-semibold"
                >
                  Total
                </th>
              </tr>
            </thead>
            <tbody
              id="engMonthBody"
              class="text-sm text-black dark:text-gray-200"
            ></tbody>
          </table>
        </div>
      </div>
    </section>

    <script>
      const baseUrl = "https://relcon-backend-jwt-backup.onrender.com";

      function byId(id) {
        return document.getElementById(id);
      }

      function getToken() {
        return localStorage.getItem("token");
      }

      async function loadOverview() {
        try {
          const token = getToken();
          const headers = { Authorization: `Bearer ${token}` };

          const [
            userRes,
            plansRes,
            statusRes,
            jioRes,
            incidentRes,
            loginLogsRes,
          ] = await Promise.all([
            fetch(`${baseUrl}/user`, { headers }),
            fetch(`${baseUrl}/getDailyPlans`, { headers }),
            fetch(`${baseUrl}/getMergedStatusRecords`, { headers }),
            fetch(`${baseUrl}/jioBP/getAllJioBPStatus`, { headers }),
            fetch(`${baseUrl}/getAllIncidents`, { headers }),
            fetch(`${baseUrl}/audit/loginLogs`, { headers }),
          ]);

          const currentUser = await userRes.json();
          const plans = await plansRes.json();
          const hpcl = await statusRes.json();
          const jio = await jioRes.json();
          const incJson = await incidentRes.json();
          const loginLogs = await loginLogsRes.json();

          const today = new Date().toLocaleDateString("en-CA");
          const plansToday = (Array.isArray(plans) ? plans : []).filter((p) => {
            const isToday = String(p.date || "").slice(0, 10) === today;
            const purpose = String(p.purpose || "")
              .trim()
              .toUpperCase();
            const isNoPlanOrLeave =
              purpose === "NO PLAN" || purpose === "IN LEAVE";
            return isToday && !isNoPlanOrLeave;
          });
          const holdToday = (Array.isArray(plans) ? plans : []).filter((p) => {
            const isToday = String(p.date || "").slice(0, 10) === today;
            const purpose = String(p.purpose || "")
              .trim()
              .toUpperCase();
            return isToday && (purpose === "NO PLAN" || purpose === "IN LEAVE");
          });
          const noPlanCount = holdToday.filter(
            (p) =>
              String(p.purpose || "")
                .trim()
                .toUpperCase() === "NO PLAN"
          ).length;
          const inLeaveCount = holdToday.filter(
            (p) =>
              String(p.purpose || "")
                .trim()
                .toUpperCase() === "IN LEAVE"
          ).length;
          const unverifiedHpcl = (Array.isArray(hpcl) ? hpcl : []).filter(
            (r) => String(r.isVerified).toLowerCase() !== "true"
          );
          const unverifiedJio = (Array.isArray(jio) ? jio : []).filter(
            (r) => String(r.isVerified).toLowerCase() !== "true"
          );
          const openIncidents = (incJson?.incidents || []).filter(
            (i) => (i.status || "").toLowerCase() !== "close"
          );
          const activeUsernames = new Set(
            (Array.isArray(loginLogs) ? loginLogs : [])
              .filter(
                (l) =>
                  (l.loginTime && new Date(l.loginTime)).toDateString() ===
                  new Date().toDateString()
              )
              .map((l) => l.engineerName || l.username)
          );

          document.getElementById("kpiPlansToday").textContent =
            plansToday.length;
          document.getElementById("kpiUnverified").textContent =
            unverifiedHpcl.length + unverifiedJio.length;
          // ✅ Breakdown line update karo
          document.getElementById(
            "kpiUnverifiedBreakdown"
          ).textContent = `HPCL: ${unverifiedHpcl.length} • RBML: ${unverifiedJio.length}`;

          document.getElementById("kpiOpenIncidents").textContent =
            openIncidents.length;

          // Load AMC Visit Status data
          await loadAMCVisitStatus();
          // Today Pending (HPCL + RBML) = Today's plans minus submitted statuses from their respective sources
          const key = (rc, d) =>
            `${String(rc || "")
              .trim()
              .toUpperCase()}-${String(d || "").slice(0, 10)}`;
          const plansTodayHpcl = (plansToday || []).filter((p) =>
            String(p.phase || "")
              .toUpperCase()
              .startsWith("HPCL")
          );
          const plansTodayRbml = (plansToday || []).filter((p) =>
            String(p.phase || "")
              .toUpperCase()
              .includes("RBML")
          );

          const hpclStatusTodaySet = new Set(
            (Array.isArray(hpcl) ? hpcl : [])
              .filter((r) =>
                String(r.phase || "")
                  .toUpperCase()
                  .startsWith("HPCL")
              )
              .filter(
                (r) =>
                  String(r.date || r.uploadDate || "").slice(0, 10) === today
              )
              .map((r) => key(r.roCode, r.date || r.uploadDate))
          );
          //  const rbmlStatusTodaySet = new Set(
          //   (Array.isArray(jio) ? jio : [])
          //     .filter((r) => String(r.date || "").slice(0, 10) === today)
          //     .map((r) => key(r.roCode, r.date))
          // );

          const rbmlStatusTodaySet = new Set(
            (Array.isArray(jio) ? jio : [])
              .filter((r) => {
                const statusDate = String(
                  r.date || r.uploadDate || r.planId?.date || ""
                ).slice(0, 10);
                return statusDate === today;
              })
              .map((r) => {
                const ro = (
                  r.roCode ||
                  r.siteCode ||
                  r.ro ||
                  r.planId?.roCode ||
                  ""
                )
                  .trim()
                  .toUpperCase();
                const dt = String(
                  r.date || r.uploadDate || r.planId?.date || ""
                ).slice(0, 10);
                return key(ro, dt);
              })
          );

          const pendingTodayHpcl = plansTodayHpcl.filter(
            (p) => !hpclStatusTodaySet.has(key(p.roCode, p.date))
          ).length;

          const pendingTodayRbml = plansTodayRbml.filter(
            (p) => !rbmlStatusTodaySet.has(key(p.roCode, p.date))
          ).length;
          document.getElementById("kpiPendingToday").textContent =
            pendingTodayHpcl + pendingTodayRbml;
          document.getElementById(
            "kpiPendingBreakdown"
          ).textContent = `HPCL: ${pendingTodayHpcl} • RBML: ${pendingTodayRbml}`;

          document.getElementById("kpiActiveUsers").textContent =
            activeUsernames.size;
          document.getElementById("kpiHold").textContent = holdToday.length;
          document.getElementById(
            "kpiHoldBreakdown"
          ).textContent = `NO PLAN: ${noPlanCount} • IN LEAVE: ${inLeaveCount}`;
          document.getElementById("lastUpdated").textContent =
            new Date().toLocaleString();

          // CSV exports for KPI cards
          const exportCSV = (rows, headers, filename) => {
            try {
              const csvHeader = headers.join(",") + "\n";
              const csvRows = rows
                .map((r) =>
                  headers.map((h) => JSON.stringify(r[h] ?? "")).join(",")
                )
                .join("\n");
              const blob = new Blob([csvHeader + csvRows], {
                type: "text/csv;charset=utf-8;",
              });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            } catch (e) {
              console.error("CSV export failed", e);
            }
          };

          // Build exportable datasets
          const plansTodayRows = plansToday.map((p) => ({
            date: String(p.date || "").slice(0, 10),
            engineer: p.engineer || "",
            roCode: p.roCode || "",
            roName: p.roName || "",
            region: p.region || "",
            phase: p.phase || "",
            purpose: p.purpose || "",
          }));
          const unverifiedRows = [
            ...(unverifiedHpcl || []).map((r) => ({
              source: "HPCL",
              date: String(r.date || r.uploadDate || "").slice(0, 10),
              engineer: r.engineer || "",
              roCode: r.roCode || "",
              roName: r.roName || "",
              region: r.region || "",
              phase: r.phase || "",
              status: String(r.isVerified),
            })),
            ...(unverifiedJio || []).map((r) => ({
              source: "RBML/JIO",
              date: String(r.date || "").slice(0, 10),
              engineer: r.engineer || "",
              roCode: r.roCode || "",
              roName: r.roName || "",
              region: r.region || "",
              phase: r.phase || "",
              status: String(r.isVerified),
            })),
          ];
          const openIncRows = (incJson?.incidents || [])
            .filter((i) => (i.status || "").toLowerCase() !== "close")
            .map((i) => ({
              incidentId: i.incidentId || "",
              roCode: i.roCode || "",
              siteName: i.siteName || "",
              region: i.region || "",
              status: i.status || "",
            }));
          //const activeUserRows = Array.from(activeUsernames).map((name) => ({
          // user: name,
          // }));

          // ✅ Group login logs by user
          const todayLogins = (
            Array.isArray(loginLogs) ? loginLogs : []
          ).filter(
            (l) =>
              (l.loginTime && new Date(l.loginTime)).toDateString() ===
              new Date().toDateString()
          );

          const userLoginMap = new Map();
          todayLogins.forEach((l) => {
            const user = l.engineerName || l.username;
            const time = new Date(l.loginTime).toLocaleString();
            if (!userLoginMap.has(user)) {
              userLoginMap.set(user, []);
            }
            userLoginMap.get(user).push(time);
          });

          // Prepare CSV rows
          const activeUserRows = Array.from(userLoginMap.entries()).map(
            ([user, times]) => ({
              user,
              totalLogins: times.length,
              loginTimes: times.join(" | "), // sab times ek column me aa jayenge
            })
          );

          const holdRows = holdToday.map((p) => ({
            date: String(p.date || "").slice(0, 10),
            engineer: p.engineer || "",
            roCode: p.roCode || "",
            roName: p.roName || "",
            purpose: p.purpose || "",
          }));
          const pendingRows = [
            ...plansTodayHpcl
              .filter(
                (p) =>
                  !hpclStatusTodaySet.has(
                    `${String(p.roCode || "")
                      .trim()
                      .toUpperCase()}-${String(p.date || "").slice(0, 10)}`
                  )
              )
              .map((p) => ({
                customer: "HPCL",
                date: String(p.date || "").slice(0, 10),
                roCode: p.roCode || "",
                roName: p.roName || "",
                region: p.region || "",
                engineer: p.engineer || "",
              })),
            ...plansTodayRbml
              .filter(
                (p) =>
                  !rbmlStatusTodaySet.has(
                    `${String(p.roCode || "")
                      .trim()
                      .toUpperCase()}-${String(p.date || "").slice(0, 10)}`
                  )
              )
              .map((p) => ({
                customer: "RBML",
                date: String(p.date || "").slice(0, 10),
                roCode: p.roCode || "",
                roName: p.roName || "",
                region: p.region || "",
              })),
          ];

          // Wire export buttons
          const byId = (id) => document.getElementById(id);
          byId("exportPlansToday")?.addEventListener("click", () =>
            exportCSV(
              plansTodayRows,
              [
                "date",
                "engineer",
                "roCode",
                "roName",
                "region",
                "phase",
                "purpose",
              ],
              "plans_today.csv"
            )
          );
          byId("exportUnverified")?.addEventListener("click", () =>
            exportCSV(
              unverifiedRows,
              [
                "source",
                "date",
                "engineer",
                "roCode",
                "roName",
                "region",
                "phase",
                "status",
              ],
              "unverified_status.csv"
            )
          );
          byId("exportOpenInc")?.addEventListener("click", () =>
            exportCSV(
              openIncRows,
              ["incidentId", "roCode", "siteName", "region", "status"],
              "open_incidents.csv"
            )
          );
          byId("exportActiveUsers")?.addEventListener("click", () =>
            exportCSV(
              activeUserRows,
              ["user", "totalLogins", "loginTimes"],
              "active_users_today.csv"
            )
          );

          byId("exportHold")?.addEventListener("click", () =>
            exportCSV(
              holdRows,
              ["date", "engineer", "roCode", "roName", "purpose"],
              "hold_engineers_today.csv"
            )
          );
          byId("exportPending")?.addEventListener("click", () =>
            exportCSV(
              pendingRows,
              ["customer", "date", "roCode", "roName", "region", "engineer"],
              "status_pending.csv"
            )
          );

          const holdCard = document.getElementById("holdEngineersCard");
          if (holdCard) {
            holdCard.style.display =
              String(currentUser.role || "").toLowerCase() === "admin"
                ? ""
                : "none";
          }

          // Hide export CSV buttons for non-admin
          const isAdmin =
            String(currentUser.role || "").toLowerCase() === "admin";
          const exportIds = [
            "exportPlansToday",
            "exportUnverified",
            "exportOpenInc",
            "exportActiveUsers",
            "exportHold",
            "exportPending",
          ];
          if (!isAdmin) {
            exportIds.forEach((id) => {
              const el = document.getElementById(id);
              if (el) el.style.display = "none";
            });
          }

          // Verification Split chart role-based
          const userRole = String(currentUser.role || "").toLowerCase();
          const uname = String(
            currentUser.engineerName || currentUser.username || ""
          )
            .trim()
            .toLowerCase();
          const mineHpcl = (Array.isArray(hpcl) ? hpcl : []).filter(
            (r) =>
              String(r.engineer || "")
                .trim()
                .toLowerCase() === uname
          );
          const mineJio = (Array.isArray(jio) ? jio : []).filter(
            (r) =>
              String(r.engineer || "")
                .trim()
                .toLowerCase() === uname
          );
          const myTotal = mineHpcl.length + mineJio.length;
          const myUnverified =
            mineHpcl.filter(
              (r) => String(r.isVerified).toLowerCase() !== "true"
            ).length +
            mineJio.filter((r) => String(r.isVerified).toLowerCase() !== "true")
              .length;

          const allUnverified = unverifiedHpcl.length + unverifiedJio.length;
          const allTotal =
            (Array.isArray(hpcl) ? hpcl.length : 0) +
            (Array.isArray(jio) ? jio.length : 0);

          const chartUnverified =
            userRole === "admin" ? allUnverified : myUnverified;
          const chartVerified =
            userRole === "admin"
              ? allTotal - allUnverified
              : myTotal - myUnverified;

          renderVerifyChart(chartUnverified, chartVerified);
          renderPlansRegionChart(plansToday);
          renderCustomerChart(plansToday);

          // Customer cards
          const customerCounts = new Map();
          (plansToday || []).forEach((p) => {
            const cust = customerFromPlan(p);
            customerCounts.set(cust, (customerCounts.get(cust) || 0) + 1);
          });
          renderCustomerCards(customerCounts);

          // Engineer monthly by customer (dropdown + table)
          window.__allPlans = Array.isArray(plans) ? plans : [];
          window.__statusRecords = Array.isArray(hpcl) ? hpcl : [];
          window.__currentUser = currentUser || {};
          buildMonthDropdown(window.__allPlans);
          const sel = document.getElementById("monthSelect");
          renderEngineerMonthly(window.__allPlans, sel.value);
          sel.addEventListener("change", () => {
            renderEngineerMonthly(window.__allPlans, sel.value);
          });

          // Render RELCON connectivity and PCB status (all-time from statusRecords)
          renderRelconConnectivity(window.__statusRecords);
          renderPcbInstallation(window.__statusRecords);
        } catch (e) {
          console.error("overview load error", e);
        }

        //Mail Clip Added

        document
          .getElementById("copyUnverifiedMail")
          ?.addEventListener("click", () => {
            try {
              const unverifiedHpcl = window.__unverifiedHpcl || [];
              const unverifiedJio = window.__unverifiedJio || [];

              console.log("HPCL Unverified:", window.__unverifiedHpcl);
              console.log("JIO Unverified:", window.__unverifiedJio);

              const engineerMap = new Map();
              [...unverifiedHpcl, ...unverifiedJio].forEach((r) => {
                console.log("DEBUG ROW", r);
                // ✅ Backend field = engineer
                const eng = String(r.engineer || "").trim() || "-";
                engineerMap.set(eng, (engineerMap.get(eng) || 0) + 1);
              });

              // Mail body
              let mailHtml = `
      <p>Dear Anurag,</p>
      <p>Please find below the <b>Unverified Status Report</b> of HPCL & RBML Customer.</p>
      <table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse; font-family:Poppins, Arial; font-size:12px; width:100%;">
        <thead style="background:#f1f5f9;">
          <tr>
            <th style="text-align:left;">Engineer Name</th>
            <th style="text-align:center;">Unverified Count</th>
          </tr>
        </thead>
        <tbody>
    `;

              engineerMap.forEach((count, eng) => {
                mailHtml += `
        <tr>
          <td>${eng}</td>
          <td style="text-align:center;">${count}</td>
        </tr>
      `;
              });

              mailHtml += `
        </tbody>
      </table>
      <p><b>Note:</b> Kindly verify the pending status within <b>01 day</b> to avoid escalation.</p>
      <p>Regards,<br/>Nikhil Trivedi</p>
    `;

              // Copy with formatting
              const blobHtml = new Blob([mailHtml], { type: "text/html" });
              const blobText = new Blob([mailHtml.replace(/<[^>]+>/g, "")], {
                type: "text/plain",
              });

              navigator.clipboard
                .write([
                  new ClipboardItem({
                    "text/html": blobHtml,
                    "text/plain": blobText,
                  }),
                ])
                .then(() => {
                  alert("✅ Mail content copied with engineer rows!");
                });
            } catch (e) {
              console.error("copy mail error", e);
            }
          });
      }

      function renderVerifyChart(unverified, verified) {
        const ctx = document.getElementById("chartVerify");
        if (!ctx) return;
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Unverified", "Verified"],
            datasets: [
              {
                data: [unverified, verified],
                backgroundColor: ["#f59e0b", "#16a34a"],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
          },
        });
      }
      function renderPlansRegionChart(plans) {
        const ctx = document.getElementById("chartPlansRegion");
        if (!ctx) return;
        const counts = new Map();
        (plans || []).forEach((p) => {
          const r = (p.region || "").toUpperCase();
          counts.set(r, (counts.get(r) || 0) + 1);
        });
        const labels = Array.from(counts.keys());
        const data = labels.map((l) => counts.get(l));
        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{ label: "Plans", data, backgroundColor: "#60a5fa" }],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
          },
        });
      }

      function customerFromPlan(p) {
        const ph = String(p.phase || "").toUpperCase();
        if (ph.startsWith("HPCL")) return "HPCL";
        if (ph.includes("RBML")) return "RBML";
        if (ph.includes("BPCL")) return "BPCL";
        if (ph.includes("NPL")) return "NPL";
        return "OTHER";
      }

      function renderCustomerChart(plans) {
        const ctx = document.getElementById("chartCustomer");
        if (!ctx) return;
        const counts = new Map();
        const labelColorMap = new Map([
          ["HPCL", "#16a34a"],
          ["RBML", "#f59e0b"],
          ["BPCL", "#60a5fa"],
          ["NPL", "#34d399"],
          ["OTHER", "#9ca3af"],
        ]);

        (plans || []).forEach((p) => {
          const cust = customerFromPlan(p);
          counts.set(cust, (counts.get(cust) || 0) + 1);
        });

        const labels = Array.from(counts.keys());
        const data = labels.map((l) => counts.get(l));
        const colors = labels.map((l) => labelColorMap.get(l) || "#9ca3af");

        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{ label: "Visits", data, backgroundColor: colors }],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
          },
        });
      }

      function renderCustomerCards(counts) {
        const container = document.getElementById("customerCards");
        if (!container) return;
        const color = (label) =>
          ({
            HPCL: "#16a34a",
            RBML: "#f59e0b",
            BPCL: "#60a5fa",
            NPL: "#34d399",
            "JIO BP": "#a78bfa",
            OTHER: "#9ca3af",
          }[label] || "#9ca3af");

        const items = Array.from(counts.entries()).sort((a, b) => b[1] - a[1]);
        container.innerHTML = items
          .map(
            ([label, count]) => `
          <div class="rounded-lg border bg-white p-3 flex items-center gap-3 shadow-sm">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white" style="background:${color(
              label
            )}">${label.split(" ")[0][0]}</div>
            <div>
              <div class="text-[11px] text-black dark:text-gray-500">${label}</div>
                              <div class="text-lg font-semibold text-black dark:text-gray-200">${count}</div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // ===== Monthly Engineer x Customer table =====
      function ymKey(d) {
        try {
          return new Date(d).toLocaleDateString("en-CA").slice(0, 7);
        } catch {
          return "";
        }
      }
      function buildMonthDropdown(plans) {
        const sel = document.getElementById("monthSelect");
        if (!sel) return;
        const keys = new Set(
          (plans || []).map((p) => ymKey(p.date)).filter(Boolean)
        );
        // Fallback: include current month if none
        if (keys.size === 0) {
          keys.add(new Date().toLocaleDateString("en-CA").slice(0, 7));
        }
        const sorted = Array.from(keys).sort().reverse();
        sel.innerHTML = sorted
          .map((k) => {
            const [y, m] = k.split("-");
            const dt = new Date(`${k}-01T00:00:00`);
            const label = dt.toLocaleString("en-US", {
              month: "long",
              year: "numeric",
            });
            return `<option value="${k}">${label}</option>`;
          })
          .join("");
      }
      function renderEngineerMonthly(plans, ym) {
        const body = document.getElementById("engMonthBody");
        if (!body) return;
        const data = (plans || []).filter((p) => {
          if (ymKey(p.date) !== ym) return false;
          const purposeUpper = String(p.issueType || p.purpose || "")
            .trim()
            .toUpperCase();
          // Exclude NO PLAN only; keep IN LEAVE so it can be counted
          if (purposeUpper === "NO PLAN") return false;
          return true;
        });

        // Aggregate: engineer -> customer -> count
        const map = new Map();
        const customers = ["HPCL", "RBML", "BPCL", "NPL", "OTHER", "IN LEAVE"];
        data.forEach((p) => {
          const eng = String(p.engineer || "").trim() || "-";
          const purposeUpper = String(p.issueType || p.purpose || "")
            .trim()
            .toUpperCase();
          const cust =
            purposeUpper === "IN LEAVE" ? "IN LEAVE" : customerFromPlan(p);
          if (!map.has(eng))
            map.set(eng, new Map(customers.map((c) => [c, 0])));
          const row = map.get(eng);
          row.set(cust, (row.get(cust) || 0) + 1);
        });

        const rows = Array.from(map.entries()).sort((a, b) =>
          a[0].localeCompare(b[0])
        );
        body.innerHTML = rows
          .map(([eng, row]) => {
            const cells = customers
              .map(
                (c) =>
                  `<td class="px-3 py-2 text-black dark:text-gray-200">${
                    row.get(c) || 0
                  }</td>`
              )
              .join("");
            const total = customers
              .filter((c) => c !== "IN LEAVE")
              .reduce((s, c) => s + (row.get(c) || 0), 0);
            return `<tr class="border-b"><td class="px-3 py-2 font-medium text-black dark:text-gray-200">${eng}</td>${cells}<td class="px-3 py-2 font-semibold text-black dark:text-gray-200">${total}</td></tr>`;
          })
          .join("");

        // Append totals row at the end
        const totals = new Map(customers.map((c) => [c, 0]));
        rows.forEach(([_, row]) => {
          customers.forEach((c) =>
            totals.set(c, totals.get(c) + (row.get(c) || 0))
          );
        });
        const grandTotal = customers
          .filter((c) => c !== "IN LEAVE")
          .reduce((s, c) => s + (totals.get(c) || 0), 0);
        const totalCells = customers
          .map(
            (c) =>
              `<td class="px-3 py-2 font-semibold text-black dark:text-gray-200">${
                totals.get(c) || 0
              }</td>`
          )
          .join("");
        body.innerHTML += `<tr class="border-t bg-gray-50 dark:bg-gray-700"><td class="px-3 py-2 font-bold text-black dark:text-gray-200">Total</td>${totalCells}<td class="px-3 py-2 font-bold text-black dark:text-gray-200">${grandTotal}</td></tr>`;
      }

      function normalizeText(s) {
        return String(s || "")
          .trim()
          .toUpperCase();
      }

      function isPowerProtectionInstall(purpose) {
        const t = normalizeText(purpose);
        return (
          t.includes("POWER PROTECTION PCB") &&
          (t.includes("INSTALL") || t.includes("INSTAL"))
        );
      }

      function isGsmModuleInstall(purpose) {
        const t = normalizeText(purpose);
        return (
          (t.includes("GSM MODULE") &&
            (t.includes("INSTALL") || t.includes("INSTAL"))) ||
          t.includes("GSM MODULE INSTALLATION")
        );
      }

      function deviceProvidedStorageKey(ym) {
        return `device_provided_${ym}`;
      }

      function renderDeviceInstallations(plans, ym) {
        const tbody = document.getElementById("deviceInstallBody");
        const saveBtn = document.getElementById("saveDeviceProvidedBtn");
        if (!tbody) return;
        const data = (plans || []).filter((p) => {
          if (ymKey(p.date) !== ym) return false;
          const purposeUpper = normalizeText(p.issueType || p.purpose);
          if (purposeUpper === "NO PLAN") return false;
          return true;
        });

        const isAdmin = (window.__currentUser || {}).role === "admin";
        const stored = JSON.parse(
          localStorage.getItem(deviceProvidedStorageKey(ym)) || "{}"
        );

        const map = new Map(); // engineer -> { power: n, gsm: n, provided: n }
        data.forEach((p) => {
          const eng = String(p.engineer || "").trim() || "-";
          const purpose = p.purpose || p.issueType || "";
          if (!map.has(eng))
            map.set(eng, { power: 0, gsm: 0, provided: stored[eng] || 0 });
          const rec = map.get(eng);
          if (isPowerProtectionInstall(purpose)) rec.power += 1;
          if (isGsmModuleInstall(purpose)) rec.gsm += 1;
        });

        const rows = Array.from(map.entries()).sort((a, b) =>
          a[0].localeCompare(b[0])
        );
        const total = { power: 0, gsm: 0, provided: 0 };
        tbody.innerHTML = rows
          .map(([eng, rec]) => {
            total.power += rec.power;
            total.gsm += rec.gsm;
            total.provided += Number(rec.provided) || 0;
            const providedCell = isAdmin
              ? `<input type="number" min="0" value="${rec.provided}" data-eng="${eng}" class="border px-2 py-1 rounded w-24" />`
              : `<span>${rec.provided}</span>`;
            return `<tr class="border-b">
              <td class="px-3 py-2 font-medium">${eng}</td>
              <td class="px-3 py-2">${rec.power}</td>
              <td class="px-3 py-2">${rec.gsm}</td>
              <td class="px-3 py-2">${providedCell}</td>
            </tr>`;
          })
          .join("");

        // Totals row
        tbody.innerHTML += `<tr class="border-t bg-gray-50">
          <td class="px-3 py-2 font-bold">Total</td>
          <td class="px-3 py-2 font-bold">${total.power}</td>
          <td class="px-3 py-2 font-bold">${total.gsm}</td>
          <td class="px-3 py-2 font-bold">${total.provided}</td>
        </tr>`;

        // Show save button for admin only
        if (saveBtn) saveBtn.classList.toggle("hidden", !isAdmin);
      }

      function saveDeviceProvidedCounts() {
        try {
          const sel = document.getElementById("monthSelect");
          const ym = sel
            ? sel.value
            : new Date().toLocaleDateString("en-CA").slice(0, 7);
          const inputs = document.querySelectorAll(
            "#deviceInstallBody input[data-eng]"
          );
          const payload = {};
          inputs.forEach((inp) => {
            const eng = inp.getAttribute("data-eng");
            const val = Number(inp.value || 0) || 0;
            payload[eng] = val;
          });
          localStorage.setItem(
            deviceProvidedStorageKey(ym),
            JSON.stringify(payload)
          );
        } catch (e) {
          console.error("save device provided error", e);
        }
      }

      function renderRelconConnectivity(statusRecords) {
        const tbody = document.getElementById("relconConnectivityBody");
        const header = document.getElementById("relconConnectivityHeader");
        if (!tbody || !header) return;

        // Get user role and engineer name from currentUser
        const currentUser = window.__currentUser || {};
        const userRole = currentUser.role || "";
        const currentEngineer =
          currentUser.engineerName || currentUser.username || "";

        // Filter records with ConnectivityType = RELCON SIM
        let relcon = (statusRecords || []).filter((r) =>
          String(r.connectivityType || r.ConnectivityType || "")
            .trim()
            .toUpperCase()
            .includes("RELCON")
        );

        // Filter by engineer if role is engineer
        if (userRole === "engineer" && currentEngineer) {
          relcon = relcon.filter((r) => {
            // Try multiple possible field names for engineer
            const engineer = String(
              r.engineer ||
                r.Engineer ||
                r.engineerName ||
                r.EngineerName ||
                r.ENGINEER ||
                r.ENGINEERNAME ||
                ""
            ).trim();
            return engineer.toLowerCase() === currentEngineer.toLowerCase();
          });
        }

        // Create pivot table: region -> phase -> count
        const regionPhaseMap = new Map(); // region -> Map(phase -> Set(roCode))
        const allPhases = new Set();

        relcon.forEach((r) => {
          const region = String(r.region || r.Region || "").trim() || "-";
          const phase = String(r.phase || r.Phase || "").trim() || "-";
          const ro = String(r.roCode || r.ROCode || r.rocode || "").trim();

          if (!regionPhaseMap.has(region)) {
            regionPhaseMap.set(region, new Map());
          }
          if (!regionPhaseMap.get(region).has(phase)) {
            regionPhaseMap.get(region).set(phase, new Set());
          }
          if (ro) {
            regionPhaseMap.get(region).get(phase).add(ro);
            allPhases.add(phase);
          }
        });

        // Sort phases and regions
        const sortedPhases = Array.from(allPhases).sort();
        const sortedRegions = Array.from(regionPhaseMap.keys()).sort();

        // Build header with phases as columns
        header.innerHTML =
          `<th class="px-3 py-2 text-left">Region</th>` +
          sortedPhases
            .map((phase) => `<th class="px-3 py-2 text-left">${phase}</th>`)
            .join("") +
          `<th class="px-3 py-2 text-left">Total</th>`;

        // Build rows
        let totalRow = new Array(sortedPhases.length + 1).fill(0); // +1 for region column

        tbody.innerHTML = sortedRegions
          .map((region) => {
            const phaseCounts = sortedPhases.map((phase) => {
              const count = regionPhaseMap.get(region).get(phase)?.size || 0;
              totalRow[sortedPhases.indexOf(phase) + 1] += count; // +1 because index 0 is region
              return count;
            });
            const regionTotal = phaseCounts.reduce(
              (sum, count) => sum + count,
              0
            );
            totalRow[0] += regionTotal;

            return `<tr class="border-b">
            <td class="px-3 py-2 font-medium">${region}</td>
            ${phaseCounts
              .map((count) => `<td class="px-3 py-2">${count}</td>`)
              .join("")}
            <td class="px-3 py-2 font-semibold">${regionTotal}</td>
          </tr>`;
          })
          .join("");

        // Add total row
        if (sortedRegions.length > 0) {
          tbody.innerHTML += `<tr class="border-t bg-gray-50">
            <td class="px-3 py-2 font-bold">Total</td>
            ${totalRow
              .slice(1, -1)
              .map((count) => `<td class="px-3 py-2 font-bold">${count}</td>`)
              .join("")}
            <td class="px-3 py-2 font-bold">${
              totalRow[totalRow.length - 1]
            }</td>
          </tr>`;

          // Calculate unique sites count (sum of all unique RO codes across all phases)
          const uniqueSites = new Set();
          relcon.forEach((r) => {
            const roCode = String(
              r.roCode || r.ROCode || r.rocode || ""
            ).trim();
            if (roCode) {
              uniqueSites.add(roCode);
            }
          });

          // Update overall count display
          const overallCountElement =
            document.getElementById("relconOverallCount");
          if (overallCountElement) {
            const uniqueSitesCount = uniqueSites.size;
            overallCountElement.innerHTML = `Total RELCON Connectivity Sites: <span class="font-semibold text-black dark:text-gray-200">${uniqueSitesCount}</span>`;
          }
        } else {
          tbody.innerHTML = `<tr><td colspan="${
            sortedPhases.length + 2
          }" class="px-3 py-4 text-center text-black dark:text-gray-400">No data</td></tr>`;

          // Update overall count display for no data
          const overallCountElement =
            document.getElementById("relconOverallCount");
          if (overallCountElement) {
            overallCountElement.innerHTML = `Total RELCON Connectivity Sites: <span class="font-semibold text-black dark:text-gray-200">0</span>`;
          }
        }
      }

      function pcbProvidedStorageKey() {
        return `pcb_provided_alltime`;
      }

      function renderPcbInstallation(statusRecords) {
        const tbody = document.getElementById("pcbInstallationBody");
        const saveBtn = document.getElementById("savePcbProvidedBtn");
        if (!tbody) return;

        const currentUser = window.__currentUser || {};
        const userRole = currentUser.role || "";
        const currentEngineer =
          currentUser.engineerName || currentUser.username || "";
        const isAdmin = userRole === "admin";

        const providedMap = JSON.parse(
          localStorage.getItem(pcbProvidedStorageKey()) || "{}"
        );

        // today date
        const today = new Date().toISOString().slice(0, 10);

        const isPcbInstall = (purpose) => {
          const t = String(purpose || "")
            .trim()
            .toUpperCase();
          return (
            t.includes("POWER PROTECTION PCB") &&
            (t.includes("INSTALL") || t.includes("INSTAL"))
          );
        };

        let filteredRecords = statusRecords || [];
        if (userRole === "engineer" && currentEngineer) {
          filteredRecords = filteredRecords.filter((r) => {
            const engineer = String(
              r.engineer ||
                r.Engineer ||
                r.engineerName ||
                r.EngineerName ||
                r.ENGINEER ||
                r.ENGINEERNAME ||
                ""
            ).trim();
            return engineer.toLowerCase() === currentEngineer.toLowerCase();
          });
        }

        const map = new Map(); // engineer -> { provided, installed, todayInstalled }
        filteredRecords.forEach((r) => {
          const eng = String(r.engineer || r.Engineer || "").trim() || "-";
          if (!map.has(eng))
            map.set(eng, {
              provided: Number(providedMap[eng] || 0) || 0,
              installed: 0,
              todayInstalled: 0,
            });

          if (isPcbInstall(r.purpose || r.PurposeOfVisit || r.PURPOSEOFVISIT)) {
            map.get(eng).installed += 1;

            // check if today's installation
            const recordDate = String(r.date || r.Date || r.DATE || "").slice(
              0,
              10
            );
            if (recordDate === today) {
              map.get(eng).todayInstalled += 1;
            }
          }
        });

        const rows = Array.from(map.entries())
          .map(([eng, rec]) => {
            return {
              eng,
              provided: rec.provided,
              todayInstalled: rec.todayInstalled,
              installed: rec.installed,
              pending: Math.max(0, rec.provided - rec.installed),
            };
          })
          .filter((r) => r.eng.toUpperCase() !== "NAVAL KISHOR PANDEY")
          .sort((a, b) => a.eng.localeCompare(b.eng));

        const totalProvided = rows.reduce((sum, r) => sum + r.provided, 0);
        const totalInstalled = rows.reduce((sum, r) => sum + r.installed, 0);
        const totalPending = rows.reduce((sum, r) => sum + r.pending, 0);
        const totalTodayInstalled = rows.reduce(
          (sum, r) => sum + r.todayInstalled,
          0
        );

        tbody.innerHTML = rows
          .map((r) => {
            const providedCell = isAdmin
              ? `<input type="number" min="0" value="${r.provided}" data-eng="${r.eng}" class="border px-2 py-1 rounded w-28 text-black dark:text-gray-200" />`
              : `<span class="text-black dark:text-gray-200">${r.provided}</span>`;
            return `<tr class="border-b">
        <td class="px-3 py-2 font-medium text-black dark:text-gray-200">${r.eng}</td>
        <td class="px-3 py-2 text-black dark:text-gray-200">${providedCell}</td>
        <td class="px-3 py-2 text-black dark:text-gray-200">${r.todayInstalled}</td>
        <td class="px-3 py-2 text-black dark:text-gray-200">${r.installed}</td>
        <td class="px-3 py-2 text-black dark:text-gray-200">${r.pending}</td>
      </tr>`;
          })
          .join("");

        if (rows.length > 0) {
          tbody.innerHTML += `<tr class="border-t bg-gray-50 dark:bg-gray-700">
      <td class="px-3 py-2 font-bold text-black dark:text-gray-200">Total</td>
      <td class="px-3 py-2 font-bold text-black dark:text-gray-200">${totalProvided}</td>
      <td class="px-3 py-2 font-bold text-black dark:text-gray-200">${totalTodayInstalled}</td>
      <td class="px-3 py-2 font-bold text-black dark:text-gray-200">${totalInstalled}</td>
      <td class="px-3 py-2 font-bold text-red dark:text-gray-200">${totalPending}</td>
    </tr>`;
        } else {
          tbody.innerHTML = `<tr><td colspan="5" class="px-3 py-4 text-center text-black dark:text-gray-400">No data</td></tr>`;
        }

        if (saveBtn) saveBtn.classList.toggle("hidden", !isAdmin);
      }

      function savePcbProvidedCounts() {
        try {
          const inputs = document.querySelectorAll(
            "#pcbInstallationBody input[data-eng]"
          );
          const payload = {};
          inputs.forEach((inp) => {
            const eng = inp.getAttribute("data-eng");
            const val = Number(inp.value || 0) || 0;
            payload[eng] = val;
          });
          localStorage.setItem(
            pcbProvidedStorageKey(),
            JSON.stringify(payload)
          );
          // Re-render to update pending calculations
          renderPcbInstallation(window.__statusRecords);
        } catch (e) {
          console.error("save pcb provided error", e);
        }
      }

      function exportRelconConnectivityCSV() {
        try {
          const statusRecords = window.__statusRecords || [];

          // Get user role and engineer name from currentUser
          const currentUser = window.__currentUser || {};
          const userRole = currentUser.role || "";
          const currentEngineer =
            currentUser.engineerName || currentUser.username || "";

          let relcon = statusRecords.filter((r) =>
            String(r.connectivityType || r.ConnectivityType || "")
              .trim()
              .toUpperCase()
              .includes("RELCON")
          );

          // Filter by engineer if role is engineer
          if (userRole === "engineer" && currentEngineer) {
            relcon = relcon.filter((r) => {
              // Try multiple possible field names for engineer
              const engineer = String(
                r.engineer ||
                  r.Engineer ||
                  r.engineerName ||
                  r.EngineerName ||
                  r.ENGINEER ||
                  r.ENGINEERNAME ||
                  ""
              ).trim();
              return engineer.toLowerCase() === currentEngineer.toLowerCase();
            });
          }

          // Remove duplicate sites (unique RO codes)
          const uniqueSites = new Map(); // roCode -> record
          relcon.forEach((r) => {
            const roCode = String(
              r.roCode || r.ROCode || r.rocode || ""
            ).trim();
            if (roCode && !uniqueSites.has(roCode)) {
              uniqueSites.set(roCode, r);
            }
          });

          const csvRows = [
            [
              "EngineerName",
              "Region",
              "RO Code",
              "RO Name",
              "Phase",
              "Connectivity Type",
              "SIM1 Provider",
              "SIM1 Number",
              "SIM2 Provider",
              "SIM2 Number",
              "IEMI Number",
            ],
          ];

          uniqueSites.forEach((r) => {
            const eng = String(r.engineer || r.Engineer || "").trim();
            const region = String(r.region || r.Region || "").trim();
            const roCode = String(
              r.roCode || r.ROCode || r.rocode || ""
            ).trim();
            const roName = String(r.roName || r.ROName || "").trim();
            const phase = String(r.phase || r.Phase || "").trim();
            const connectivityType = String(
              r.connectivityType || r.ConnectivityType || ""
            ).trim();
            const sim1Provider = String(
              r.sim1Provider || r.SIM1Provider || ""
            ).trim();
            const sim1Number = `\`${String(
              r.sim1Number || r.SIM1Number || ""
            ).trim()}`;
            const sim2Provider = String(
              r.sim2Provider || r.SIM2Provider || ""
            ).trim();
            const sim2Number = `\`${String(
              r.sim2Number || r.SIM2Number || ""
            ).trim()}`;
            const iemiNumber = `\`${String(
              r.iemiNumber || r.IEMINumber || r.imeiNumber || ""
            ).trim()}`;

            csvRows.push([
              eng,
              region,
              roCode,
              roName,
              phase,
              connectivityType,
              sim1Provider,
              sim1Number,
              sim2Provider,
              sim2Number,
              iemiNumber,
            ]);
          });

          // Add total connectivity count at the end
          csvRows.push([]); // Empty row
          csvRows.push(["Total RELCON Connectivity", uniqueSites.size]);

          const blob = new Blob(
            [csvRows.map((row) => row.join(",")).join("\n")],
            { type: "text/csv;charset=utf-8;" }
          );
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "relcon_connectivity_data.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error("export relcon csv error", e);
        }
      }

      //export POWER PCB INstall Data

      function exportPcbInstallationExcel() {
        try {
          let statusRecords = window.__statusRecords || [];

          // Get user role and engineer name from currentUser
          const currentUser = window.__currentUser || {};
          const userRole = currentUser.role || "";
          const currentEngineer =
            currentUser.engineerName || currentUser.username || "";

          let pcbRecords = statusRecords.filter((r) => {
            const purpose = String(
              r.purpose || r.PurposeOfVisit || r.PURPOSEOFVISIT || ""
            )
              .trim()
              .toUpperCase();
            return (
              purpose.includes("POWER PROTECTION PCB") &&
              (purpose.includes("INSTALL") || purpose.includes("INSTAL"))
            );
          });

          // Filter by engineer if role is engineer
          if (userRole === "engineer" && currentEngineer) {
            pcbRecords = pcbRecords.filter((r) => {
              const engineer = String(
                r.engineer ||
                  r.Engineer ||
                  r.engineerName ||
                  r.EngineerName ||
                  r.ENGINEER ||
                  r.ENGINEERNAME ||
                  ""
              ).trim();
              return engineer.toLowerCase() === currentEngineer.toLowerCase();
            });
          }

          // 1️⃣ Build Detail Sheet Data
          const detailRows = pcbRecords.map((r) => ({
            EngineerName: String(r.engineer || r.Engineer || "").trim(),
            Region: String(r.region || r.Region || "").trim(),
            ROCode: String(r.roCode || r.ROCode || r.rocode || "").trim(),
            ROName: String(r.roName || r.ROName || "").trim(),
            Phase: String(r.phase || "").trim(),
            Date: String(r.date || r.Date || "").trim(),
            PurposeOfVisit: String(
              r.purpose || r.PurposeOfVisit || r.PURPOSEOFVISIT || ""
            ).trim(),
          }));

          // 2️⃣ Build Summary Sheet Data
          const summaryMap = {};

          detailRows.forEach((r) => {
            const eng = r.EngineerName || "Unknown";
            if (!summaryMap[eng]) {
              summaryMap[eng] = { Provided: 0, Today: 0, Total: 0, Pending: 0 };
            }

            summaryMap[eng].Provided = summaryMap[eng].Provided || 0; // agar provided ki value aap UI se aa rahi hai toh adjust karna padega
            summaryMap[eng].Total += 1;

            // Check if visit date is today
            const today = new Date().toISOString().split("T")[0];
            if (r.Date && r.Date.startsWith(today)) {
              summaryMap[eng].Today += 1;
            }
          });

          // Convert to array
          const summaryRows = [
            [
              "Engineer Name",
              "Total PCB Provided (A)",
              "Today PCB Installation",
              "Total PCB Install (B)",
              "Total PCB Installation Pending",
            ],
          ];
          Object.entries(summaryMap).forEach(([eng, val]) => {
            summaryRows.push([
              eng,
              val.Provided,
              val.Today,
              val.Total,
              (val.Provided || 0) - val.Total,
            ]);
          });

          // Totals row
          const totalProvided = Object.values(summaryMap).reduce(
            (sum, v) => sum + (v.Provided || 0),
            0
          );
          const totalToday = Object.values(summaryMap).reduce(
            (sum, v) => sum + v.Today,
            0
          );
          const totalInstall = Object.values(summaryMap).reduce(
            (sum, v) => sum + v.Total,
            0
          );
          const totalPending = Object.values(summaryMap).reduce(
            (sum, v) => sum + ((v.Provided || 0) - v.Total),
            0
          );

          summaryRows.push([
            "Total",
            totalProvided,
            totalToday,
            totalInstall,
            totalPending,
          ]);

          // 3️⃣ Convert to Worksheet
          const ws1 = XLSX.utils.aoa_to_sheet(summaryRows);
          const ws2 = XLSX.utils.json_to_sheet(detailRows);

          // 4️⃣ Create Workbook
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws1, "Summary");
          XLSX.utils.book_append_sheet(wb, ws2, "Details");

          // 5️⃣ Export
          XLSX.writeFile(wb, "pcb_installation_report.xlsx");
        } catch (e) {
          console.error("export pcb excel error", e);
        }
      }

      function exportEngineerMonthlyCSV() {
        try {
          const plans = window.__allPlans || [];
          const sel = document.getElementById("monthSelect");
          const ym = sel
            ? sel.value
            : new Date().toLocaleDateString("en-CA").slice(0, 7);
          // Recompute the same aggregation as renderEngineerMonthly
          const data = (plans || []).filter((p) => {
            if (ymKey(p.date) !== ym) return false;
            const purposeUpper = String(p.issueType || p.purpose || "")
              .trim()
              .toUpperCase();
            if (purposeUpper === "NO PLAN") return false;
            return true;
          });
          const customers = [
            "HPCL",
            "RBML",
            "BPCL",
            "NPL",
            "OTHER",
            "IN LEAVE",
          ];
          const map = new Map();
          data.forEach((p) => {
            const eng = String(p.engineer || "").trim() || "-";
            const purposeUpper = String(p.issueType || p.purpose || "")
              .trim()
              .toUpperCase();
            const cust =
              purposeUpper === "IN LEAVE" ? "IN LEAVE" : customerFromPlan(p);
            if (!map.has(eng))
              map.set(eng, new Map(customers.map((c) => [c, 0])));
            const row = map.get(eng);
            row.set(cust, (row.get(cust) || 0) + 1);
          });
          const rows = Array.from(map.entries()).sort((a, b) =>
            a[0].localeCompare(b[0])
          );
          const totals = new Map(customers.map((c) => [c, 0]));
          rows.forEach(([_, row]) => {
            customers.forEach((c) =>
              totals.set(c, totals.get(c) + (row.get(c) || 0))
            );
          });
          const grandTotal = customers
            .filter((c) => c !== "IN LEAVE")
            .reduce((s, c) => s + (totals.get(c) || 0), 0);

          // Build aggregated sheet (Sheet1)
          const aggHeader = ["Engineer", ...customers, "Total"];
          const aggRows = rows.map(([eng, row]) => {
            const total = customers
              .filter((c) => c !== "IN LEAVE")
              .reduce((s, c) => s + (row.get(c) || 0), 0);
            const cells = customers.map((c) => row.get(c) || 0);
            return {
              Engineer: eng,
              ...Object.fromEntries(customers.map((c, i) => [c, cells[i]])),
              Total: total,
            };
          });
          const totalObj = {
            Engineer: "Total",
            ...Object.fromEntries(
              customers.map((c) => [c, totals.get(c) || 0])
            ),
            Total: grandTotal,
          };
          const sheet1Data = [
            Object.fromEntries(aggHeader.map((h) => [h, h])),
            ...aggRows.map((r) => r),
            totalObj,
          ];

          // Build detail sheet (Sheet2)
          const detailRows = data.map((p) => {
            const purposeUpper = String(p.issueType || p.purpose || "")
              .trim()
              .toUpperCase();
            const cust =
              purposeUpper === "IN LEAVE" ? "IN LEAVE" : customerFromPlan(p);
            const totalEligible = cust !== "IN LEAVE";
            return {
              Date: String(p.date || "").slice(0, 10),
              Engineer: p.engineer || "",
              ROCode: p.roCode || "",
              ROName: p.roName || "",
              Phase: p.phase || "",
              IssueType: p.issueType || p.purpose || "",
              Customer: cust,
              CountsTowardsTotal: totalEligible ? "Yes" : "No",
            };
          });

          // Create workbook with two sheets
          const wb = XLSX.utils.book_new();
          const ws1 = XLSX.utils.json_to_sheet(sheet1Data, {
            skipHeader: true,
          });
          const ws2 = XLSX.utils.json_to_sheet(detailRows);
          XLSX.utils.book_append_sheet(wb, ws1, "Engineer Monthly");
          XLSX.utils.book_append_sheet(wb, ws2, "Detail Rows");
          XLSX.writeFile(wb, `engineer_monthly_${ym}.xlsx`);
        } catch (e) {
          console.error("export csv error", e);
        }
      }

      // AMC Visit Status Functions
      async function loadAMCVisitStatus() {
        try {
          const startDate = document.getElementById("amcStartDate").value;
          const endDate = document.getElementById("amcEndDate").value;

          if (!startDate || !endDate) {
            alert("Please select both start and end dates");
            return;
          }

          const token = localStorage.getItem("token");
          if (!token) {
            console.error("No token found");
            return;
          }

          const response = await fetch(
            `${baseUrl}/romaster/amcCountStatus?startDate=${startDate}&endDate=${endDate}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              credentials: "include",
            }
          );

          if (!response.ok) {
            console.error("Error fetching AMC status:", response.status);
            return;
          }

          const result = await response.json();

          // Get logged in user info
          const userRes = await fetch(`${baseUrl}/user`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const currentUser = await userRes.json();

          // Store for CSV export
          window.__amcDetailedData = result.detailedData || [];

          // Render table with role-based filter
          renderAMCVisitStatus(result.data, currentUser);
        } catch (error) {
          console.error("Error loading AMC visit status:", error);
        }
      }

      function renderAMCVisitStatus(data, currentUser) {
        const tbody = document.getElementById("amcVisitStatusBody");
        if (!tbody) return;

        if (!data || data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="px-3 py-2 text-center text-black dark:text-gray-400">No data available</td></tr>';
          return;
        }

        const role = String(currentUser.role || "").toLowerCase();
        const currentEngineer = (
          currentUser.engineerName ||
          currentUser.username ||
          ""
        ).trim();

        // Filter out unwanted + role-based filter
        let filteredData = data.filter(
          (item) => item.engineerName !== "NAVAL KISHOR PANDEY"
        );

        if (role === "engineer" && currentEngineer) {
          filteredData = filteredData.filter(
            (item) =>
              String(item.engineerName || "").toLowerCase() ===
              currentEngineer.toLowerCase()
          );
        }

        // Sort by engineer name
        filteredData.sort((a, b) =>
          a.engineerName.localeCompare(b.engineerName)
        );

        let totalAssigned = 0;
        let totalCompleted = 0;
        let totalPending = 0;

        tbody.innerHTML = filteredData
          .map((item) => {
            totalAssigned += item.totalAMCAssigned;
            totalCompleted += item.totalAMCCompleted;
            totalPending += item.pendingAMC;

            const completionPct =
              item.totalAMCAssigned > 0
                ? ((item.totalCompleted / item.totalAMCAssigned) * 100).toFixed(
                    2
                  )
                : "0.00";

            return `
        <tr class="border-b">
          <td class="px-3 py-2 font-medium text-black dark:text-gray-200">${item.engineerName}</td>
          <td class="px-3 py-2 text-black dark:text-gray-200">${item.totalAMCAssigned}</td>
          <td class="px-3 py-2 text-black dark:text-gray-200">${item.totalAMCCompleted}</td>
          <td class="px-3 py-2 text-black dark:text-gray-200">${item.pendingAMC}</td>
           <td class="px-3 py-2 text-black dark:text-gray-200">${completionPct}%</td>
        </tr>
      `;
          })
          .join("");

        // Add total row only if Admin (Engineer should not see overall totals)
        if (role === "admin") {
          const totalPct =
            totalAssigned > 0
              ? ((totalCompleted / totalAssigned) * 100).toFixed(2)
              : "0.00";
          tbody.innerHTML += `
      <tr class="border-t bg-gray-50">
        <td class="px-3 py-2 font-bold text-black dark:text-gray-200">Total</td>
        <td class="px-3 py-2 font-bold text-black dark:text-gray-200">${totalAssigned}</td>
        <td class="px-3 py-2 font-bold text-black dark:text-gray-200">${totalCompleted}</td>
        <td class="px-3 py-2 font-bold text-black dark:text-gray-200">${totalPending}</td>
        <td class="px-3 py-2 font-bold text-black dark:text-gray-200">${totalPct}%</td>
      </tr>
    `;
        }
      }

      async function exportAMCVisitStatusCSV() {
        try {
          const detailedData = window.__amcDetailedData || [];

          if (detailedData.length === 0) {
            alert("No data available for export. Please load AMC data first.");
            return;
          }

          // Get logged-in user info
          const token = localStorage.getItem("token");
          if (!token) {
            alert("User not logged in.");
            return;
          }

          const userRes = await fetch(`${baseUrl}/user`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const currentUser = await userRes.json();

          const role = String(currentUser.role || "").toLowerCase();
          const currentEngineer = (
            currentUser.engineerName ||
            currentUser.username ||
            ""
          ).trim();

          // Filter out NAVAL KISHOR PANDEY
          let filteredData = detailedData.filter(
            (item) => item.engineerName !== "NAVAL KISHOR PANDEY"
          );

          // 🔑 Role-based filter: engineers only get their own data
          if (role === "engineer" && currentEngineer) {
            filteredData = filteredData.filter(
              (item) =>
                String(item.engineerName || "").toLowerCase() ===
                currentEngineer.toLowerCase()
            );
          }

          if (filteredData.length === 0) {
            alert("No AMC records available for your role.");
            return;
          }

          // Sort by engineer name, then by RO code
          filteredData.sort((a, b) => {
            if (a.engineerName !== b.engineerName) {
              return a.engineerName.localeCompare(b.engineerName);
            }
            return a.roCode.localeCompare(b.roCode);
          });

          // Prepare CSV rows
          const rows = [];
          const header = [
            "Engineer Name",
            "RO Code",
            "RO Name",
            "Region",
            "Phase",
            "Purpose of Visit",
            "AMC Status",
            "Visit Date",
            "AMC QTR",
            "Issue Type",
            "Site Active Status",
          ];
          rows.push(header);

          filteredData.forEach((item) => {
            const rowData = [
              item.engineerName,
              item.roCode,
              item.roName,
              item.region,
              item.phase,
              item.purpose,
              item.amcStatus,
              item.visitDate,
              item.amcQtr,
              item.issueType,
              item.siteActivestatus,
            ];
            rows.push(rowData);
          });

          // Generate CSV
          const csvContent = rows.map((row) => row.join(",")).join("\n");
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = `amc_visit_detailed_status_${new Date().toLocaleDateString(
            "en-CA"
          )}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error("Error exporting AMC visit status CSV:", error);
        }
      }

      loadOverview();
    </script>
  </body>
</html>
