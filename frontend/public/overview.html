<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Overview</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      body { font-family: "Poppins", sans-serif; background:#f1f5f9; font-size:12px; }
    </style>
  </head>
  <body class="p-4">
    <section class="space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-800">Dashboard Overview</h2>
        <div id="lastUpdated" class="text-xs text-gray-500">—</div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="bg-white rounded-xl shadow p-4 flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-green-100 text-green-700 flex items-center justify-center">
            <i class="fa-solid fa-calendar-check"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">Plans Today</div>
            <div id="kpiPlansToday" class="text-xl font-semibold">—</div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4 flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center">
            <i class="fa-solid fa-triangle-exclamation"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">Unverified Status</div>
            <div id="kpiUnverified" class="text-xl font-semibold">—</div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4 flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-red-100 text-red-700 flex items-center justify-center">
            <i class="fa-solid fa-bell"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">Open Incidents</div>
            <div id="kpiOpenIncidents" class="text-xl font-semibold">—</div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4 flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center">
            <i class="fa-solid fa-user-check"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">Active Users Today</div>
            <div id="kpiActiveUsers" class="text-xl font-semibold">—</div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="bg-white rounded-xl shadow p-4">
          <div class="text-sm font-semibold text-gray-700 mb-2">Verification Split</div>
          <canvas id="chartVerify" height="160"></canvas>
        </div>
        <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
          <div class="text-sm font-semibold text-gray-700 mb-2">Plans by Region (Today)</div>
          <canvas id="chartPlansRegion" height="80"></canvas>
        </div>
      </div>

      <!-- Customer-wise visits -->
      <div class="bg-white rounded-xl shadow p-4">
        <div class="text-sm font-semibold text-gray-700 mb-2">Customer-wise Visits (Today)</div>
        <canvas id="chartCustomer" height="80"></canvas>
        <div id="customerCards" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3 mt-3"></div>
      </div>

      <!-- Engineer Monthly Visits by Customer -->
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold text-gray-700">Engineer Monthly Visits by Customer</div>
          <div class="flex items-center gap-2">
            <label for="monthSelect" class="text-xs text-gray-500">Select Month</label>
            <select id="monthSelect" class="border rounded px-2 py-1 text-xs"></select>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left">Engineer</th>
                <th class="px-3 py-2 text-left">HPCL</th>
                <th class="px-3 py-2 text-left">RBML</th>
                <th class="px-3 py-2 text-left">BPCL</th>
                <th class="px-3 py-2 text-left">NPL</th>
                <th class="px-3 py-2 text-left">JIO BP</th>
                <th class="px-3 py-2 text-left">OTHER</th>
                <th class="px-3 py-2 text-left">Total</th>
              </tr>
            </thead>
            <tbody id="engMonthBody" class="text-sm"></tbody>
          </table>
        </div>
      </div>

      <div id="recentLoginsCard" class="bg-white rounded-xl shadow p-4">
        <div class="text-sm font-semibold text-gray-700 mb-2">Recent Logins</div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left">User</th>
                <th class="px-3 py-2 text-left">Time</th>
                <th class="px-3 py-2 text-left">IP</th>
              </tr>
            </thead>
            <tbody id="recentLogins" class="text-sm"></tbody>
          </table>
        </div>
      </div>
    </section>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      function getToken(){ return localStorage.getItem("token"); }

      async function loadOverview(){
        try{
          const token = getToken();
          const headers = { Authorization: `Bearer ${token}` };

          const [userRes, plansRes, statusRes, jioRes, incidentRes, loginLogsRes] = await Promise.all([
            fetch(`${baseUrl}/user`, { headers }),
            fetch(`${baseUrl}/getDailyPlans`, { headers }),
            fetch(`${baseUrl}/getMergedStatusRecords`, { headers }),
            fetch(`${baseUrl}/jioBP/getAllJioBPStatus`, { headers }),
            fetch(`${baseUrl}/getAllIncidents`, { headers }),
            fetch(`${baseUrl}/audit/loginLogs`, { headers }),
          ]);

          const currentUser = await userRes.json();
          const plans = await plansRes.json();
          const hpcl = await statusRes.json();
          const jio = await jioRes.json();
          const incJson = await incidentRes.json();
          const loginLogs = await loginLogsRes.json();

          const today = new Date().toISOString().slice(0,10);
          const plansToday = (Array.isArray(plans)?plans:[]).filter(p => {
            const isToday = (p.date||"").slice(0,10)===today;
            const purpose = String(p.purpose||"").trim().toUpperCase();
            const isNoPlanOrLeave = purpose === "NO PLAN" || purpose === "IN LEAVE";
            return isToday && !isNoPlanOrLeave;
          });
          const unverifiedHpcl = (Array.isArray(hpcl)?hpcl:[]).filter(r => String(r.isVerified).toLowerCase()!=="true");
          const unverifiedJio = (Array.isArray(jio)?jio:[]).filter(r => String(r.isVerified).toLowerCase()!=="true");
          const openIncidents = (incJson?.incidents||[]).filter(i => (i.status||"").toLowerCase()!=="close");
          const activeUsernames = new Set((Array.isArray(loginLogs)?loginLogs:[])
            .filter(l => (l.loginTime && new Date(l.loginTime)).toDateString()===new Date().toDateString())
            .map(l => l.engineerName || l.username));

          document.getElementById('kpiPlansToday').textContent = plansToday.length;
          document.getElementById('kpiUnverified').textContent = unverifiedHpcl.length + unverifiedJio.length;
          document.getElementById('kpiOpenIncidents').textContent = openIncidents.length;
          document.getElementById('kpiActiveUsers').textContent = activeUsernames.size;
          document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

          // Show/hide Recent Logins card based on role
          const recentCard = document.getElementById('recentLoginsCard');
          if (recentCard) {
            recentCard.style.display = (String(currentUser.role||'').toLowerCase()==='admin') ? '' : 'none';
          }

          // Recent logins
          const tbody = document.getElementById('recentLogins');
          const filteredLogins = (Array.isArray(loginLogs)?loginLogs:[])
            .filter(l => String(l.role||'').toLowerCase() !== 'engineer')
            .slice(0, 8);
          tbody.innerHTML = filteredLogins.map(l => `
            <tr class="border-b">
              <td class="px-3 py-2">${l.engineerName || l.username} <span class="text-[10px] text-gray-500">(${l.role || ''})</span></td>
              <td class="px-3 py-2">${l.loginTime ? new Date(l.loginTime).toLocaleString() : ''}</td>
              <td class="px-3 py-2">${l.ip || ''}</td>
            </tr>
          `).join('');

          // Verification Split chart role-based
          const userRole = String(currentUser.role||'').toLowerCase();
          const uname = String(currentUser.engineerName || currentUser.username || '').trim().toLowerCase();
          const mineHpcl = (Array.isArray(hpcl)?hpcl:[]).filter(r => String(r.engineer||'').trim().toLowerCase() === uname);
          const mineJio = (Array.isArray(jio)?jio:[]).filter(r => String(r.engineer||'').trim().toLowerCase() === uname);
          const myTotal = mineHpcl.length + mineJio.length;
          const myUnverified = mineHpcl.filter(r => String(r.isVerified).toLowerCase()!== 'true').length +
                               mineJio.filter(r => String(r.isVerified).toLowerCase()!== 'true').length;

          const allUnverified = unverifiedHpcl.length + unverifiedJio.length;
          const allTotal = (Array.isArray(hpcl)?hpcl.length:0) + (Array.isArray(jio)?jio.length:0);

          const chartUnverified = userRole === 'admin' ? allUnverified : myUnverified;
          const chartVerified = userRole === 'admin' ? (allTotal - allUnverified) : (myTotal - myUnverified);

          renderVerifyChart(chartUnverified, chartVerified);
          renderPlansRegionChart(plansToday);
          renderCustomerChart(plansToday);

          // Customer cards
          const customerCounts = new Map();
          (plansToday||[]).forEach(p=>{
            const cust = customerFromPlan(p);
            customerCounts.set(cust,(customerCounts.get(cust)||0)+1);
          });
          renderCustomerCards(customerCounts);

          // Engineer monthly by customer (dropdown + table)
          window.__allPlans = Array.isArray(plans) ? plans : [];
          buildMonthDropdown(window.__allPlans);
          const sel = document.getElementById('monthSelect');
          renderEngineerMonthly(window.__allPlans, sel.value);
          sel.addEventListener('change', ()=>{
            renderEngineerMonthly(window.__allPlans, sel.value);
          });
        }catch(e){ console.error('overview load error', e); }
      }

      function renderVerifyChart(unverified, verified){
        const ctx = document.getElementById('chartVerify');
        if(!ctx) return;
        new Chart(ctx, { type:'doughnut', data:{ labels:['Unverified','Verified'], datasets:[{ data:[unverified, verified], backgroundColor:['#f59e0b','#16a34a'] }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } } });
      }
      function renderPlansRegionChart(plans){
        const ctx = document.getElementById('chartPlansRegion');
        if(!ctx) return;
        const counts = new Map();
        (plans||[]).forEach(p=>{ const r=(p.region||'').toUpperCase(); counts.set(r,(counts.get(r)||0)+1); });
        const labels = Array.from(counts.keys());
        const data = labels.map(l=>counts.get(l));
        new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Plans', data, backgroundColor:'#60a5fa' }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } } });
      }

      function customerFromPlan(p){
        const ph = String(p.phase||'').toUpperCase();
        if (ph.startsWith('HPCL')) return 'HPCL';
        if (ph.includes('RBML')) return 'RBML';
        if (ph.includes('BPCL')) return 'BPCL';
        if (ph.includes('NPL')) return 'NPL';
        if (ph.includes('JIO')) return 'JIO BP';
        return 'OTHER';
      }

      function renderCustomerChart(plans){
        const ctx = document.getElementById('chartCustomer');
        if(!ctx) return;
        const counts = new Map();
        const labelColorMap = new Map([
          ["HPCL", "#16a34a"],
          ["RBML", "#f59e0b"],
          ["BPCL", "#60a5fa"],
          ["NPL", "#34d399"],
          ["JIO BP", "#a78bfa"],
          ["OTHER", "#9ca3af"],
        ]);

        (plans||[]).forEach(p=>{
          const cust = customerFromPlan(p);
          counts.set(cust, (counts.get(cust)||0)+1);
        });

        const labels = Array.from(counts.keys());
        const data = labels.map(l=>counts.get(l));
        const colors = labels.map(l=>labelColorMap.get(l) || "#9ca3af");

        new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Visits', data, backgroundColor: colors }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } } });
      }

      function renderCustomerCards(counts){
        const container = document.getElementById('customerCards');
        if(!container) return;
        const color = (label)=>({
          'HPCL':'#16a34a', 'RBML':'#f59e0b', 'BPCL':'#60a5fa', 'NPL':'#34d399', 'JIO BP':'#a78bfa', 'OTHER':'#9ca3af'
        })[label] || '#9ca3af';

        const items = Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]);
        container.innerHTML = items.map(([label,count])=>`
          <div class="rounded-lg border bg-white p-3 flex items-center gap-3 shadow-sm">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white" style="background:${color(label)}">${label.split(' ')[0][0]}</div>
            <div>
              <div class="text-[11px] text-gray-500">${label}</div>
              <div class="text-lg font-semibold">${count}</div>
            </div>
          </div>
        `).join('');
      }

      // ===== Monthly Engineer x Customer table =====
      function ymKey(d){
        try{ return new Date(d).toISOString().slice(0,7); }catch{ return ''; }
      }
      function buildMonthDropdown(plans){
        const sel = document.getElementById('monthSelect');
        if(!sel) return;
        const keys = new Set((plans||[]).map(p=>ymKey(p.date)).filter(Boolean));
        // Fallback: include current month if none
        if(keys.size===0){ keys.add(new Date().toISOString().slice(0,7)); }
        const sorted = Array.from(keys).sort().reverse();
        sel.innerHTML = sorted.map(k=>{
          const [y,m] = k.split('-');
          const dt = new Date(`${k}-01T00:00:00`);
          const label = dt.toLocaleString('en-US', { month:'long', year:'numeric' });
          return `<option value="${k}">${label}</option>`;
        }).join('');
      }
      function renderEngineerMonthly(plans, ym){
        const body = document.getElementById('engMonthBody');
        if(!body) return;
        const data = (plans||[]).filter(p=>{
          if(ymKey(p.date)!==ym) return false;
          const purpose = String(p.purpose||'').trim().toUpperCase();
          if(purpose==='NO PLAN' || purpose==='IN LEAVE') return false;
          return true;
        });

        // Aggregate: engineer -> customer -> count
        const map = new Map();
        const customers = ['HPCL','RBML','BPCL','NPL','JIO BP','OTHER'];
        data.forEach(p=>{
          const eng = String(p.engineer||'').trim() || '-';
          const cust = customerFromPlan(p);
          if(!map.has(eng)) map.set(eng, new Map(customers.map(c=>[c,0])));
          const row = map.get(eng);
          row.set(cust, (row.get(cust)||0)+1);
        });

        const rows = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        body.innerHTML = rows.map(([eng,row])=>{
          const cells = customers.map(c=>`<td class="px-3 py-2">${row.get(c)||0}</td>`).join('');
          const total = customers.reduce((s,c)=>s+(row.get(c)||0),0);
          return `<tr class="border-b"><td class="px-3 py-2 font-medium">${eng}</td>${cells}<td class="px-3 py-2 font-semibold">${total}</td></tr>`;
        }).join('');
      }

      loadOverview();
    </script>
  </body>
</html>