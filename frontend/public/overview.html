<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Overview</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #f1f5f9;
        font-size: 12px;
      }
      /* Show CSV icon only on hover over KPI cards (admin only buttons remain hidden for non-admin via JS) */
      .kpi-card .kpi-export {
        opacity: 0;
        visibility: hidden;
        transform: translateY(2px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .kpi-card:hover .kpi-export {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      /* Icon color tuning */
      .kpi-export i {
        color: #2563eb;
      }
      .dark .kpi-export,
      .dark .kpi-export i {
        color: var(--accent) !important;
      }
    </style>
  </head>
  <body class="p-4">
    <section class="space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-800">Dashboard Overview</h2>
        <div id="lastUpdated" class="text-xs text-gray-500">—</div>
      </div>

      

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
        <div
          class="bg-white rounded-xl shadow p-4 flex items-center gap-3 kpi-card"
        >
          <div
            class="w-10 h-10 rounded-full bg-green-100 text-green-700 flex items-center justify-center"
          >
            <i class="fa-solid fa-calendar-check"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">Plans Today</div>
            <div class="flex items-center gap-2">
              <div id="kpiPlansToday" class="text-xl font-semibold">—</div>
              <button
                id="exportPlansToday"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Hold Engineers (NO PLAN + IN LEAVE) -->
        <div
          id="holdEngineersCard"
          class="bg-white rounded-xl shadow p-4 flex items-center gap-3 kpi-card"
        >
          <div
            class="w-10 h-10 rounded-full bg-gray-100 text-gray-700 flex items-center justify-center"
          >
            <i class="fa-solid fa-user-slash"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">Hold Engineers</div>
            <div class="flex items-center gap-2">
              <div id="kpiHold" class="text-xl font-semibold">—</div>
              <button
                id="exportHold"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
            <div id="kpiHoldBreakdown" class="text-[10px] text-gray-500">—</div>
          </div>
        </div>

        <div
          class="bg-white rounded-xl shadow p-4 flex items-center gap-3 kpi-card"
        >
          <div
            class="w-10 h-10 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center"
          >
            <i class="fa-solid fa-triangle-exclamation"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">Unverified Status</div>
            <div class="flex items-center gap-2">
              <div id="kpiUnverified" class="text-xl font-semibold">—</div>
              <button
                id="exportUnverified"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
          </div>
        </div>

        <div
          class="bg-white rounded-xl shadow p-4 flex items-center gap-3 kpi-card"
        >
          <div
            class="w-10 h-10 rounded-full bg-red-100 text-red-700 flex items-center justify-center"
          >
            <i class="fa-solid fa-bell"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">Open Incidents</div>
            <div class="flex items-center gap-2">
              <div id="kpiOpenIncidents" class="text-xl font-semibold">—</div>
              <button
                id="exportOpenInc"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Today Pending Status (HPCL + RBML) -->
        <div
          class="bg-white rounded-xl shadow p-4 flex items-center gap-3 kpi-card"
        >
          <div
            class="w-10 h-10 rounded-full bg-teal-100 text-teal-700 flex items-center justify-center"
          >
            <i class="fa-solid fa-hourglass-half"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">
              Status Pending (HPCL + RBML)
            </div>
            <div class="flex items-center gap-2">
              <div id="kpiPendingToday" class="text-xl font-semibold">—</div>
              <button
                id="exportPending"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
            <div id="kpiPendingBreakdown" class="text-[10px] text-gray-500">
              —
            </div>
          </div>
        </div>

        <div
          class="bg-white rounded-xl shadow p-4 flex items-center gap-3 kpi-card"
        >
          <div
            class="w-10 h-10 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center"
          >
            <i class="fa-solid fa-user-check"></i>
          </div>
          <div>
            <div class="text-xs text-gray-500">Active Users Today</div>
            <div class="flex items-center gap-2">
              <div id="kpiActiveUsers" class="text-xl font-semibold">—</div>
              <button
                id="exportActiveUsers"
                class="text-[10px] text-blue-600 kpi-export"
                title="Export CSV"
              >
                <i class="fa-solid fa-download text-[11px]"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="bg-white rounded-xl shadow p-4">
          <div class="text-sm font-semibold text-gray-700 mb-2">
            Verification Split
          </div>
          <canvas id="chartVerify" height="160"></canvas>
        </div>
        <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
          <div class="text-sm font-semibold text-gray-700 mb-2">
            Plans by Region (Today)
          </div>
          <canvas id="chartPlansRegion" height="80"></canvas>
        </div>
      </div>

      <!-- RELCON Connectivity Provided (All Time) -->
      <div id="relconConnectivityCard" class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-sm font-semibold text-gray-700">
              RELCON Connectivity Provided (All Time)
            </div>
            <div id="relconOverallCount" class="text-xs text-gray-500 mt-1">Total RELCON Connectivity Sites: <span class="font-semibold">0</span></div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="exportRelconConnectivityCSV()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow">
              Export CSV
            </button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead class="bg-gray-50">
              <tr id="relconConnectivityHeader">
                <th class="px-3 py-2 text-left">Region</th>
              </tr>
            </thead>
            <tbody id="relconConnectivityBody" class="text-sm"></tbody>
          </table>
        </div>
      </div>

      <!-- Power Protection PCB Installation Status (All Time) -->
      <div id="pcbInstallationCard" class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold text-gray-700">
            Power Protection PCB Installation Status (All Time)
          </div>
          <div class="flex items-center gap-2">
            <button onclick="exportPcbInstallationCSV()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow">
              Export CSV
            </button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left">Engineer Name</th>
                <th class="px-3 py-2 text-left">Region</th>
                <th class="px-3 py-2 text-left">Total PCB Provided (A)</th>
                <th class="px-3 py-2 text-left">Total PCB Install (B)</th>
                <th class="px-3 py-2 text-left">Total PCB Installation Pending</th>
              </tr>
            </thead>
            <tbody id="pcbInstallationBody" class="text-sm"></tbody>
          </table>
          <div class="flex justify-end mt-2">
            <button id="savePcbProvidedBtn" onclick="savePcbProvidedCounts()" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs shadow">Save</button>
          </div>
        </div>
      </div>

      <!-- Customer-wise visits -->
      <div class="bg-white rounded-xl shadow p-4">
        <div class="text-sm font-semibold text-gray-700 mb-2">
          Customer-wise Visits (Today)
        </div>
        <canvas id="chartCustomer" height="80"></canvas>
        <div
          id="customerCards"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3 mt-3"
        ></div>
      </div>

      <!-- Engineer Monthly Visits by Customer -->
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold text-gray-700">
            Engineer Monthly Visits by Customer
          </div>
          <div class="flex items-center gap-2">
            <button id="exportEngMonth" onclick="exportEngineerMonthlyCSV()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow">
              Export Excel
            </button>
            <label for="monthSelect" class="text-xs text-gray-500"
              >Select Month</label
            >
            <select
              id="monthSelect"
              class="border rounded px-2 py-1 text-xs"
            ></select>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left">Engineer</th>
                <th class="px-3 py-2 text-left">HPCL</th>
                <th class="px-3 py-2 text-left">RBML</th>
                <th class="px-3 py-2 text-left">BPCL</th>
                <th class="px-3 py-2 text-left">NPL</th>
                <th class="px-3 py-2 text-left">OTHER</th>
                <th class="px-3 py-2 text-left">IN LEAVE</th>
                <th class="px-3 py-2 text-left">Total</th>
              </tr>
            </thead>
            <tbody id="engMonthBody" class="text-sm"></tbody>
          </table>
        </div>
      </div>

      <div id="recentLoginsCard" class="bg-white rounded-xl shadow p-4">
        <div class="text-sm font-semibold text-gray-700 mb-2">
          Recent Logins
        </div>
        <div class="overflow-auto">
          <table class="min-w-max w-full table-auto">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left">User</th>
                <th class="px-3 py-2 text-left">Time</th>
                <th class="px-3 py-2 text-left">IP</th>
              </tr>
            </thead>
            <tbody id="recentLogins" class="text-sm"></tbody>
          </table>
        </div>
      </div>
    </section>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      function getToken() {
        return localStorage.getItem("token");
      }

      async function loadOverview() {
        try {
          const token = getToken();
          const headers = { Authorization: `Bearer ${token}` };

          const [
            userRes,
            plansRes,
            statusRes,
            jioRes,
            incidentRes,
            loginLogsRes,
          ] = await Promise.all([
            fetch(`${baseUrl}/user`, { headers }),
            fetch(`${baseUrl}/getDailyPlans`, { headers }),
            fetch(`${baseUrl}/getMergedStatusRecords`, { headers }),
            fetch(`${baseUrl}/jioBP/getAllJioBPStatus`, { headers }),
            fetch(`${baseUrl}/getAllIncidents`, { headers }),
            fetch(`${baseUrl}/audit/loginLogs`, { headers }),
          ]);

          const currentUser = await userRes.json();
          const plans = await plansRes.json();
          const hpcl = await statusRes.json();
          const jio = await jioRes.json();
          const incJson = await incidentRes.json();
          const loginLogs = await loginLogsRes.json();

          const today = new Date().toISOString().slice(0, 10);
          const plansToday = (Array.isArray(plans) ? plans : []).filter((p) => {
            const isToday = String(p.date || "").slice(0, 10) === today;
            const purpose = String(p.purpose || "")
              .trim()
              .toUpperCase();
            const isNoPlanOrLeave =
              purpose === "NO PLAN" || purpose === "IN LEAVE";
            return isToday && !isNoPlanOrLeave;
          });
          const holdToday = (Array.isArray(plans) ? plans : []).filter((p) => {
            const isToday = String(p.date || "").slice(0, 10) === today;
            const purpose = String(p.purpose || "")
              .trim()
              .toUpperCase();
            return isToday && (purpose === "NO PLAN" || purpose === "IN LEAVE");
          });
          const noPlanCount = holdToday.filter(
            (p) =>
              String(p.purpose || "")
                .trim()
                .toUpperCase() === "NO PLAN"
          ).length;
          const inLeaveCount = holdToday.filter(
            (p) =>
              String(p.purpose || "")
                .trim()
                .toUpperCase() === "IN LEAVE"
          ).length;
          const unverifiedHpcl = (Array.isArray(hpcl) ? hpcl : []).filter(
            (r) => String(r.isVerified).toLowerCase() !== "true"
          );
          const unverifiedJio = (Array.isArray(jio) ? jio : []).filter(
            (r) => String(r.isVerified).toLowerCase() !== "true"
          );
          const openIncidents = (incJson?.incidents || []).filter(
            (i) => (i.status || "").toLowerCase() !== "close"
          );
          const activeUsernames = new Set(
            (Array.isArray(loginLogs) ? loginLogs : [])
              .filter(
                (l) =>
                  (l.loginTime && new Date(l.loginTime)).toDateString() ===
                  new Date().toDateString()
              )
              .map((l) => l.engineerName || l.username)
          );

          document.getElementById("kpiPlansToday").textContent =
            plansToday.length;
          document.getElementById("kpiUnverified").textContent =
            unverifiedHpcl.length + unverifiedJio.length;
          document.getElementById("kpiOpenIncidents").textContent =
            openIncidents.length;
          // Today Pending (HPCL + RBML) = Today's plans minus submitted statuses from their respective sources
          const key = (rc, d) =>
            `${String(rc || "")
              .trim()
              .toUpperCase()}-${String(d || "").slice(0, 10)}`;
          const plansTodayHpcl = (plansToday || []).filter((p) =>
            String(p.phase || "")
              .toUpperCase()
              .startsWith("HPCL")
          );
          const plansTodayRbml = (plansToday || []).filter((p) =>
            String(p.phase || "")
              .toUpperCase()
              .includes("RBML")
          );

          const hpclStatusTodaySet = new Set(
            (Array.isArray(hpcl) ? hpcl : [])
              .filter((r) =>
                String(r.phase || "")
                  .toUpperCase()
                  .startsWith("HPCL")
              )
              .filter(
                (r) =>
                  String(r.date || r.uploadDate || "").slice(0, 10) === today
              )
              .map((r) => key(r.roCode, r.date || r.uploadDate))
          );
          const rbmlStatusTodaySet = new Set(
            (Array.isArray(jio) ? jio : [])
              .filter((r) => String(r.date || "").slice(0, 10) === today)
              .map((r) => key(r.roCode, r.date))
          );

          const pendingTodayHpcl = plansTodayHpcl.filter(
            (p) => !hpclStatusTodaySet.has(key(p.roCode, p.date))
          ).length;
          const pendingTodayRbml = plansTodayRbml.filter(
            (p) => !rbmlStatusTodaySet.has(key(p.roCode, p.date))
          ).length;
          document.getElementById("kpiPendingToday").textContent =
            pendingTodayHpcl + pendingTodayRbml;
          document.getElementById(
            "kpiPendingBreakdown"
          ).textContent = `HPCL: ${pendingTodayHpcl} • RBML: ${pendingTodayRbml}`;
          document.getElementById("kpiActiveUsers").textContent =
            activeUsernames.size;
          document.getElementById("kpiHold").textContent = holdToday.length;
          document.getElementById(
            "kpiHoldBreakdown"
          ).textContent = `NO PLAN: ${noPlanCount} • IN LEAVE: ${inLeaveCount}`;
          document.getElementById("lastUpdated").textContent =
            new Date().toLocaleString();

          // CSV exports for KPI cards
          const exportCSV = (rows, headers, filename) => {
            try {
              const csvHeader = headers.join(",") + "\n";
              const csvRows = rows
                .map((r) =>
                  headers.map((h) => JSON.stringify(r[h] ?? "")).join(",")
                )
                .join("\n");
              const blob = new Blob([csvHeader + csvRows], {
                type: "text/csv;charset=utf-8;",
              });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            } catch (e) {
              console.error("CSV export failed", e);
            }
          };

          // Build exportable datasets
          const plansTodayRows = plansToday.map((p) => ({
            date: String(p.date || "").slice(0, 10),
            engineer: p.engineer || "",
            roCode: p.roCode || "",
            roName: p.roName || "",
            region: p.region || "",
            phase: p.phase || "",
            purpose: p.purpose || "",
          }));
          const unverifiedRows = [
            ...(unverifiedHpcl || []).map((r) => ({
              source: "HPCL",
              date: String(r.date || r.uploadDate || "").slice(0, 10),
              engineer: r.engineer || "",
              roCode: r.roCode || "",
              roName: r.roName || "",
              region: r.region || "",
              phase: r.phase || "",
              status: String(r.isVerified),
            })),
            ...(unverifiedJio || []).map((r) => ({
              source: "RBML/JIO",
              date: String(r.date || "").slice(0, 10),
              engineer: r.engineer || "",
              roCode: r.roCode || "",
              roName: r.roName || "",
              region: r.region || "",
              phase: r.phase || "",
              status: String(r.isVerified),
            })),
          ];
          const openIncRows = (incJson?.incidents || [])
            .filter((i) => (i.status || "").toLowerCase() !== "close")
            .map((i) => ({
              incidentId: i.incidentId || "",
              roCode: i.roCode || "",
              siteName: i.siteName || "",
              region: i.region || "",
              status: i.status || "",
            }));
          const activeUserRows = Array.from(activeUsernames).map((name) => ({
            user: name,
          }));
          const holdRows = holdToday.map((p) => ({
            date: String(p.date || "").slice(0, 10),
            engineer: p.engineer || "",
            roCode: p.roCode || "",
            roName: p.roName || "",
            purpose: p.purpose || "",
          }));
          const pendingRows = [
            ...plansTodayHpcl
              .filter(
                (p) =>
                  !hpclStatusTodaySet.has(
                    `${String(p.roCode || "")
                      .trim()
                      .toUpperCase()}-${String(p.date || "").slice(0, 10)}`
                  )
              )
              .map((p) => ({
                customer: "HPCL",
                date: String(p.date || "").slice(0, 10),
                roCode: p.roCode || "",
                roName: p.roName || "",
                region: p.region || "",
                engineer: p.engineer || "",
              })),
            ...plansTodayRbml
              .filter(
                (p) =>
                  !rbmlStatusTodaySet.has(
                    `${String(p.roCode || "")
                      .trim()
                      .toUpperCase()}-${String(p.date || "").slice(0, 10)}`
                  )
              )
              .map((p) => ({
                customer: "RBML",
                date: String(p.date || "").slice(0, 10),
                roCode: p.roCode || "",
                roName: p.roName || "",
                region: p.region || "",
              })),
          ];

          // Wire export buttons
          const byId = (id) => document.getElementById(id);
          byId("exportPlansToday")?.addEventListener("click", () =>
            exportCSV(
              plansTodayRows,
              [
                "date",
                "engineer",
                "roCode",
                "roName",
                "region",
                "phase",
                "purpose",
              ],
              "plans_today.csv"
            )
          );
          byId("exportUnverified")?.addEventListener("click", () =>
            exportCSV(
              unverifiedRows,
              [
                "source",
                "date",
                "engineer",
                "roCode",
                "roName",
                "region",
                "phase",
                "status",
              ],
              "unverified_status.csv"
            )
          );
          byId("exportOpenInc")?.addEventListener("click", () =>
            exportCSV(
              openIncRows,
              ["incidentId", "roCode", "siteName", "region", "status"],
              "open_incidents.csv"
            )
          );
          byId("exportActiveUsers")?.addEventListener("click", () =>
            exportCSV(activeUserRows, ["user"], "active_users_today.csv")
          );
          byId("exportHold")?.addEventListener("click", () =>
            exportCSV(
              holdRows,
              ["date", "engineer", "roCode", "roName", "purpose"],
              "hold_engineers_today.csv"
            )
          );
          byId("exportPending")?.addEventListener("click", () =>
            exportCSV(
              pendingRows,
              ["customer", "date", "roCode", "roName", "region", "engineer"],
              "status_pending.csv"
            )
          );

          // Show/hide cards based on role
          const recentCard = document.getElementById("recentLoginsCard");
          if (recentCard) {
            recentCard.style.display =
              String(currentUser.role || "").toLowerCase() === "admin"
                ? ""
                : "none";
          }
          const holdCard = document.getElementById("holdEngineersCard");
          if (holdCard) {
            holdCard.style.display =
              String(currentUser.role || "").toLowerCase() === "admin"
                ? ""
                : "none";
          }

          // Hide export CSV buttons for non-admin
          const isAdmin =
            String(currentUser.role || "").toLowerCase() === "admin";
          const exportIds = [
            "exportPlansToday",
            "exportUnverified",
            "exportOpenInc",
            "exportActiveUsers",
            "exportHold",
            "exportPending",
          ];
          if (!isAdmin) {
            exportIds.forEach((id) => {
              const el = document.getElementById(id);
              if (el) el.style.display = "none";
            });
          }

          // Recent logins
          const tbody = document.getElementById("recentLogins");
          const filteredLogins = (Array.isArray(loginLogs) ? loginLogs : [])
            .sort((a, b) => {
              const ta = a.loginTime ? new Date(a.loginTime).getTime() : 0;
              const tb = b.loginTime ? new Date(b.loginTime).getTime() : 0;
              return tb - ta;
            })
            .slice(0, 16);
          tbody.innerHTML = filteredLogins
            .map(
              (l) => `
            <tr class="border-b">
              <td class="px-3 py-2">${
                l.engineerName || l.username
              } <span class="text-[10px] text-gray-500">(${
                l.role || ""
              })</span></td>
              <td class="px-3 py-2">${
                l.loginTime ? new Date(l.loginTime).toLocaleString() : ""
              }</td>
              <td class="px-3 py-2">${l.ip || ""}</td>
            </tr>
          `
            )
            .join("");

          // Verification Split chart role-based
          const userRole = String(currentUser.role || "").toLowerCase();
          const uname = String(
            currentUser.engineerName || currentUser.username || ""
          )
            .trim()
            .toLowerCase();
          const mineHpcl = (Array.isArray(hpcl) ? hpcl : []).filter(
            (r) =>
              String(r.engineer || "")
                .trim()
                .toLowerCase() === uname
          );
          const mineJio = (Array.isArray(jio) ? jio : []).filter(
            (r) =>
              String(r.engineer || "")
                .trim()
                .toLowerCase() === uname
          );
          const myTotal = mineHpcl.length + mineJio.length;
          const myUnverified =
            mineHpcl.filter(
              (r) => String(r.isVerified).toLowerCase() !== "true"
            ).length +
            mineJio.filter((r) => String(r.isVerified).toLowerCase() !== "true")
              .length;

          const allUnverified = unverifiedHpcl.length + unverifiedJio.length;
          const allTotal =
            (Array.isArray(hpcl) ? hpcl.length : 0) +
            (Array.isArray(jio) ? jio.length : 0);

          const chartUnverified =
            userRole === "admin" ? allUnverified : myUnverified;
          const chartVerified =
            userRole === "admin"
              ? allTotal - allUnverified
              : myTotal - myUnverified;

          renderVerifyChart(chartUnverified, chartVerified);
          renderPlansRegionChart(plansToday);
          renderCustomerChart(plansToday);

          // Customer cards
          const customerCounts = new Map();
          (plansToday || []).forEach((p) => {
            const cust = customerFromPlan(p);
            customerCounts.set(cust, (customerCounts.get(cust) || 0) + 1);
          });
          renderCustomerCards(customerCounts);

          // Engineer monthly by customer (dropdown + table)
          window.__allPlans = Array.isArray(plans) ? plans : [];
          window.__statusRecords = Array.isArray(hpcl) ? hpcl : [];
          window.__currentUser = currentUser || {};
          buildMonthDropdown(window.__allPlans);
          const sel = document.getElementById("monthSelect");
          renderEngineerMonthly(window.__allPlans, sel.value);
          sel.addEventListener("change", () => {
            renderEngineerMonthly(window.__allPlans, sel.value);
          });

          // Render RELCON connectivity and PCB status (all-time from statusRecords)
          renderRelconConnectivity(window.__statusRecords);
          renderPcbInstallation(window.__statusRecords);
        } catch (e) {
          console.error("overview load error", e);
        }
      }

      function renderVerifyChart(unverified, verified) {
        const ctx = document.getElementById("chartVerify");
        if (!ctx) return;
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Unverified", "Verified"],
            datasets: [
              {
                data: [unverified, verified],
                backgroundColor: ["#f59e0b", "#16a34a"],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
          },
        });
      }
      function renderPlansRegionChart(plans) {
        const ctx = document.getElementById("chartPlansRegion");
        if (!ctx) return;
        const counts = new Map();
        (plans || []).forEach((p) => {
          const r = (p.region || "").toUpperCase();
          counts.set(r, (counts.get(r) || 0) + 1);
        });
        const labels = Array.from(counts.keys());
        const data = labels.map((l) => counts.get(l));
        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{ label: "Plans", data, backgroundColor: "#60a5fa" }],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
          },
        });
      }

      function customerFromPlan(p) {
        const ph = String(p.phase || "").toUpperCase();
        if (ph.startsWith("HPCL")) return "HPCL";
        if (ph.includes("RBML")) return "RBML";
        if (ph.includes("BPCL")) return "BPCL";
        if (ph.includes("NPL")) return "NPL";
        return "OTHER";
      }

      function renderCustomerChart(plans) {
        const ctx = document.getElementById("chartCustomer");
        if (!ctx) return;
        const counts = new Map();
        const labelColorMap = new Map([
          ["HPCL", "#16a34a"],
          ["RBML", "#f59e0b"],
          ["BPCL", "#60a5fa"],
          ["NPL", "#34d399"],
          ["OTHER", "#9ca3af"],
        ]);

        (plans || []).forEach((p) => {
          const cust = customerFromPlan(p);
          counts.set(cust, (counts.get(cust) || 0) + 1);
        });

        const labels = Array.from(counts.keys());
        const data = labels.map((l) => counts.get(l));
        const colors = labels.map((l) => labelColorMap.get(l) || "#9ca3af");

        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{ label: "Visits", data, backgroundColor: colors }],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
          },
        });
      }

      function renderCustomerCards(counts) {
        const container = document.getElementById("customerCards");
        if (!container) return;
        const color = (label) =>
          ({
            HPCL: "#16a34a",
            RBML: "#f59e0b",
            BPCL: "#60a5fa",
            NPL: "#34d399",
            "JIO BP": "#a78bfa",
            OTHER: "#9ca3af",
          }[label] || "#9ca3af");

        const items = Array.from(counts.entries()).sort((a, b) => b[1] - a[1]);
        container.innerHTML = items
          .map(
            ([label, count]) => `
          <div class="rounded-lg border bg-white p-3 flex items-center gap-3 shadow-sm">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white" style="background:${color(
              label
            )}">${label.split(" ")[0][0]}</div>
            <div>
              <div class="text-[11px] text-gray-500">${label}</div>
              <div class="text-lg font-semibold">${count}</div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // ===== Monthly Engineer x Customer table =====
      function ymKey(d) {
        try {
          return new Date(d).toISOString().slice(0, 7);
        } catch {
          return "";
        }
      }
      function buildMonthDropdown(plans) {
        const sel = document.getElementById("monthSelect");
        if (!sel) return;
        const keys = new Set(
          (plans || []).map((p) => ymKey(p.date)).filter(Boolean)
        );
        // Fallback: include current month if none
        if (keys.size === 0) {
          keys.add(new Date().toISOString().slice(0, 7));
        }
        const sorted = Array.from(keys).sort().reverse();
        sel.innerHTML = sorted
          .map((k) => {
            const [y, m] = k.split("-");
            const dt = new Date(`${k}-01T00:00:00`);
            const label = dt.toLocaleString("en-US", {
              month: "long",
              year: "numeric",
            });
            return `<option value="${k}">${label}</option>`;
          })
          .join("");
      }
      function renderEngineerMonthly(plans, ym) {
        const body = document.getElementById("engMonthBody");
        if (!body) return;
        const data = (plans || []).filter((p) => {
          if (ymKey(p.date) !== ym) return false;
          const purposeUpper = String(p.issueType || p.purpose || "")
            .trim()
            .toUpperCase();
          // Exclude NO PLAN only; keep IN LEAVE so it can be counted
          if (purposeUpper === "NO PLAN") return false;
          return true;
        });

        // Aggregate: engineer -> customer -> count
        const map = new Map();
        const customers = ["HPCL", "RBML", "BPCL", "NPL", "OTHER", "IN LEAVE"];
        data.forEach((p) => {
          const eng = String(p.engineer || "").trim() || "-";
          const purposeUpper = String(p.issueType || p.purpose || "").trim().toUpperCase();
          const cust = purposeUpper === "IN LEAVE" ? "IN LEAVE" : customerFromPlan(p);
          if (!map.has(eng))
            map.set(eng, new Map(customers.map((c) => [c, 0])));
          const row = map.get(eng);
          row.set(cust, (row.get(cust) || 0) + 1);
        });

        const rows = Array.from(map.entries()).sort((a, b) =>
          a[0].localeCompare(b[0])
        );
        body.innerHTML = rows
          .map(([eng, row]) => {
            const cells = customers
              .map((c) => `<td class="px-3 py-2">${row.get(c) || 0}</td>`)
              .join("");
            const total = customers
              .filter((c) => c !== "IN LEAVE")
              .reduce((s, c) => s + (row.get(c) || 0), 0);
            return `<tr class="border-b"><td class="px-3 py-2 font-medium">${eng}</td>${cells}<td class="px-3 py-2 font-semibold">${total}</td></tr>`;
          })
          .join("");

        // Append totals row at the end
        const totals = new Map(customers.map((c) => [c, 0]));
        rows.forEach(([_, row]) => {
          customers.forEach((c) => totals.set(c, totals.get(c) + (row.get(c) || 0)));
        });
        const grandTotal = customers
          .filter((c) => c !== "IN LEAVE")
          .reduce((s, c) => s + (totals.get(c) || 0), 0);
        const totalCells = customers
          .map((c) => `<td class="px-3 py-2 font-semibold">${totals.get(c) || 0}</td>`)
          .join("");
        body.innerHTML += `<tr class="border-t bg-gray-50"><td class="px-3 py-2 font-bold">Total</td>${totalCells}<td class="px-3 py-2 font-bold">${grandTotal}</td></tr>`;
      }

      function normalizeText(s) {
        return String(s || "").trim().toUpperCase();
      }

      function isPowerProtectionInstall(purpose) {
        const t = normalizeText(purpose);
        return t.includes("POWER PROTECTION PCB") && (t.includes("INSTALL") || t.includes("INSTAL"));
      }

      function isGsmModuleInstall(purpose) {
        const t = normalizeText(purpose);
        return (
          (t.includes("GSM MODULE") && (t.includes("INSTALL") || t.includes("INSTAL"))) ||
          t.includes("GSM MODULE INSTALLATION")
        );
      }

      function deviceProvidedStorageKey(ym) {
        return `device_provided_${ym}`;
      }

      function renderDeviceInstallations(plans, ym) {
        const tbody = document.getElementById("deviceInstallBody");
        const saveBtn = document.getElementById("saveDeviceProvidedBtn");
        if (!tbody) return;
        const data = (plans || []).filter((p) => {
          if (ymKey(p.date) !== ym) return false;
          const purposeUpper = normalizeText(p.issueType || p.purpose);
          if (purposeUpper === "NO PLAN") return false;
          return true;
        });

        const isAdmin = (window.__currentUser || {}).role === "admin";
        const stored = JSON.parse(localStorage.getItem(deviceProvidedStorageKey(ym)) || "{}");

        const map = new Map(); // engineer -> { power: n, gsm: n, provided: n }
        data.forEach((p) => {
          const eng = String(p.engineer || "").trim() || "-";
          const purpose = p.purpose || p.issueType || "";
          if (!map.has(eng)) map.set(eng, { power: 0, gsm: 0, provided: stored[eng] || 0 });
          const rec = map.get(eng);
          if (isPowerProtectionInstall(purpose)) rec.power += 1;
          if (isGsmModuleInstall(purpose)) rec.gsm += 1;
        });

        const rows = Array.from(map.entries()).sort((a, b) => a[0].localeCompare(b[0]));
        const total = { power: 0, gsm: 0, provided: 0 };
        tbody.innerHTML = rows
          .map(([eng, rec]) => {
            total.power += rec.power;
            total.gsm += rec.gsm;
            total.provided += Number(rec.provided) || 0;
            const providedCell = isAdmin
              ? `<input type="number" min="0" value="${rec.provided}" data-eng="${eng}" class="border px-2 py-1 rounded w-24" />`
              : `<span>${rec.provided}</span>`;
            return `<tr class="border-b">
              <td class="px-3 py-2 font-medium">${eng}</td>
              <td class="px-3 py-2">${rec.power}</td>
              <td class="px-3 py-2">${rec.gsm}</td>
              <td class="px-3 py-2">${providedCell}</td>
            </tr>`;
          })
          .join("");

        // Totals row
        tbody.innerHTML += `<tr class="border-t bg-gray-50">
          <td class="px-3 py-2 font-bold">Total</td>
          <td class="px-3 py-2 font-bold">${total.power}</td>
          <td class="px-3 py-2 font-bold">${total.gsm}</td>
          <td class="px-3 py-2 font-bold">${total.provided}</td>
        </tr>`;

        // Show save button for admin only
        if (saveBtn) saveBtn.classList.toggle("hidden", !isAdmin);
      }

      function saveDeviceProvidedCounts() {
        try {
          const sel = document.getElementById("monthSelect");
          const ym = sel ? sel.value : new Date().toISOString().slice(0, 7);
          const inputs = document.querySelectorAll('#deviceInstallBody input[data-eng]');
          const payload = {};
          inputs.forEach((inp) => {
            const eng = inp.getAttribute('data-eng');
            const val = Number(inp.value || 0) || 0;
            payload[eng] = val;
          });
          localStorage.setItem(deviceProvidedStorageKey(ym), JSON.stringify(payload));
        } catch (e) {
          console.error('save device provided error', e);
        }
      }

      function renderRelconConnectivity(statusRecords) {
        const tbody = document.getElementById("relconConnectivityBody");
        const header = document.getElementById("relconConnectivityHeader");
        if (!tbody || !header) return;
        
        // Filter records with ConnectivityType = RELCON SIM
        const relcon = (statusRecords || []).filter((r) =>
          String(r.connectivityType || r.ConnectivityType || "")
            .trim()
            .toUpperCase()
            .includes("RELCON")
        );
        
        // Create pivot table: region -> phase -> count
        const regionPhaseMap = new Map(); // region -> Map(phase -> Set(roCode))
        const allPhases = new Set();
        
        relcon.forEach((r) => {
          const region = String(r.region || r.Region || "").trim() || "-";
          const phase = String(r.phase || r.Phase || "").trim() || "-";
          const ro = String(r.roCode || r.ROCode || r.rocode || "").trim();
          
          if (!regionPhaseMap.has(region)) {
            regionPhaseMap.set(region, new Map());
          }
          if (!regionPhaseMap.get(region).has(phase)) {
            regionPhaseMap.get(region).set(phase, new Set());
          }
          if (ro) {
            regionPhaseMap.get(region).get(phase).add(ro);
            allPhases.add(phase);
          }
        });
        
        // Sort phases and regions
        const sortedPhases = Array.from(allPhases).sort();
        const sortedRegions = Array.from(regionPhaseMap.keys()).sort();
        
        // Build header with phases as columns
        header.innerHTML = `<th class="px-3 py-2 text-left">Region</th>` + 
          sortedPhases.map(phase => `<th class="px-3 py-2 text-left">${phase}</th>`).join("") +
          `<th class="px-3 py-2 text-left">Total</th>`;
        
        // Build rows
        let totalRow = new Array(sortedPhases.length + 1).fill(0); // +1 for region column
        
        tbody.innerHTML = sortedRegions.map(region => {
          const phaseCounts = sortedPhases.map(phase => {
            const count = regionPhaseMap.get(region).get(phase)?.size || 0;
            totalRow[sortedPhases.indexOf(phase) + 1] += count; // +1 because index 0 is region
            return count;
          });
          const regionTotal = phaseCounts.reduce((sum, count) => sum + count, 0);
          totalRow[0] += regionTotal;
          
          return `<tr class="border-b">
            <td class="px-3 py-2 font-medium">${region}</td>
            ${phaseCounts.map(count => `<td class="px-3 py-2">${count}</td>`).join("")}
            <td class="px-3 py-2 font-semibold">${regionTotal}</td>
          </tr>`;
        }).join("");
        
        // Add total row
        if (sortedRegions.length > 0) {
          tbody.innerHTML += `<tr class="border-t bg-gray-50">
            <td class="px-3 py-2 font-bold">Total</td>
            ${totalRow.slice(1, -1).map(count => `<td class="px-3 py-2 font-bold">${count}</td>`).join("")}
            <td class="px-3 py-2 font-bold">${totalRow[totalRow.length - 1]}</td>
          </tr>`;
          
          // Calculate unique sites count (sum of all unique RO codes across all phases)
          const uniqueSites = new Set();
          relcon.forEach((r) => {
            const roCode = String(r.roCode || r.ROCode || r.rocode || "").trim();
            if (roCode) {
              uniqueSites.add(roCode);
            }
          });
          
          // Update overall count display
          const overallCountElement = document.getElementById("relconOverallCount");
          if (overallCountElement) {
            const uniqueSitesCount = uniqueSites.size;
            overallCountElement.innerHTML = `Total RELCON Connectivity Sites: <span class="font-semibold">${uniqueSitesCount}</span>`;
          }
        } else {
          tbody.innerHTML = `<tr><td colspan="${sortedPhases.length + 2}" class="px-3 py-4 text-center text-gray-400">No data</td></tr>`;
          
          // Update overall count display for no data
          const overallCountElement = document.getElementById("relconOverallCount");
          if (overallCountElement) {
            overallCountElement.innerHTML = `Total RELCON Connectivity Sites: <span class="font-semibold">0</span>`;
          }
        }
      }

      function pcbProvidedStorageKey() {
        return `pcb_provided_alltime`;
      }

      function renderPcbInstallation(statusRecords) {
        const tbody = document.getElementById("pcbInstallationBody");
        const saveBtn = document.getElementById("savePcbProvidedBtn");
        if (!tbody) return;
        const isAdmin = (window.__currentUser || {}).role === "admin";
        const providedMap = JSON.parse(localStorage.getItem(pcbProvidedStorageKey()) || "{}");

        // Count POWER PROTECTION PCB INSTALL from Purpose of Visit
        const isPcbInstall = (purpose) => {
          const t = String(purpose || "")
            .trim()
            .toUpperCase();
          return t.includes("POWER PROTECTION PCB") && (t.includes("INSTALL") || t.includes("INSTAL"));
        };

        const map = new Map(); // engineer|region -> { provided, installed }
        (statusRecords || []).forEach((r) => {
          const eng = String(r.engineer || r.Engineer || "").trim() || "-";
          const region = String(r.region || r.Region || "").trim() || "-";
          const key = `${eng}|${region}`;
          if (!map.has(key)) map.set(key, { provided: Number(providedMap[eng] || 0) || 0, installed: 0 });
          if (isPcbInstall(r.purpose || r.PurposeOfVisit || r.PURPOSEOFVISIT)) {
            map.get(key).installed += 1;
          }
        });

        const rows = Array.from(map.entries())
          .map(([key, rec]) => {
            const [eng, region] = key.split("|");
            return { eng, region, provided: rec.provided, installed: rec.installed, pending: Math.max(0, rec.provided - rec.installed) };
          })
          .filter((r) => r.eng.toUpperCase() !== "NAVAL KISHOR PANDEY")
          .sort((a, b) => a.eng.localeCompare(b.eng) || a.region.localeCompare(b.region));

        // Calculate totals
        const totalProvided = rows.reduce((sum, r) => sum + r.provided, 0);
        const totalInstalled = rows.reduce((sum, r) => sum + r.installed, 0);
        const totalPending = rows.reduce((sum, r) => sum + r.pending, 0);

        tbody.innerHTML = rows
          .map((r) => {
            const providedCell = isAdmin
              ? `<input type="number" min="0" value="${r.provided}" data-eng="${r.eng}" class="border px-2 py-1 rounded w-28" />`
              : `<span>${r.provided}</span>`;
            return `<tr class="border-b">
              <td class="px-3 py-2 font-medium">${r.eng}</td>
              <td class="px-3 py-2">${r.region}</td>
              <td class="px-3 py-2">${providedCell}</td>
              <td class="px-3 py-2">${r.installed}</td>
              <td class="px-3 py-2">${r.pending}</td>
            </tr>`;
          })
          .join("");
        
        // Add total row
        if (rows.length > 0) {
          tbody.innerHTML += `<tr class="border-t bg-gray-50">
            <td class="px-3 py-2 font-bold">Total</td>
            <td class="px-3 py-2 font-bold"></td>
            <td class="px-3 py-2 font-bold">${totalProvided}</td>
            <td class="px-3 py-2 font-bold">${totalInstalled}</td>
            <td class="px-3 py-2 font-bold">${totalPending}</td>
          </tr>`;
        } else {
          tbody.innerHTML = `<tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">No data</td></tr>`;
        }

        if (saveBtn) saveBtn.classList.toggle("hidden", !isAdmin);
      }

      function savePcbProvidedCounts() {
        try {
          const inputs = document.querySelectorAll('#pcbInstallationBody input[data-eng]');
          const payload = {};
          inputs.forEach((inp) => {
            const eng = inp.getAttribute('data-eng');
            const val = Number(inp.value || 0) || 0;
            payload[eng] = val;
          });
          localStorage.setItem(pcbProvidedStorageKey(), JSON.stringify(payload));
          // Re-render to update pending calculations
          renderPcbInstallation(window.__statusRecords);
        } catch (e) {
          console.error('save pcb provided error', e);
        }
      }

      function exportRelconConnectivityCSV() {
        try {
          const statusRecords = window.__statusRecords || [];
          const relcon = statusRecords.filter((r) =>
            String(r.connectivityType || r.ConnectivityType || "")
              .trim()
              .toUpperCase()
              .includes("RELCON")
          );
          
          // Remove duplicate sites (unique RO codes)
          const uniqueSites = new Map(); // roCode -> record
          relcon.forEach((r) => {
            const roCode = String(r.roCode || r.ROCode || r.rocode || "").trim();
            if (roCode && !uniqueSites.has(roCode)) {
              uniqueSites.set(roCode, r);
            }
          });
          
          const csvRows = [
            ["EngineerName", "Region", "RO Code", "RO Name", "Phase", "Connectivity Type", "SIM1 Provider", "SIM1 Number", "SIM2 Provider", "SIM2 Number", "IEMI Number"]
          ];
          
          uniqueSites.forEach((r) => {
            const eng = String(r.engineer || r.Engineer || "").trim();
            const region = String(r.region || r.Region || "").trim();
            const roCode = String(r.roCode || r.ROCode || r.rocode || "").trim();
            const roName = String(r.roName || r.ROName || "").trim();
            const phase = String(r.phase || r.Phase || "").trim();
            const connectivityType = String(r.connectivityType || r.ConnectivityType || "").trim();
            const sim1Provider = String(r.sim1Provider || r.SIM1Provider || "").trim();
            const sim1Number = `\`${String(r.sim1Number || r.SIM1Number || "").trim()}`;
            const sim2Provider = String(r.sim2Provider || r.SIM2Provider || "").trim();
            const sim2Number = `\`${String(r.sim2Number || r.SIM2Number || "").trim()}`;
            const iemiNumber = `\`${String(r.iemiNumber || r.IEMINumber || r.imeiNumber || "").trim()}`;
            
            csvRows.push([
              eng, region, roCode, roName, phase, connectivityType, 
              sim1Provider, sim1Number, sim2Provider, sim2Number, iemiNumber
            ]);
          });
          
          // Add total connectivity count at the end
          csvRows.push([]); // Empty row
          csvRows.push(["Total RELCON Connectivity", uniqueSites.size]);
          
          const blob = new Blob([csvRows.map(row => row.join(",")).join("\n")], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "relcon_connectivity_data.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error("export relcon csv error", e);
        }
      }

      function exportPcbInstallationCSV() {
        try {
          const statusRecords = window.__statusRecords || [];
          const pcbRecords = statusRecords.filter((r) => {
            const purpose = String(r.purpose || r.PurposeOfVisit || r.PURPOSEOFVISIT || "").trim().toUpperCase();
            return purpose.includes("POWER PROTECTION PCB") && (purpose.includes("INSTALL") || purpose.includes("INSTAL"));
          });
          
          const csvRows = [
            ["EngineerName", "Region", "RO Code", "RO Name", "Date", "Purpose of Visit"]
          ];
          
          pcbRecords.forEach((r) => {
            const eng = String(r.engineer || r.Engineer || "").trim();
            const region = String(r.region || r.Region || "").trim();
            const roCode = String(r.roCode || r.ROCode || r.rocode || "").trim();
            const roName = String(r.roName || r.ROName || "").trim();
            const date = String(r.date || r.Date || "").trim();
            const purpose = String(r.purpose || r.PurposeOfVisit || r.PURPOSEOFVISIT || "").trim();
            
            csvRows.push([eng, region, roCode, roName, date, purpose]);
          });
          
          const blob = new Blob([csvRows.map(row => row.join(",")).join("\n")], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "pcb_installation_data.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error("export pcb csv error", e);
        }
      }
      function exportEngineerMonthlyCSV() {
        try {
          const plans = window.__allPlans || [];
          const sel = document.getElementById("monthSelect");
          const ym = sel ? sel.value : new Date().toISOString().slice(0, 7);
          // Recompute the same aggregation as renderEngineerMonthly
          const data = (plans || []).filter((p) => {
            if (ymKey(p.date) !== ym) return false;
            const purposeUpper = String(p.issueType || p.purpose || "")
              .trim()
              .toUpperCase();
            if (purposeUpper === "NO PLAN") return false;
            return true;
          });
          const customers = ["HPCL", "RBML", "BPCL", "NPL", "OTHER", "IN LEAVE"];
          const map = new Map();
          data.forEach((p) => {
            const eng = String(p.engineer || "").trim() || "-";
            const purposeUpper = String(p.issueType || p.purpose || "").trim().toUpperCase();
            const cust = purposeUpper === "IN LEAVE" ? "IN LEAVE" : customerFromPlan(p);
            if (!map.has(eng)) map.set(eng, new Map(customers.map((c) => [c, 0])));
            const row = map.get(eng);
            row.set(cust, (row.get(cust) || 0) + 1);
          });
          const rows = Array.from(map.entries()).sort((a, b) => a[0].localeCompare(b[0]));
          const totals = new Map(customers.map((c) => [c, 0]));
          rows.forEach(([_, row]) => {
            customers.forEach((c) => totals.set(c, totals.get(c) + (row.get(c) || 0)));
          });
          const grandTotal = customers.filter((c) => c !== "IN LEAVE").reduce((s, c) => s + (totals.get(c) || 0), 0);

          // Build aggregated sheet (Sheet1)
          const aggHeader = ["Engineer", ...customers, "Total"];
          const aggRows = rows.map(([eng, row]) => {
            const total = customers.filter((c) => c !== "IN LEAVE").reduce((s, c) => s + (row.get(c) || 0), 0);
            const cells = customers.map((c) => row.get(c) || 0);
            return { Engineer: eng, ...Object.fromEntries(customers.map((c, i) => [c, cells[i]])), Total: total };
          });
          const totalObj = { Engineer: "Total", ...Object.fromEntries(customers.map((c) => [c, totals.get(c) || 0])), Total: grandTotal };
          const sheet1Data = [Object.fromEntries(aggHeader.map((h) => [h, h])), ...aggRows.map((r) => r), totalObj];

          // Build detail sheet (Sheet2)
          const detailRows = data.map((p) => {
            const purposeUpper = String(p.issueType || p.purpose || "").trim().toUpperCase();
            const cust = purposeUpper === "IN LEAVE" ? "IN LEAVE" : customerFromPlan(p);
            const totalEligible = cust !== "IN LEAVE";
            return {
              Date: String(p.date || "").slice(0, 10),
              Engineer: p.engineer || "",
              ROCode: p.roCode || "",
              ROName: p.roName || "",
              Phase: p.phase || "",
              IssueType: p.issueType || p.purpose || "",
              Customer: cust,
              CountsTowardsTotal: totalEligible ? "Yes" : "No",
            };
          });

          // Create workbook with two sheets
          const wb = XLSX.utils.book_new();
          const ws1 = XLSX.utils.json_to_sheet(sheet1Data, { skipHeader: true });
          const ws2 = XLSX.utils.json_to_sheet(detailRows);
          XLSX.utils.book_append_sheet(wb, ws1, "Engineer Monthly");
          XLSX.utils.book_append_sheet(wb, ws2, "Detail Rows");
          XLSX.writeFile(wb, `engineer_monthly_${ym}.xlsx`);
        } catch (e) {
          console.error("export csv error", e);
        }
      }

      loadOverview();
    </script>
  </body>
</html>
