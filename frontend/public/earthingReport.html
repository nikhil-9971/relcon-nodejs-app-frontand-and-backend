<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Earthing Status Report</title>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #f1f5f9;
        font-size: 12px;
      }
      .card {
        background: #fff;
        padding: 14px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
      }
      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px;
      }
      th,
      td {
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
        white-space: nowrap;
        text-align: left;
      }
      thead th {
        background: #f0f9ff;
        position: sticky;
        top: 0;
        z-index: 2;
        text-align: center;
      }
      .muted {
        color: #6b7280;
        font-size: 12px;
      }
      #loadingOverlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .controls .select {
        min-width: 180px;
      }
      @media (max-width: 900px) {
        .controls {
          flex-wrap: wrap;
        }
        .controls .select {
          min-width: 140px;
        }
      }
    </style>
  </head>
  <body class="p-6">
    <div class="max-w-6xl mx-auto card">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h1 class="text-lg font-semibold">âš¡ Earthing Status Report</h1>
          <div class="muted">
            Shows latest HPCL visits per RO and earthing details (source: Daily
            Plans)
          </div>
        </div>
        <div class="flex items-center gap-2">
          <input
            id="searchInput"
            placeholder="ðŸ”Ž Search RO / Name / Remark..."
            class="border px-2 py-1 rounded"
            oninput="applyFilters()"
          />
        </div>
      </div>

      <!-- Filters row -->
      <div class="flex items-center controls mb-3">
        <div>
          <label class="muted block text-xs">Engineer</label>
          <select
            id="engineerFilter"
            class="border px-2 py-1 rounded select"
            onchange="applyFilters()"
          >
            <option value="">All Engineers</option>
          </select>
        </div>

        <div>
          <label class="muted block text-xs">Earthing (Separate?)</label>
          <select
            id="earthingFilter"
            class="border px-2 py-1 rounded select"
            onchange="applyFilters()"
          >
            <option value="">All</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>

        <div style="margin-left: auto; display: flex; gap: 8px">
          <button
            onclick="exportExcel()"
            class="bg-green-600 text-white px-3 py-1 rounded"
          >
            ðŸ“¤ Export
          </button>
          <button
            onclick="refresh()"
            class="bg-blue-600 text-white px-3 py-1 rounded"
          >
            â†» Refresh
          </button>
        </div>
      </div>

      <div class="overflow-auto" style="max-height: 70vh">
        <table id="earthingTable" class="min-w-full">
          <thead>
            <tr>
              <th>Engineer</th>
              <th>RO Code</th>
              <th>RO Name</th>
              <th>Phase</th>
              <th>Last Visit Date</th>
              <th>Earthing (Separate?)</th>
              <th>Earthing Remark</th>
              <th>Cable (m)</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="loadingOverlay">
      <div class="flex flex-col items-center">
        <div
          class="w-12 h-12 border-4 border-green-600 border-t-transparent rounded-full animate-spin mb-2"
        ></div>
        <div class="text-sm text-gray-700">Loading data...</div>
      </div>
    </div>

    <script>
      const baseUrl = "https://relcon-backend-jwt-backup.onrender.com";
      let token = localStorage.getItem("token");
      let fullData = []; // daily plans raw
      let rows = []; // aggregated latest HPCL per RO (all)
      let filteredRows = []; // result after filters
      let loggedInUser = null;

      const tableBody = document.getElementById("tableBody");
      const loading = document.getElementById("loadingOverlay");
      const engineerFilterEl = document.getElementById("engineerFilter");
      const earthingFilterEl = document.getElementById("earthingFilter");
      const searchInputEl = document.getElementById("searchInput");

      function showLoading() {
        loading.style.display = "flex";
      }
      function hideLoading() {
        loading.style.display = "none";
      }

      async function fetchUserSession() {
        try {
          const res = await fetch(baseUrl + "/user", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          if (!res.ok) {
            alert("Please login");
            window.location.href = "login.html";
            return null;
          }
          return await res.json();
        } catch (e) {
          console.error(e);
          alert("Auth error");
          window.location.href = "login.html";
        }
      }

      async function fetchDailyPlans() {
        try {
          const res = await fetch(baseUrl + "/getDailyPlans", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          if (!res.ok) return [];
          return await res.json();
        } catch (e) {
          console.error("Failed to fetch daily plans:", e);
          return [];
        }
      }

      // Build latest plan per RO where phase indicates HPCL (phase contains "HPCL")
      // EXCLUDE entries where phase explicitly contains "HPCL OFFICE"
      function buildLatestHpclMap(plans) {
        const map = {};
        plans.forEach((p) => {
          try {
            const phase = (p.phase || "").toString();
            const uPhase = phase.toUpperCase();
            // include only HPCL phases but exclude "HPCL OFFICE"
            if (!uPhase.includes("HPCL")) return;
            if (uPhase.includes("HPCL OFFICE")) return; // skip HPCL OFFICE
            const rc = (p.roCode || "").toString().trim().toUpperCase();
            if (!rc) return;
            const d = p.date ? new Date(p.date) : null;
            const ts = d && !isNaN(d.getTime()) ? d.getTime() : 0;
            const existing = map[rc];
            if (!existing || (existing._ts || 0) < ts) {
              map[rc] = {
                roCode: rc,
                roName: p.roName || "",
                phase: phase,
                lastVisitDate: p.date || "",
                separateEarthing:
                  p.separateearthingStatus || p.separateearthingstatus || "",
                earthingRemark:
                  p.detailEarthingremark || p.detailEarthingRemark || "",
                cableMeter: p.cableRequirmentremark || p.cableRequirment || "",
                engineer: p.engineer || "",
                _ts: ts,
              };
            }
          } catch (e) {
            /* ignore per-row errors */
          }
        });
        return Object.values(map);
      }

      function populateEngineerFilter(listOfRows, user) {
        // unique engineers from rows
        const set = new Set();
        listOfRows.forEach((r) => {
          if (r.engineer) set.add(String(r.engineer).trim());
        });
        // clear existing
        engineerFilterEl.innerHTML = '<option value="">All Engineers</option>';
        Array.from(set)
          .sort((a, b) => a.localeCompare(b))
          .forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            engineerFilterEl.appendChild(opt);
          });

        // If logged in user is engineer, set and disable filter
        if (user && user.role === "engineer") {
          const nameToSet = (user.engineerName || user.username || "").trim();
          // If engineer not in list, still set the value (will result in no rows)
          engineerFilterEl.value = nameToSet;
          engineerFilterEl.disabled = true;
        } else {
          engineerFilterEl.disabled = false;
        }
      }

      function renderTable(data) {
        tableBody.innerHTML = "";
        if (!data || data.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="8" class="muted" style="text-align:center;padding:12px">No data</td></tr>`;
          return;
        }
        // sort by roCode
        data.sort((a, b) => (a.roCode || "").localeCompare(b.roCode || ""));
        tableBody.innerHTML = data
          .map(
            (r) => `
          <tr>
            <td>${escapeHtml(r.engineer)}</td>
            <td>${escapeHtml(r.roCode)}</td>
            <td>${escapeHtml(r.roName)}</td>
            <td>${escapeHtml(r.phase)}</td>
            <td>${escapeHtml(formatDate(r.lastVisitDate))}</td>
            <td>${escapeHtml(normalizeYesNo(r.separateEarthing))}</td>
            <td>${escapeHtml(r.earthingRemark)}</td>
            <td>${escapeHtml(r.cableMeter)}</td>
          </tr>
        `
          )
          .join("");
      }

      function escapeHtml(s) {
        if (s === undefined || s === null) return "";
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }
      function formatDate(d) {
        if (!d) return "";
        const dt = new Date(d);
        if (isNaN(dt.getTime())) return d;
        return dt.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
      }
      function normalizeYesNo(v) {
        if (!v) return "";
        const s = String(v).trim().toLowerCase();
        if (
          s === "yes" ||
          s === "separate" ||
          s === "seperate" ||
          s === "separate earthing"
        )
          return "Yes";
        if (s === "no" || s === "not separate" || s === "not") return "No";
        return v;
      }

      function applyFilters() {
        const q = (searchInputEl.value || "").trim().toLowerCase();
        const selEngineer = (engineerFilterEl.value || "").trim();
        const selEarthing = (earthingFilterEl.value || "").trim(); // "", "Yes", "No"

        let out = rows.slice();

        // Role-based: engineer sees only their own records
        if (loggedInUser && loggedInUser.role === "engineer") {
          const myName = (
            loggedInUser.engineerName ||
            loggedInUser.username ||
            ""
          ).trim();
          out = out.filter((r) => (r.engineer || "").trim() === myName);
        } else {
          // admin or other roles can filter by engineer if selected
          if (selEngineer) {
            out = out.filter((r) => (r.engineer || "").trim() === selEngineer);
          }
        }

        // earthing filter
        if (selEarthing === "Yes") {
          out = out.filter((r) => normalizeYesNo(r.separateEarthing) === "Yes");
        } else if (selEarthing === "No") {
          out = out.filter((r) => normalizeYesNo(r.separateEarthing) === "No");
        }

        // search
        if (q) {
          out = out.filter((r) => {
            return [
              r.engineer,
              r.roCode,
              r.roName,
              r.phase,
              r.lastVisitDate,
              r.separateEarthing,
              r.earthingRemark,
              r.cableMeter,
            ].some((v) => v && String(v).toLowerCase().includes(q));
          });
        }

        filteredRows = out;
        renderTable(filteredRows);
      }

      async function loadData() {
        showLoading();
        const user = await fetchUserSession();
        if (!user) return;
        loggedInUser = user;
        fullData = await fetchDailyPlans();
        rows = buildLatestHpclMap(fullData);
        populateEngineerFilter(rows, loggedInUser);
        // default filters: if engineer, apply immediately; else show all
        applyFilters();
        hideLoading();
      }

      function refresh() {
        // clear search and filters for admin, but keep engineer filter for engineer role
        if (!loggedInUser || loggedInUser.role !== "engineer") {
          searchInputEl.value = "";
          engineerFilterEl.value = "";
          earthingFilterEl.value = "";
        } else {
          earthingFilterEl.value = "";
          searchInputEl.value = "";
        }
        loadData();
      }

      function exportExcel() {
        const dataToExport =
          filteredRows && filteredRows.length ? filteredRows : [];
        if (!dataToExport || dataToExport.length === 0)
          return alert("No data to export");
        const wb = XLSX.utils.book_new();
        const header = [
          [
            "Engineer",
            "RO Code",
            "RO Name",
            "Phase",
            "Last Visit Date",
            "Earthing Separate (Yes/No)",
            "Earthing Remark",
            "Cable (m)",
          ],
        ];
        const dataRows = dataToExport.map((r) => [
          r.engineer,
          r.roCode,
          r.roName,
          r.phase,
          r.lastVisitDate,
          normalizeYesNo(r.separateEarthing),
          r.earthingRemark,
          r.cableMeter,
        ]);
        const ws = XLSX.utils.aoa_to_sheet([...header, ...dataRows]);
        XLSX.utils.book_append_sheet(wb, ws, "Earthing Status");
        const name = `Earthing_Status_${new Date()
          .toISOString()
          .slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, name);
      }

      // initial
      window.addEventListener("load", () => {
        loadData();
      });
    </script>
  </body>
</html>
