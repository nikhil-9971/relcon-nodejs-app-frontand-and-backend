<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Material Requirement Table View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
      }
      table {
        font-size: 11px;
        table-layout: auto;
      }
      th,
      td {
        white-space: nowrap;
        padding: 6px 10px;
        text-align: center;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-6">
    <div class="max-w-7xl mx-auto bg-white p-6 rounded shadow">
      <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
        <h1 class="text-2xl font-bold text-green-800">
          📊 Material Requirement Table View
        </h1>
        <button
          onclick="exportToExcel()"
          class="bg-green-600 text-white px-4 py-2 rounded shadow"
        >
          📤 Export to Excel
        </button>
      </div>

      <!-- Filter Controls -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <input type="date" id="fromDate" class="border rounded p-2" />
        <input type="date" id="toDate" class="border rounded p-2" />
        <input
          type="text"
          id="searchInput"
          placeholder="🔍 Search..."
          class="border rounded p-2"
          oninput="applyFilters()"
        />
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 bg-white">
          <thead class="bg-gray-200">
            <tr>
              <th>Engineer</th>
              <th>Region</th>
              <th>RO Code</th>
              <th>RO Name</th>
              <th>Phase</th>
              <th>Date Of Visit</th>
              <th>Required Material</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      const token = localStorage.getItem("token");
      let allData = [],
        filtered = [];

      async function fetchData() {
        const [hpclRes, jioRes, planRes] = await Promise.all([
          fetch(`${baseUrl}/getMergedStatusRecords`, {
            headers: { Authorization: `Bearer ${token}` },
          }),
          fetch(`${baseUrl}/jioBP/getAllJioBPStatus`, {
            headers: { Authorization: `Bearer ${token}` },
          }),
          fetch(`${baseUrl}/getDailyPlans`, {
            headers: { Authorization: `Bearer ${token}` },
          }),
        ]);

        const hpclData = await hpclRes.json();
        const jioData = await jioRes.json();
        const planData = await planRes.json();

        const planMap = {};
        planData.forEach((p) => (planMap[p._id?.toString()] = p));

        allData = [...hpclData, ...jioData].map((record) => {
          const planKey =
            typeof record.planId === "object" && record.planId._id
              ? record.planId._id.toString()
              : record.planId?.toString();
          const plan = planMap[planKey];
          return {
            ...record,
            engineer: plan?.engineer || "",
            region: plan?.region || "",
            roCode: plan?.roCode || "",
            roName: plan?.roName || "",
            phase: plan?.phase || "",
            date: plan?.date || "",
            material:
              record.materialRequirement || record.spareRequirmentname || "",
          };
        });

        applyFilters();
      }

      function applyFilters() {
        const searchText = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;

        filtered = allData.filter((item) => {
          const matchDate =
            (!fromDate || new Date(item.date) >= new Date(fromDate)) &&
            (!toDate || new Date(item.date) <= new Date(toDate));
          const matchSearch = Object.values(item).some((val) =>
            val?.toLowerCase?.().includes(searchText)
          );

          const isJio =
            item.spareRequired === "Yes" && item.materialRequirement?.trim();
          const isHpcl =
            item.spareRequirment === "Yes" && item.spareRequirmentname?.trim();
          const isVerified =
            item.isVerified === true || item.isVerified === "true";

          return matchDate && matchSearch && (isJio || isHpcl) && isVerified;
        });

        renderTable();
      }

      function renderTable() {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = filtered
          .map(
            (row) => `
          <tr class="border-b">
            <td>${row.engineer}</td>
            <td>${row.region}</td>
            <td>${row.roCode}</td>
            <td>${row.roName}</td>
            <td>${row.phase}</td>
            <td>${row.date}</td>
            <td>${row.material}</td>
          </tr>
        `
          )
          .join("");
      }

      function exportToExcel() {
        if (filtered.length === 0) return alert("No data to export");
        const rows = filtered.map((row) => ({
          Engineer: row.engineer,
          Region: row.region,
          "RO Code": row.roCode,
          "RO Name": row.roName,
          Phase: row.phase,
          Date: row.date,
          "Required Material": row.material,
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Material Requirement");
        XLSX.writeFile(wb, "Material_Requirement_Report.xlsx");
      }

      fetchData();
    </script>
  </body>
</html>
