<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ECZ Material Requirement</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 12px;
      }
      th,
      td {
        white-space: nowrap;
      }
      thead th {
        position: sticky;
        top: 0;
        background-color: #f3f4f6;
        z-index: 1;
      }
      table th,
      table td {
        white-space: nowrap !important; /* wrap band */
        text-align: center !important; /* ‚úÖ center align */
        vertical-align: middle !important;
        padding: 4px 6px !important;
        font-size: 10px !important;
        border: 1px solid #e5e7eb; /* proper cell borders */
      }
      thead th { border-bottom: 2px solid #e5e7eb; }
    </style>
  </head>
  <body class="p-6 bg-gray-100 text-[9px]">
    <div class="max-w-7xl mx-auto bg-white p-6 rounded shadow">
      <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
        <h1 class="text-xl font-bold text-green-800">
          üìä Material Requirement
        </h1>
        <div class="flex items-center gap-2">
          <button
            id="manualAddBtn"
            onclick="openManualModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow"
          >
            ‚ûï Manual Material Requirement
          </button>
          <button
            onclick="exportToExcel()"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow"
          >
            üì§ Export
          </button>
        </div>
      </div>

      <!-- Filter -->
      <div class="flex flex-wrap items-center gap-4 mb-4">
        <div>
          <label
            for="fromDate"
            class="block text-[12px] font-medium text-gray-700"
            >üìÖ From:</label
          >
          <input
            type="date"
            id="fromDate"
            class="border border-gray-300 rounded px-2 py-1 text-[12px]"
            onchange="applyFilters()"
          />
        </div>
        <div>
          <label
            for="toDate"
            class="block text-[12px] font-medium text-gray-700"
            >üìÖ To:</label
          >
          <input
            type="date"
            id="toDate"
            class="border border-gray-300 rounded px-2 py-1 text-[12px]"
            onchange="applyFilters()"
          />
        </div>
        <div class="self-end">
          <button
            onclick="clearDateRangeFilter()"
            class="bg-yellow-500 text-white px-4 py-2 rounded"
          >
            ‚ôªÔ∏è Clear Filter
          </button>
        </div>
      </div>

      <div class="mb-4">
        <input
          type="text"
          id="searchInput"
          oninput="applyFilters()"
          placeholder="üîé Search anything..."
          class="w-full border px-3 py-2 rounded"
        />
      </div>

      <div
        class="overflow-x-auto max-h-[75vh] overflow-y-auto border border-gray-300 rounded-lg shadow-sm"
      >
        <table class="min-w-full bg-white border border-gray-300 table-auto">
          <thead class="sticky top-0 z-10 bg-gray-100 text-gray-700 uppercase tracking-wide text-[10px]">
            <tr>
              <th>Engineer</th>
              <th>Region</th>
              <th>RO Code</th>
              <th>RO Name</th>
              <th>Phase</th>
              <th>Date Of Visit</th>
              <th>Required Material</th>
              <th>Material Dispatch Status</th>
              <th>Material Request To</th>
              <th>Material Request Date</th>
              <th>Material Arrange From</th>
              <th>Material Received Date</th>
              <th id="actionHeader">Action</th>
            </tr>
          </thead>

          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Edit Modal -->
    <div
      id="editModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50"
    >
      <div class="bg-white p-6 rounded shadow-lg w-[90%] max-w-md">
        <h2 class="text-lg font-semibold mb-4 text-green-700">
          Edit Material Entry
        </h2>
        <input type="hidden" id="editId" />
        <input type="hidden" id="editRoCode" />
        <input type="hidden" id="editDate" />
        <input type="hidden" id="editEngineer" />
        <div class="grid grid-cols-1 gap-3">
          <!-- Readonly context fields -->
          <label class="text-[12px] text-gray-700" for="roEngineer"
            >Engineer</label
          >
          <input
            id="roEngineer"
            class="border p-2 rounded bg-gray-100"
            readonly
          />

          <label class="text-[12px] text-gray-700" for="roRegion">Region</label>
          <input
            id="roRegion"
            class="border p-2 rounded bg-gray-100"
            readonly
          />

          <label class="text-[12px] text-gray-700" for="roName">RO Name</label>
          <input id="roName" class="border p-2 rounded bg-gray-100" readonly />

          <label class="text-[12px] text-gray-700" for="roPhase">Phase</label>
          <input id="roPhase" class="border p-2 rounded bg-gray-100" readonly />

          <label class="text-[12px] text-gray-700" for="roDate"
            >Date Of Visit</label
          >
          <input id="roDate" class="border p-2 rounded bg-gray-100" readonly />

          <label class="text-[12px] text-gray-700" for="roMaterial"
            >Required Material</label
          >
          <input
            id="roMaterial"
            class="border p-2 rounded bg-gray-100"
            readonly
          />

          <!-- Editable fields -->
          <label class="text-[12px] text-gray-700" for="editDispatchStatus"
            >Material Dispatch Status</label
          >
          <input id="editDispatchStatus" class="border p-2 rounded" />

          <label class="text-[12px] text-gray-700" for="editRequestTo"
            >Material Request To</label
          >
          <input id="editRequestTo" class="border p-2 rounded" />

          <label class="text-[12px] text-gray-700" for="editRequestDate"
            >Material Request Date</label
          >
          <input type="date" id="editRequestDate" class="border p-2 rounded" />

          <label class="text-[12px] text-gray-700" for="editArrangeFrom"
            >Material Arrange From</label
          >
          <input id="editArrangeFrom" class="border p-2 rounded" />

          <label class="text-[12px] text-gray-700" for="editReceivedDate"
            >Material Received Date</label
          >
          <input type="date" id="editReceivedDate" class="border p-2 rounded" />
        </div>
        <div class="flex justify-end gap-3 mt-4">
          <button
            onclick="closeModal()"
            class="bg-gray-500 text-white px-4 py-2 rounded"
          >
            Cancel
          </button>
          <button
            onclick="saveEdit()"
            class="bg-green-600 text-white px-4 py-2 rounded"
          >
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- Loader Spinner -->
    <div
      id="loader"
      class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden"
    >
      <div
        class="w-12 h-12 border-4 border-white border-t-blue-600 rounded-full animate-spin"
      ></div>
    </div>

    <!-- Manual Add Modal -->
    <div
      id="manualModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50"
    >
      <div class="bg-white p-6 rounded shadow-lg w-[90%] max-w-lg">
        <h2 class="text-lg font-semibold mb-4 text-blue-700">
          Manual Material Requirement
        </h2>
        <div class="grid grid-cols-2 gap-3 text-[12px]">
          <div class="col-span-1">
            <label class="text-gray-700">Engineer</label>
            <input id="manualEngineer" class="border p-2 rounded w-full" />
          </div>
          <div class="col-span-1">
            <label class="text-gray-700">Region</label>
            <input id="manualRegion" class="border p-2 rounded w-full" />
          </div>
          <div class="col-span-1">
            <label class="text-gray-700">RO Code</label>
            <input id="manualRoCode" class="border p-2 rounded w-full" />
          </div>
          <div class="col-span-1">
            <label class="text-gray-700">RO Name</label>
            <input id="manualRoName" class="border p-2 rounded w-full" />
          </div>
          <div class="col-span-1">
            <label class="text-gray-700">Phase</label>
            <input id="manualPhase" class="border p-2 rounded w-full" />
          </div>
          <div class="col-span-1">
            <label class="text-gray-700">Date Of Visit</label>
            <input type="date" id="manualDate" class="border p-2 rounded w-full" />
          </div>
          <div class="col-span-2">
            <label class="text-gray-700">Required Material</label>
            <input id="manualMaterial" class="border p-2 rounded w-full" />
          </div>
          <div class="col-span-2 grid grid-cols-2 gap-3">
            <div>
              <label class="text-gray-700">Material Dispatch Status</label>
              <input id="manualDispatchStatus" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-gray-700">Material Request To</label>
              <input id="manualRequestTo" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-gray-700">Material Request Date</label>
              <input type="date" id="manualRequestDate" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-gray-700">Material Arrange From</label>
              <input id="manualArrangeFrom" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-gray-700">Material Received Date</label>
              <input type="date" id="manualReceivedDate" class="border p-2 rounded w-full" />
            </div>
          </div>
        </div>
        <div class="flex justify-end gap-3 mt-4">
          <button onclick="closeManualModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
          <button onclick="saveManual()" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
        </div>
      </div>
    </div>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      const token = localStorage.getItem("token");
      let allData = [],
        filtered = [];
      let currentUser = null;
      let currentEditingRow = null;

      function showLoader() {
        document.getElementById("loader").classList.remove("hidden");
      }

      function hideLoader() {
        document.getElementById("loader").classList.add("hidden");
      }

      async function fetchData() {
        showLoader();

        const [hpclRes, jioRes, planRes, materialRes, userRes] =
          await Promise.all([
            fetch(`${baseUrl}/getMergedStatusRecords`, {
              headers: { Authorization: `Bearer ${token}` },
            }),
            fetch(`${baseUrl}/jioBP/getAllJioBPStatus`, {
              headers: { Authorization: `Bearer ${token}` },
            }),
            fetch(`${baseUrl}/getDailyPlans`, {
              headers: { Authorization: `Bearer ${token}` },
            }),
            fetch(`${baseUrl}/materialRequirement`, {
              headers: { Authorization: `Bearer ${token}` },
            }),
            fetch(`${baseUrl}/user`, {
              headers: { Authorization: `Bearer ${token}` },
            }),
          ]);

        const hpclData = await hpclRes.json();
        const jioData = await jioRes.json();
        const planData = await planRes.json();
        const materialData = await materialRes.json();
        currentUser = await userRes.json();

        // Hide Action column for engineers
        const role = String(currentUser?.role || "").toLowerCase();
        if (role === "engineer") {
          const actionHeader = document.getElementById("actionHeader");
          if (actionHeader) actionHeader.classList.add("hidden");
        }

        const planMap = {};
        planData.forEach((p) => {
          const key = p._id?.toString();
          if (key) planMap[key] = p;
        });

        const mergedData = [...hpclData, ...jioData].map((record) => {
          const planKey =
            typeof record.planId === "object" && record.planId._id
              ? record.planId._id.toString()
              : record.planId?.toString();

          const plan = planMap[planKey];

          const matchedMaterial = materialData.find(
            (mat) =>
              mat.roCode?.trim() === plan?.roCode?.trim() &&
              mat.date?.trim() === plan?.date?.trim() &&
              mat.engineer?.trim() === plan?.engineer?.trim()
          );

          return {
            ...record,
            engineer: plan?.engineer || "",
            region: plan?.region || "",
            roCode: plan?.roCode || "",
            roName: plan?.roName || "",
            phase: plan?.phase || "",
            date: plan?.date || "",
            material:
              record.materialRequirement || record.spareRequirmentname || "",

            // üîó Add backend ID for update
            _id: matchedMaterial?._id || null,
            materialDispatchStatus:
              matchedMaterial?.materialDispatchStatus || "",
            materialRequestTo: matchedMaterial?.materialRequestTo || "",
            materialRequestDate: matchedMaterial?.materialRequestDate || "",
            materialArrangeFrom: matchedMaterial?.materialArrangeFrom || "",
            materialReceivedDate: matchedMaterial?.materialReceivedDate || "",
          };
        });

        allData = mergedData;
        applyFilters();
      }

      function openManualModal() {
        const engineerName = currentUser?.engineerName || currentUser?.username || "";
        const role = String(currentUser?.role || "").toLowerCase();
        if (role === "engineer") return; // safety
        document.getElementById("manualEngineer").value = engineerName;
        document.getElementById("manualModal").classList.remove("hidden");
      }

      function closeManualModal() {
        document.getElementById("manualModal").classList.add("hidden");
      }

      function saveManual() {
        const payload = {
          engineer: document.getElementById("manualEngineer").value || "",
          region: document.getElementById("manualRegion").value || "",
          roCode: document.getElementById("manualRoCode").value || "",
          roName: document.getElementById("manualRoName").value || "",
          phase: document.getElementById("manualPhase").value || "",
          date: document.getElementById("manualDate").value || "",
          material: document.getElementById("manualMaterial").value || "",
          materialDispatchStatus: document.getElementById("manualDispatchStatus").value || "",
          materialRequestTo: document.getElementById("manualRequestTo").value || "",
          materialRequestDate: document.getElementById("manualRequestDate").value || "",
          materialArrangeFrom: document.getElementById("manualArrangeFrom").value || "",
          materialReceivedDate: document.getElementById("manualReceivedDate").value || "",
        };

        if (!payload.roCode || !payload.date || !payload.engineer || !payload.material) {
          alert("Engineer, RO Code, Date and Required Material are mandatory.");
          return;
        }

        fetch(`${baseUrl}/materialRequirement`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        })
          .then(async (res) => {
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.message || "Save failed");
            closeManualModal();
            fetchData();
          })
          .catch((err) => {
            alert("Failed to save entry");
            console.error(err);
          });
      }

      function applyFilters() {
        const searchText = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;

        filtered = allData.filter((item) => {
          const matchDate =
            (!fromDate || new Date(item.date) >= new Date(fromDate)) &&
            (!toDate || new Date(item.date) <= new Date(toDate));
          const matchSearch = Object.values(item).some((val) =>
            val?.toLowerCase?.().includes(searchText)
          );

          const isJio =
            item.spareRequired === "Yes" && item.materialRequirement?.trim();
          const isHpcl =
            item.spareRequirment === "Yes" && item.spareRequirmentname?.trim();
          const isVerified =
            item.isVerified === true || item.isVerified === "true";

          const role = String(currentUser?.role || "").toLowerCase();
          const isOwner =
            String(item.engineer || "")
              .trim()
              .toLowerCase() ===
            String(currentUser?.engineerName || currentUser?.username || "")
              .trim()
              .toLowerCase();

          return (
            matchDate &&
            matchSearch &&
            (isJio || isHpcl) &&
            isVerified &&
            (role === "admin" || isOwner)
          );
        });

        renderTable();
        hideLoader();
      }

      function renderTable() {
        showLoader();
        setTimeout(() => {
          const tbody = document.getElementById("tableBody");
          const role = String(currentUser?.role || "").toLowerCase();
          const canEdit = role !== "engineer";

          // Hide Manual button for engineers
          const manualBtn = document.getElementById("manualAddBtn");
          if (manualBtn) {
            if (canEdit) manualBtn.classList.remove("hidden");
            else manualBtn.classList.add("hidden");
          }

          tbody.innerHTML = filtered
            .map((row) => {
              const editBtn = canEdit
                ? `<button class="bg-blue-500 text-white px-2 py-1 rounded mr-1" onclick="editRow('${
                    row._id || ""
                  }', '${row.roCode}', '${row.date}', '${
                    row.engineer
                  }')">‚úèÔ∏è</button>`
                : "";
              const delBtn = canEdit
                ? `<button class="bg-red-600 text-white px-2 py-1 rounded mr-1" onclick="deleteRowWrapper('${
                    row._id || ""
                  }', '${row.roCode}', '${String(row.date || "").slice(0, 10)}', '${
                    row.engineer
                  }')">üóëÔ∏è</button>`
                : "";
              return `
          <tr class="border-b text-center hover:bg-gray-50">
            <td>${row.engineer}</td>
            <td>${row.region}</td>
            <td>${row.roCode}</td>
            <td>${row.roName}</td>
            <td>${row.phase}</td>
            <td>${row.date}</td>
            <td class="text-red-900 font-bold">${row.material}</td>
            <td>${row.materialDispatchStatus || "-"}</td>
            <td>${row.materialRequestTo || "-"}</td>
            <td>${row.materialRequestDate || "-"}</td>
            <td>${row.materialArrangeFrom || "-"}</td>
            <td>${row.materialReceivedDate || "-"}</td>
            ${canEdit ? `<td>${editBtn} ${delBtn}</td>` : ""}
          </tr>`;
            })
            .join("");
          hideLoader();
        }, 100);
      }

      function exportToExcel() {
        if (filtered.length === 0) return alert("No data to export");
        const rows = filtered.map((row) => ({
          Engineer: row.engineer,
          Region: row.region,
          "RO Code": row.roCode,
          "RO Name": row.roName,
          Phase: row.phase,
          Date: row.date,
          "Required Material": row.material,
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Material Requirement");
        XLSX.writeFile(wb, "Material_Requirement_Report.xlsx");
      }

      function clearDateRangeFilter() {
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";
        applyFilters();
      }
      function editRow(id, roCode, date, engineer) {
        let row = id ? filtered.find((r) => r._id === id) : null;

        // Fallback: strict match by RO Code + Date + Engineer
        if (!row) {
          row = filtered.find(
            (r) =>
              String(r.roCode || "").trim() === String(roCode || "").trim() &&
              String(r.date || "").slice(0, 10) ===
                String(date || "").slice(0, 10) &&
              String(r.engineer || "")
                .trim()
                .toLowerCase() ===
                String(engineer || "")
                  .trim()
                  .toLowerCase()
          );
        }
        if (!row) {
          alert("No matching row found");
          return;
        }
        currentEditingRow = row;

        if (!row) return alert("Row not found!");

        document.getElementById("editId").value = row._id || ""; // empty for new
        document.getElementById("editRoCode").value = row.roCode || "";
        document.getElementById("editDate").value = String(
          row.date || ""
        ).slice(0, 10);
        document.getElementById("editEngineer").value = row.engineer || "";
        // Fill readonly context
        document.getElementById("roEngineer").value = row.engineer || "";
        document.getElementById("roRegion").value = row.region || "";
        document.getElementById("roName").value = row.roName || "";
        document.getElementById("roPhase").value = row.phase || "";
        document.getElementById("roDate").value = String(row.date || "").slice(
          0,
          10
        );
        document.getElementById("roMaterial").value = row.material || "";
        document.getElementById("editDispatchStatus").value =
          row.materialDispatchStatus || "";
        document.getElementById("editRequestTo").value =
          row.materialRequestTo || "";
        document.getElementById("editRequestDate").value =
          row.materialRequestDate || "";
        document.getElementById("editArrangeFrom").value =
          row.materialArrangeFrom || "";
        document.getElementById("editReceivedDate").value =
          row.materialReceivedDate || "";

        // ‚úÖ Show modal
        document.getElementById("editModal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("editModal").classList.add("hidden");
      }

      function saveEdit() {
        const id = document.getElementById("editId").value;
        const current = filtered.find((r) => r._id === id);
        let target = current || currentEditingRow;
        if (!target) {
          // If new, match by key triplet to update existing or create
          const roCode = document.getElementById("editRoCode")?.value || "";
          const date = document.getElementById("editDate")?.value || "";
          const engineer = document.getElementById("editEngineer")?.value || "";
          target = filtered.find(
            (r) =>
              String(r.roCode || "").trim() === String(roCode || "").trim() &&
              String(r.date || "").slice(0, 10) ===
                String(date || "").slice(0, 10) &&
              String(r.engineer || "")
                .trim()
                .toLowerCase() ===
                String(engineer || "")
                  .trim()
                  .toLowerCase()
          );
        }

        const updatedData = {
          materialDispatchStatus:
            document.getElementById("editDispatchStatus").value,
          materialRequestTo: document.getElementById("editRequestTo").value,
          materialRequestDate: document.getElementById("editRequestDate").value,
          materialArrangeFrom: document.getElementById("editArrangeFrom").value,
          materialReceivedDate:
            document.getElementById("editReceivedDate").value,
          engineer: target?.engineer || "",
          region: target?.region || "",
          roCode: target?.roCode || "",
          roName: target?.roName || "",
          phase: target?.phase || "",
          date: target?.date || "",
          material: target?.material || "",
        };

        const method = id ? "PUT" : "POST";
        const url = id
          ? `${baseUrl}/materialRequirement/${id}`
          : `${baseUrl}/materialRequirement`;

        fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(updatedData),
        })
          .then(async (res) => {
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.message || "Save failed");
            closeModal();
            fetchData(); // refresh table
          })
          .catch((err) => {
            alert("Failed to save entry");
            console.error(err);
          });
      }

      function deleteRow(id) {
        if (confirm("Are you sure you want to delete this entry?")) {
          fetch(`${baseUrl}/materialRequirement/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          })
            .then((res) => res.json())
            .then(() => fetchData())
            .catch((err) => alert("Delete failed"));
        }
      }

      async function deleteRowWrapper(id, roCode, date, engineer) {
        if (!confirm("Are you sure you want to delete this entry?")) return;
        try {
          if (id) {
            const res = await fetch(`${baseUrl}/materialRequirement/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error("Delete failed");
            await fetchData();
            return;
          }
          // Lookup by keys to find _id
          const keyMatch = filtered.find(
            (r) =>
              String(r.roCode || "").trim() === String(roCode || "").trim() &&
              String(r.date || "").slice(0, 10) ===
                String(date || "").slice(0, 10) &&
              String(r.engineer || "")
                .trim()
                .toLowerCase() ===
                String(engineer || "")
                  .trim()
                  .toLowerCase()
          );
          const lookupId = keyMatch?._id;
          if (!lookupId) {
            alert("No saved entry found for delete");
            return;
          }
          const res2 = await fetch(
            `${baseUrl}/materialRequirement/${lookupId}`,
            {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (!res2.ok) throw new Error("Delete failed");
          await fetchData();
        } catch (e) {
          alert("Delete failed");
          console.error(e);
        }
      }

      fetchData();
    </script>
  </body>
</html>
