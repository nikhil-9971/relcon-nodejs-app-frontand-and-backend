<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RO Master ‚Äî Records</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* Keep same base look & font-size as statusRecords.html */
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 12px;
      }
      .page-body {
        padding: 18px;
        font-size: 9px;
        color: #1f2937;
      }

      .card {
        background: white;
        padding: 14px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
      }

      .muted {
        color: #6b7280;
        font-size: 12px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px;
      }
      th,
      td {
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
        white-space: nowrap;
      }
      thead th {
        position: sticky;
        top: 0;
        background: #f3f4f6;
        z-index: 2;
        text-align: center;
      }
      tbody tr:nth-child(even) {
        background: #f8fafc;
      }

      .filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 10px;
      }
      .filters .control {
        display: flex;
        flex-direction: column;
        font-size: 11px;
      }
      .btn {
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
      }
      .btn-primary {
        background: #16a34a;
        color: white;
      }
      .btn-muted {
        background: #f3f4f6;
        color: #111827;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .modal {
        background: white;
        padding: 14px;
        border-radius: 8px;
        width: 95%;
        max-width: 760px;
        max-height: 85vh;
        overflow: auto;
        font-size: 12px;
      }

      .hidden {
        display: none;
      }

      .toast {
        position: fixed;
        top: 16px;
        right: 16px;
        background: #16a34a;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        z-index: 10000;
        display: none;
      }

      /* small action buttons */
      .action-btn {
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 11px;
        margin: 2px;
      }
      .action-edit {
        background: #f59e0b;
        color: white;
        border: none;
      }
      .action-delete {
        background: #ef4444;
        color: white;
        border: none;
      }
      .action-refresh {
        background: #10b981;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
      }

      /* pagination */
      #pagination {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: center;
        margin-top: 12px;
      }
      #pagination button {
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: #f3f4f6;
        cursor: pointer;
      }
      #pagination button.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }

      /* loader */
      #loader {
        position: fixed;
        inset: 0;
        background: rgba(11, 15, 23, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
      }
      #loader.hidden {
        display: none;
      }
      .spinner {
        width: 64px;
        height: 64px;
        border: 6px solid rgba(255, 255, 255, 0.15);
        border-top-color: #60a5fa;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* empty state */
      .empty-message {
        padding: 32px;
        text-align: center;
        color: #6b7280;
        font-size: 13px;
      }
    </style>
  </head>

  <body class="page-body">
    <div class="card max-w-7xl mx-auto">
      <div
        style="
          display: flex;
          justify-content: space-between;
          gap: 12px;
          align-items: center;
        "
      >
        <div>
          <h2 style="margin: 0; font-size: 14px; font-weight: 600">
            üìã RO Master Records
          </h2>
          <div class="muted">
            Search, filter & paginate RO Master. UI behavior matches Status
            Records page.
          </div>
        </div>

        <div style="display: flex; gap: 8px; align-items: center">
          <button id="refreshBtn" class="action-refresh">
            <i class="fa-solid fa-sync"></i> Refresh
          </button>
        </div>
      </div>

      <!-- Filters / Search -->
      <div class="filters" style="margin-top: 12px">
        <div class="control" style="min-width: 160px">
          <label class="muted">üîé Search</label>
          <input
            id="searchInput"
            type="text"
            placeholder="Search RO Code / RO Name / Region / Engineer..."
            class="border px-2 py-1 rounded"
            oninput="debouncedApplyFilters()"
          />
        </div>

        <div class="control">
          <label class="muted">Zone</label>
          <select
            id="zoneFilter"
            class="border px-2 py-1 rounded"
            onchange="applyFilters()"
          >
            <option value="">All Zones</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Engineer</label>
          <select
            id="engineerFilter"
            class="border px-2 py-1 rounded"
            onchange="applyFilters()"
          >
            <option value="">All Engineers</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Phase</label>
          <select
            id="phaseFilter"
            class="border px-2 py-1 rounded"
            onchange="applyFilters()"
          >
            <option value="">All Phases</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Site Status</label>
          <select
            id="siteStatusFilter"
            class="border px-2 py-1 rounded"
            onchange="applyFilters()"
          >
            <option value="">All Status</option>
            <option>AMC</option>
            <option>PROJECT</option>
            <option>WARRANTY</option>
            <option>OTHER</option>
          </select>
        </div>

        <div
          style="
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
          "
        >
          <button onclick="clearFilters()" class="btn btn-muted">
            ‚ôªÔ∏è Clear
          </button>
          <button onclick="exportROMasterCSV()" class="btn btn-primary">
            üì§ Export CSV
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-auto" style="max-height: 65vh; margin-top: 10px">
        <table id="romasterTable" class="min-w-full table-auto">
          <thead>
            <tr id="tableHeader"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div id="emptyState" class="empty-message hidden">No records found.</div>
      </div>

      <div id="pagination"></div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden">
      <div class="modal-backdrop">
        <div class="modal">
          <h3 style="margin-top: 0">Edit RO Master</h3>
          <div id="editForm"></div>
          <div
            style="
              display: flex;
              justify-content: flex-end;
              gap: 8px;
              margin-top: 12px;
            "
          >
            <button id="cancelEdit" class="btn btn-muted">Cancel</button>
            <button id="saveEdit" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div id="loader" class="hidden" aria-hidden="true">
      <div class="spinner" role="status" aria-label="Loading"></div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
      const baseUrl = "https://relcon-backend-jwt-backup.onrender.com";
      const token = localStorage.getItem("token");
      let allData = [];
      let filteredData = [];
      let currentPage = 1;
      const rowsPerPage = 50;
      let latestStatusMap = {};

      // COLUMNS: inserted lastVisitDate immediately after siteStatus
      const columns = [
        { key: "roCode", label: "RO Code" },
        { key: "roName", label: "RO Name" },
        { key: "zone", label: "Zone" },
        { key: "region", label: "Region" },
        { key: "phase", label: "Phase" },
        { key: "engineer", label: "Engineer" },
        { key: "amcQtr", label: "AMC Qtr" },
        { key: "siteStatus", label: "Site Status" },
        { key: "lastVisitDate", label: "Last Visit Date" },
        { key: "bosIP", label: "BOS IP" },
        { key: "fccIP", label: "FCC IP" },
        { key: "siteActivestatus", label: "Site Active Status" },
        { key: "lastAMCqtr", label: "Last AMC Qtr" },
        { key: "actions", label: "Actions" },
      ];

      function showLoader() {
        const el = document.getElementById("loader");
        if (el) el.classList.remove("hidden");
      }
      function hideLoader() {
        const el = document.getElementById("loader");
        if (el) el.classList.add("hidden");
      }
      function showToast(msg = "Done") {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.display = "block";
        setTimeout(() => (t.style.display = "none"), 3000);
      }

      function debounce(fn, ms = 120) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      const debouncedApplyFilters = debounce(() => applyFilters(), 120);

      async function getCurrentUser() {
        try {
          if (!token) {
            // ensure login redirect
            window.location.href = "login.html";
            return null;
          }
          const res = await fetch(baseUrl + "/user", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) return null;
          return await res.json();
        } catch (e) {
          return null;
        }
      }

      async function fetchROMasterList() {
        const candidates = [
          "/romaster/list",
          "/romaster/all",
          "/romaster",
          "/api/romaster",
          "/api/romaster/list",
          "/romaster/getAll",
        ];
        for (const path of candidates) {
          try {
            const res = await fetch(baseUrl + path, {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) continue;
            const data = await res.json();
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.data)) return data.data;
          } catch (err) {}
        }
        return null;
      }

      // getMergedStatusRecords returns merged status entries (we pick latest by date)
      async function fetchLatestStatusMap() {
        try {
          const res = await fetch(baseUrl + "/getMergedStatusRecords", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) return {};
          const statuses = await res.json();
          const map = {};
          statuses.forEach((s) => {
            const rc = (s.roCode || "").toString().trim().toUpperCase();
            const d = s.date ? new Date(s.date) : new Date(0);
            const ts = isNaN(d.getTime()) ? 0 : d.getTime();
            const existing = map[rc];
            if (!existing || (existing._ts || 0) < ts) {
              map[rc] = Object.assign({}, s, { _ts: ts });
            }
          });
          return map;
        } catch (err) {
          console.error("Failed to fetch merged status records:", err);
          return {};
        }
      }

      // Fallback: for codes missing in merged, call getLastVisit per code (fixes sparse cases)
      async function fetchMissingLastVisits(missingCodes) {
        const results = {};
        await Promise.all(
          missingCodes.map(async (code) => {
            try {
              const res = await fetch(
                `${baseUrl}/getLastVisit/${encodeURIComponent(code)}`,
                { headers: { Authorization: `Bearer ${token}` } }
              );
              if (!res.ok) {
                results[code] = { date: "", lastPurpose: "" };
                return;
              }
              const json = await res.json();
              results[code] = { date: json.lastDate || "", lastPurpose: json.lastPurpose || "" };
            } catch (e) {
              results[code] = { date: "", lastPurpose: "" };
            }
          })
        );
        return results;
      }

      function formatVisitDate(d) {
        if (!d) return "";
        const dateObj = typeof d === "string" || typeof d === "number" ? new Date(d) : d;
        if (!dateObj || isNaN(dateObj.getTime())) return String(d);
        return dateObj.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
      }

      async function loadData() {
        showLoader();
        currentPage = 1;
        const user = await getCurrentUser();
        if (!user) {
          hideLoader();
          document.getElementById("tableBody").innerHTML =
            `<tr><td colspan="${columns.length}" class="muted">Not authenticated. Please login.</td></tr>`;
          return;
        }

        try {
          localStorage.setItem("user", JSON.stringify(user));
        } catch (e) {}

        const data = await fetchROMasterList();
        if (!data) {
          hideLoader();
          document.getElementById("tableBody").innerHTML =
            `<tr><td colspan="${columns.length}" class="muted">Failed to fetch RO Master data. Backend endpoint not found.</td></tr>`;
          return;
        }

        allData = data;

        // 1) try merged statuses first (fast / comprehensive)
        latestStatusMap = await fetchLatestStatusMap();

        // 2) find roCodes missing a latest entry and call fallback endpoint in small batches
        const allCodes = Array.from(
          new Set(
            allData
              .map((r) => (r.roCode || "").toString().trim().toUpperCase())
              .filter((c) => c)
          )
        );

        const missing = allCodes.filter((c) => !latestStatusMap[c]);
        if (missing.length > 0) {
          // process in batches of 50 to avoid too many parallel requests
          const batchSize = 50;
          for (let i = 0; i < missing.length; i += batchSize) {
            const batch = missing.slice(i, i + batchSize);
            const batchRes = await fetchMissingLastVisits(batch);
            // merge results into latestStatusMap (only providing date & lastPurpose)
            Object.keys(batchRes).forEach((code) => {
              if (!latestStatusMap[code]) {
                latestStatusMap[code] = {
                  date: batchRes[code].date,
                  visitDate: batchRes[code].date,
                  lastPurpose: batchRes[code].lastPurpose,
                  _ts: batchRes[code].date ? new Date(batchRes[code].date).getTime() : 0,
                };
              }
            });
          }
        }

        populateFilters(allData);

        const isAdmin = user.role === "admin";
        if (!isAdmin) {
          const name = (user.engineerName || user.username || "").trim().toLowerCase();
          filteredData = allData.filter((r) => (r.engineer || "").trim().toLowerCase() === name);
        } else {
          filteredData = allData.slice();
        }

        renderTable(filteredData);
      }

      function populateFilters(rows) {
        const zones = new Set(),
          engs = new Set(),
          phases = new Set();
        rows.forEach((r) => {
          if (r.zone) zones.add(r.zone);
          if (r.engineer) engs.add(r.engineer);
          if (r.phase) phases.add(r.phase);
        });

        const zoneSel = document.getElementById("zoneFilter");
        zoneSel.innerHTML = '<option value="">All Zones</option>';
        Array.from(zones).sort().forEach((z) => zoneSel.innerHTML += `<option>${z}</option>`);

        const engSel = document.getElementById("engineerFilter");
        engSel.innerHTML = '<option value="">All Engineers</option>';
        Array.from(engs).sort().forEach((e) => engSel.innerHTML += `<option>${e}</option>`);

        const phaseSel = document.getElementById("phaseFilter");
        phaseSel.innerHTML = '<option value="">All Phases</option>';
        Array.from(phases).sort().forEach((p) => phaseSel.innerHTML += `<option>${p}</option>`);
      }

      function applySearch() {
        currentPage = 1;
        applyFilters();
      }

      function applyFilters() {
        setTimeout(() => {
          const q = document.getElementById("searchInput").value.trim().toLowerCase();
          const zone = document.getElementById("zoneFilter").value;
          const eng = document.getElementById("engineerFilter").value;
          const phase = document.getElementById("phaseFilter").value;
          const status = document.getElementById("siteStatusFilter").value;

          const user = JSON.parse(localStorage.getItem("user") || "null") || {};
          const isAdmin = user.role === "admin";
          let base = allData.slice();

          if (!isAdmin) {
            const name = (user.engineerName || user.username || "").trim().toLowerCase();
            base = base.filter((r) => (r.engineer || "").trim().toLowerCase() === name);
          }

          const out = base.filter((r) => {
            if (zone && (r.zone || "") !== zone) return false;
            if (eng && (r.engineer || "") !== eng) return false;
            if (phase && (r.phase || "") !== phase) return false;
            if (status && (r.siteStatus || "") !== status) return false;
            if (q) {
              const values = Object.values(r).map((v) => String(v).toLowerCase());
              return values.some((val) => val.includes(q));
            }
            return true;
          });

          filteredData = out;
          renderTable(filteredData);
        }, 60);
      }

      function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("zoneFilter").value = "";
        document.getElementById("engineerFilter").value = "";
        document.getElementById("phaseFilter").value = "";
        document.getElementById("siteStatusFilter").value = "";
        applyFilters();
      }

      function renderTable(data) {
        showLoader();
        const start = (currentPage - 1) * rowsPerPage;
        const pageData = data.slice(start, start + rowsPerPage);
        requestAnimationFrame(() => {
          setTimeout(() => {
            _renderTableNow(pageData);
            renderPagination(data.length);
            // small delay so user sees spinner until DOM paints
            requestAnimationFrame(() => setTimeout(() => hideLoader(), 40));
          }, 0);
        });
      }

      function _renderTableNow(data) {
        const header = document.getElementById("tableHeader");
        header.innerHTML = columns.map((c) => `<th>${c.label}</th>`).join("");
        const tbody = document.getElementById("tableBody");
        const user = JSON.parse(localStorage.getItem("user") || "null") || {};
        const role = user.role || "";

        if (!data || data.length === 0) {
          tbody.innerHTML = "";
          document.getElementById("emptyState").classList.remove("hidden");
          return;
        } else {
          document.getElementById("emptyState").classList.add("hidden");
        }

        tbody.innerHTML = data.map((row) => {
          const id = row._id || row.roCode || "";
          const rcUpper = (row.roCode || "").toString().trim().toUpperCase();
          const latest = latestStatusMap[rcUpper] || {};
          const lastVisit = latest.date || latest.visitDate || "";

          const cells = columns.map((col) => {
            if (col.key === "actions") {
              let actions = "";
              if (role === "admin") {
                actions = `<button class="action-btn action-edit" onclick='openEdit("${id}")'><i class="fa-solid fa-edit"></i></button>
                           <button class="action-btn action-delete" onclick='confirmDelete("${id}")'><i class="fa-solid fa-trash"></i></button>`;
              }
              return `<td style="text-align:center">${actions}</td>`;
            }
            if (col.key === "lastVisitDate") {
              return `<td style="text-align:left">${escapeHtml(formatVisitDate(lastVisit))}</td>`;
            }
            if (col.key === "bosIP") {
              const v = latest.bosIP || row.bosIP || "";
              return `<td style="text-align:left">${escapeHtml(v)}</td>`;
            }
            if (col.key === "fccIP") {
              const v = latest.fccIP || row.fccIP || "";
              return `<td style="text-align:left">${escapeHtml(v)}</td>`;
            }
            const val = row[col.key] !== undefined && row[col.key] !== null ? row[col.key] : "";
            return `<td style="text-align:left">${escapeHtml(val)}</td>`;
          }).join("");

          return `<tr data-id="${id}">${cells}</tr>`;
        }).join("");
      }

      function renderPagination(totalRows) {
        const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));
        const container = document.getElementById("pagination");
        container.innerHTML = "";
        const prev = document.createElement("button");
        prev.textContent = "‚¨Ö Prev";
        prev.disabled = currentPage === 1;
        prev.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderTable(filteredData);
          }
        };
        container.appendChild(prev);
        const maxButtons = 7;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage < maxButtons - 1) startPage = Math.max(1, endPage - maxButtons + 1);
        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          if (i === currentPage) btn.classList.add("active");
          btn.onclick = ((p) => () => {
            currentPage = p;
            renderTable(filteredData);
          })(i);
          container.appendChild(btn);
        }
        const next = document.createElement("button");
        next.textContent = "Next ‚û°";
        next.disabled = currentPage === totalPages;
        next.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderTable(filteredData);
          }
        };
        container.appendChild(next);
      }

      function escapeHtml(s) {
        if (s === undefined || s === null) return "";
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // Edit / Save / Delete functions (unchanged)
      let editingId = null;
      async function openEdit(id) {
        const rec = allData.find((r) => r._id === id || r.roCode === id || r.id === id);
        if (!rec) { alert("Record not found"); return; }
        editingId = rec._id || id;
        const form = document.getElementById("editForm");
        form.innerHTML = "";
        const keys = ["zone","roCode","roName","region","phase","engineer","amcQtr","siteStatus","siteActivestatus","lastAMCqtr"];
        keys.forEach((k) => {
          const val = rec[k] || "";
          const readonly = k === "roCode" ? "readonly" : "";
          form.innerHTML += `<div style="display:grid;gap:6px;margin-bottom:6px;"><label class="muted">${k}</label><input name="${k}" value="${escapeHtml(val)}" ${readonly} class="border px-2 py-1 rounded w-full" /></div>`;
        });
        document.getElementById("editModal").classList.remove("hidden");
      }
      document.getElementById("cancelEdit").addEventListener("click", () => {
        document.getElementById("editModal").classList.add("hidden");
        editingId = null;
      });
      document.getElementById("saveEdit").addEventListener("click", saveEdit);
      async function saveEdit() {
        if (!editingId) return alert("No record selected");
        const form = document.getElementById("editForm");
        const inputs = form.querySelectorAll("input");
        const payload = {};
        inputs.forEach((inp) => {
          const name = inp.name;
          let v = inp.value;
          if (name === "roCode" && typeof v === "string") v = v.toUpperCase();
          payload[name] = v;
        });
        const candidates = [`/romaster/update/${editingId}`,`/romaster/${editingId}`,`/api/romaster/update/${editingId}`,`/api/romaster/${editingId}`];
        let success = false;
        for (const path of candidates) {
          try {
            const res = await fetch(baseUrl + path, {
              method: "PUT",
              headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (res.ok) { success = true; break; }
          } catch (e) {}
        }
        if (success) { showToast("Updated successfully ‚úÖ"); document.getElementById("editModal").classList.add("hidden"); editingId = null; await loadData(); }
        else alert("Update failed. Backend may not expose a matching update endpoint.");
      }

      let deleteTarget = null;
      function confirmDelete(id) {
        if (!confirm("Are you sure you want to delete this RO Master record?")) return;
        deleteTarget = id;
        performDelete();
      }
      async function performDelete() {
        if (!deleteTarget) return;
        const candidates = [`/romaster/delete/${deleteTarget}`,`/romaster/${deleteTarget}`,`/api/romaster/delete/${deleteTarget}`,`/api/romaster/${deleteTarget}`];
        let deleted = false;
        for (const path of candidates) {
          try {
            const res = await fetch(baseUrl + path, { method: "DELETE", headers: { Authorization: `Bearer ${token}` }});
            if (res.ok) { deleted = true; break; }
          } catch (e) {}
        }
        if (deleted) { showToast("Deleted ‚úÖ"); await loadData(); }
        else alert("Delete failed. Backend may not expose a matching delete endpoint.");
        deleteTarget = null;
      }

      // Export CSV (include lastVisitDate)
      function exportROMasterCSV() {
        if (!filteredData || filteredData.length === 0) return alert("No data to export");
        const keys = ["roCode","roName","zone","region","phase","engineer","amcQtr","siteStatus","lastVisitDate","bosIP","fccIP","siteActivestatus","lastAMCqtr"];
        const header = keys.join(",");
        const rows = filteredData.map((r) => {
          const rc = (r.roCode || "").toString().trim().toUpperCase();
          const latest = latestStatusMap[rc] || {};
          const values = keys.map((k) => {
            let v = "";
            if (k === "lastVisitDate") v = latest.date || latest.visitDate || "";
            else if (k === "bosIP") v = latest.bosIP || r.bosIP || "";
            else if (k === "fccIP") v = latest.fccIP || r.fccIP || "";
            else v = r[k] || "";
            return `"${String(v).replaceAll('"', '""')}"`;
          });
          return values.join(",");
        });
        const csv = [header, ...rows].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `romaster_export_${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      document.getElementById("refreshBtn").addEventListener("click", () => loadData());
      // initial load
      loadData();
    </script>
  </body>
</html>