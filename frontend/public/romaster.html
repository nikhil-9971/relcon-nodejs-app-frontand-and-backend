<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RO Master ‚Äî Records</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* Keep same base look & font-size as statusRecords.html */
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 12px;
      }
      /* Use same compact text scale used in statusRecords.html page */
      .page-body {
        padding: 18px;
        font-size: 9px; /* match statusRecords.html small UI */
        color: #1f2937;
      }

      .card {
        background: white;
        padding: 14px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
      }

      .muted {
        color: #6b7280;
        font-size: 12px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px;
      }
      th,
      td {
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
        white-space: nowrap;
      }
      thead th {
        position: sticky;
        top: 0;
        background: #f3f4f6;
        z-index: 2;
        text-align: center;
      }
      tbody tr:nth-child(even) {
        background: #f8fafc;
      }

      .filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 10px;
      }
      .filters .control {
        display: flex;
        flex-direction: column;
        font-size: 11px;
      }
      .btn {
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
      }
      .btn-primary {
        background: #16a34a;
        color: white;
      }
      .btn-muted {
        background: #f3f4f6;
        color: #111827;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .modal {
        background: white;
        padding: 14px;
        border-radius: 8px;
        width: 95%;
        max-width: 760px;
        max-height: 85vh;
        overflow: auto;
        font-size: 12px;
      }

      .hidden {
        display: none;
      }

      /* loader */
      #loader {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.28);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .toast {
        position: fixed;
        top: 16px;
        right: 16px;
        background: #16a34a;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        z-index: 10000;
        display: none;
      }

      /* small action buttons */
      .action-btn {
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 11px;
        margin: 2px;
      }
      .action-edit {
        background: #f59e0b;
        color: white;
        border: none;
      }
      .action-delete {
        background: #ef4444;
        color: white;
        border: none;
      }
      .action-refresh {
        background: #10b981;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
      }

      /* pagination */
      #pagination {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: center;
        margin-top: 12px;
      }
      #pagination button {
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: #f3f4f6;
        cursor: pointer;
      }
      #pagination button.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }
    </style>
  </head>

  <body class="page-body">
    <div class="card max-w-7xl mx-auto">
      <div
        style="
          display: flex;
          justify-content: space-between;
          gap: 12px;
          align-items: center;
        "
      >
        <div>
          <h2 style="margin: 0; font-size: 14px; font-weight: 600">
            üìã RO Master Records
          </h2>
          <div class="muted">
            Search, filter & paginate RO Master. UI behavior matches Status
            Records page.
          </div>
        </div>

        <div style="display: flex; gap: 8px; align-items: center">
          <button id="refreshBtn" class="action-refresh">
            <i class="fa-solid fa-sync"></i> Refresh
          </button>
        </div>
      </div>

      <!-- Filters / Search -->
      <div class="filters" style="margin-top: 12px">
        <div class="control" style="min-width: 160px">
          <label class="muted">üîé Search</label>
          <input
            id="searchInput"
            type="text"
            placeholder="Search RO Code / RO Name / Region / Engineer..."
            class="border px-2 py-1 rounded"
            oninput="applySearch()"
          />
        </div>

        <div class="control">
          <label class="muted">Zone</label>
          <select
            id="zoneFilter"
            class="border px-2 py-1 rounded"
            onchange="applyFilters()"
          >
            <option value="">All Zones</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Engineer</label>
          <select
            id="engineerFilter"
            class="border px-2 py-1 rounded"
            onchange="applyFilters()"
          >
            <option value="">All Engineers</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Site Status</label>
          <select
            id="siteStatusFilter"
            class="border px-2 py-1 rounded"
            onchange="applyFilters()"
          >
            <option value="">All Status</option>
            <option>AMC</option>
            <option>PROJECT</option>
            <option>WARRANTY</option>
            <option>OTHER</option>
          </select>
        </div>

        <div
          style="
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
          "
        >
          <button onclick="clearFilters()" class="btn btn-muted">
            ‚ôªÔ∏è Clear
          </button>
          <button onclick="exportROMasterCSV()" class="btn btn-primary">
            üì§ Export CSV
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-auto" style="max-height: 65vh; margin-top: 10px">
        <table id="romasterTable" class="min-w-full table-auto">
          <thead>
            <tr id="tableHeader"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div id="pagination"></div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden">
      <div class="modal-backdrop">
        <div class="modal">
          <h3 style="margin-top: 0">Edit RO Master</h3>
          <div
            id="editForm"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px"
          ></div>

          <div
            style="
              display: flex;
              justify-content: flex-end;
              gap: 8px;
              margin-top: 12px;
            "
          >
            <button id="cancelEdit" class="btn btn-muted">Cancel</button>
            <button id="saveEdit" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loader & Toast -->
    <div id="loader" class="hidden">
      <div
        class="w-12 h-12 border-4 border-white border-t-blue-600 rounded-full animate-spin"
      ></div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
      const baseUrl = "https://relcon-backend-jwt-backup.onrender.com";
      const token = localStorage.getItem("token");
      let allData = [];
      let filteredData = [];
      let currentPage = 1;
      const rowsPerPage = 50;

      // Columns definition similar to statusRecords layout
      const columns = [
        { key: "roCode", label: "RO Code" },
        { key: "roName", label: "RO Name" },
        { key: "zone", label: "Zone" },
        { key: "region", label: "Region" },
        { key: "phase", label: "Phase" },
        { key: "engineer", label: "Engineer" },
        { key: "amcQtr", label: "AMC Qtr" },
        { key: "siteStatus", label: "Site Status" },
        { key: "siteActivestatus", label: "Site Active Status" },
        { key: "lastAMCqtr", label: "Last AMC Qtr" },
        { key: "actions", label: "Actions" },
      ];

      // Helper UI funcs
      function showLoader() {
        const el = document.getElementById("loader");
        if (el) el.classList.remove("hidden");
      }
      function hideLoader() {
        const el = document.getElementById("loader");
        if (el) el.classList.add("hidden");
      }
      function showToast(msg = "Done") {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.display = "block";
        setTimeout(() => (t.style.display = "none"), 3000);
      }

      // Fetch user from backend (used for role checks)
      async function getCurrentUser() {
        try {
          const res = await fetch(baseUrl + "/user", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) return null;
          return await res.json();
        } catch (e) {
          return null;
        }
      }

      // Fetch ROMaster list with fallbacks (same approach as previous romaster.html)
      async function fetchROMasterList() {
        const candidates = [
          "/romaster/list",
          "/romaster/all",
          "/romaster",
          "/api/romaster",
          "/api/romaster/list",
          "/romaster/getAll",
        ];
        for (const path of candidates) {
          try {
            const res = await fetch(baseUrl + path, {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) continue;
            const data = await res.json();
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.data)) return data.data;
          } catch (err) {}
        }
        return null;
      }

      async function loadData() {
        // Show loader before we start network + rendering work
        showLoader();
        currentPage = 1;
        const user = await getCurrentUser();
        if (!user) {
          // hide because we won't render table
          hideLoader();
          document.getElementById("tableBody").innerHTML =
            '<tr><td colspan="' +
            columns.length +
            '" class="muted">Not authenticated. Please login.</td></tr>';
          return;
        }

        const data = await fetchROMasterList();
        if (!data) {
          hideLoader();
          document.getElementById("tableBody").innerHTML =
            '<tr><td colspan="' +
            columns.length +
            '" class="muted">Failed to fetch RO Master data. Backend endpoint not found.</td></tr>';
          return;
        }

        allData = data;
        // Build filter dropdowns
        populateFilters(allData);

        // Default visibility: non-admin see only their engineer rows
        const isAdmin = user.role === "admin";
        if (!isAdmin) {
          const name = (user.engineerName || user.username || "")
            .trim()
            .toLowerCase();
          filteredData = allData.filter(
            (r) => (r.engineer || "").trim().toLowerCase() === name
          );
        } else {
          filteredData = allData.slice();
        }

        // Important: do NOT hide loader here ‚Äî renderTable will hide it after DOM paints
        renderTable(filteredData);
      }

      function populateFilters(rows) {
        // zones and engineers unique lists
        const zones = new Set();
        const engs = new Set();
        rows.forEach((r) => {
          if (r.zone) zones.add(r.zone);
          if (r.engineer) engs.add(r.engineer);
        });

        const zoneSel = document.getElementById("zoneFilter");
        zoneSel.innerHTML = '<option value="">All Zones</option>';
        Array.from(zones)
          .sort()
          .forEach((z) => {
            zoneSel.innerHTML += `<option>${z}</option>`;
          });

        const engSel = document.getElementById("engineerFilter");
        engSel.innerHTML = '<option value="">All Engineers</option>';
        Array.from(engs)
          .sort()
          .forEach((e) => {
            engSel.innerHTML += `<option>${e}</option>`;
          });
      }

      function applySearch() {
        currentPage = 1;
        applyFilters();
      }

      function applyFilters() {
        showLoader();
        setTimeout(() => {
          const q = document
            .getElementById("searchInput")
            .value.trim()
            .toLowerCase();
          const zone = document.getElementById("zoneFilter").value;
          const eng = document.getElementById("engineerFilter").value;
          const status = document.getElementById("siteStatusFilter").value;

          const user = JSON.parse(localStorage.getItem("user")) || {};
          const isAdmin = user.role === "admin";
          let base = allData.slice();

          // Apply role-based restriction: non-admin should only see own engineer
          if (!isAdmin) {
            const name = (user.engineerName || user.username || "")
              .trim()
              .toLowerCase();
            base = base.filter(
              (r) => (r.engineer || "").trim().toLowerCase() === name
            );
          }

          let out = base.filter((r) => {
            if (zone && (r.zone || "") !== zone) return false;
            if (eng && (r.engineer || "") !== eng) return false;
            if (status && (r.siteStatus || "") !== status) return false;

            if (q) {
              const values = Object.values(r).map((v) =>
                String(v).toLowerCase()
              );
              return values.some((val) => val.includes(q));
            }
            return true;
          });

          filteredData = out;
          renderTable(filteredData);
        }, 80);
      }

      function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("zoneFilter").value = "";
        document.getElementById("engineerFilter").value = "";
        document.getElementById("siteStatusFilter").value = "";
        applyFilters();
      }

      // Table render with pagination
      function renderTable(data) {
        // show loader (keep visible until DOM painted)
        showLoader();
        const start = (currentPage - 1) * rowsPerPage;
        const pageData = data.slice(start, start + rowsPerPage);

        // use requestAnimationFrame + setTimeout pattern so we hide loader after paint
        requestAnimationFrame(() => {
          setTimeout(() => {
            _renderTableNow(pageData);
            renderPagination(data.length);

            // ensure browser painted the table before hiding loader
            requestAnimationFrame(() => {
              // tiny delay to make sure paint finished on slower devices
              setTimeout(() => hideLoader(), 30);
            });
          }, 0);
        });
      }

      function _renderTableNow(data) {
        const header = document.getElementById("tableHeader");
        header.innerHTML = columns.map((c) => `<th>${c.label}</th>`).join("");

        const tbody = document.getElementById("tableBody");
        const user = JSON.parse(localStorage.getItem("user")) || {};
        const username = user.username || "";
        const role = user.role || "";

        tbody.innerHTML = data
          .map((row) => {
            const id = row._id || row.roCode || "";
            const cells = columns
              .map((col) => {
                if (col.key === "actions") {
                  let actions = "";
                  if (role === "admin") {
                    actions = `
                  <button class="action-btn action-edit" onclick='openEdit("${id}")'><i class="fa-solid fa-edit"></i></button>
                  <button class="action-btn action-delete" onclick='confirmDelete("${id}")'><i class="fa-solid fa-trash"></i></button>
                `;
                  }
                  return `<td style="text-align:center">${actions}</td>`;
                }
                const val =
                  row[col.key] !== undefined && row[col.key] !== null
                    ? row[col.key]
                    : "";
                return `<td style="text-align:left">${escapeHtml(val)}</td>`;
              })
              .join("");
            return `<tr data-id="${id}">${cells}</tr>`;
          })
          .join("");
      }

      function renderPagination(totalRows) {
        const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));
        const container = document.getElementById("pagination");
        container.innerHTML = "";

        const prev = document.createElement("button");
        prev.textContent = "‚¨Ö Prev";
        prev.disabled = currentPage === 1;
        prev.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderTable(filteredData);
          }
        };
        container.appendChild(prev);

        // limit max page buttons to 7 for compactness
        const maxButtons = 7;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage < maxButtons - 1) {
          startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          if (i === currentPage) btn.classList.add("active");
          btn.onclick = (function (p) {
            return () => {
              currentPage = p;
              renderTable(filteredData);
            };
          })(i);
          container.appendChild(btn);
        }

        const next = document.createElement("button");
        next.textContent = "Next ‚û°";
        next.disabled = currentPage === totalPages;
        next.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderTable(filteredData);
          }
        };
        container.appendChild(next);
      }

      // escape
      function escapeHtml(s) {
        if (s === undefined || s === null) return "";
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // Edit flow
      let editingId = null;
      async function openEdit(id) {
        // find record in allData
        const rec = allData.find(
          (r) => r._id === id || r.roCode === id || r.id === id
        );
        if (!rec) {
          alert("Record not found");
          return;
        }
        editingId = rec._id || id;

        const form = document.getElementById("editForm");
        form.innerHTML = "";

        const keys = [
          "zone",
          "roCode",
          "roName",
          "region",
          "phase",
          "engineer",
          "amcQtr",
          "siteStatus",
          "siteActivestatus",
          "lastAMCqtr",
        ];
        keys.forEach((k) => {
          const val = rec[k] || "";
          const readonly = k === "roCode" ? "readonly" : "";
          form.innerHTML += `
            <div>
              <label class="muted" style="font-size:12px">${k}</label>
              <input name="${k}" value="${escapeHtml(
            val
          )}" ${readonly} class="border px-2 py-1 rounded w-full" />
            </div>
          `;
        });

        document.getElementById("editModal").classList.remove("hidden");
      }

      document
        .getElementById("cancelEdit")
        .addEventListener("click", closeEditModal);
      document.getElementById("saveEdit").addEventListener("click", saveEdit);

      function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
        editingId = null;
      }

      async function saveEdit() {
        if (!editingId) return alert("No record selected");
        const form = document.getElementById("editForm");
        const inputs = form.querySelectorAll("input");
        const payload = {};
        inputs.forEach((inp) => {
          const name = inp.name;
          let v = inp.value;
          if (name === "roCode" && typeof v === "string") v = v.toUpperCase();
          payload[name] = v;
        });

        // attempt update endpoints
        const candidates = [
          `/romaster/update/${editingId}`,
          `/romaster/${editingId}`,
          `/api/romaster/update/${editingId}`,
          `/api/romaster/${editingId}`,
        ];
        let success = false;
        for (const path of candidates) {
          try {
            const res = await fetch(baseUrl + path, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });
            if (res.ok) {
              success = true;
              break;
            }
          } catch (e) {}
        }

        if (success) {
          showToast("Updated successfully ‚úÖ");
          closeEditModal();
          await loadData();
        } else {
          alert(
            "Update failed. Backend may not expose a matching update endpoint."
          );
        }
      }

      // Delete flow
      let deleteTarget = null;
      function confirmDelete(id) {
        if (!confirm("Are you sure you want to delete this RO Master record?"))
          return;
        deleteTarget = id;
        performDelete();
      }

      async function performDelete() {
        if (!deleteTarget) return;
        const candidates = [
          `/romaster/delete/${deleteTarget}`,
          `/romaster/${deleteTarget}`,
          `/api/romaster/delete/${deleteTarget}`,
          `/api/romaster/${deleteTarget}`,
        ];
        let deleted = false;
        for (const path of candidates) {
          try {
            const res = await fetch(baseUrl + path, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });
            if (res.ok) {
              deleted = true;
              break;
            }
          } catch (e) {}
        }
        if (deleted) {
          showToast("Deleted ‚úÖ");
          await loadData();
        } else {
          alert(
            "Delete failed. Backend may not expose a matching delete endpoint."
          );
        }
        deleteTarget = null;
      }

      // Export CSV (all currently filtered results)
      function exportROMasterCSV() {
        // simple CSV
        if (!filteredData || filteredData.length === 0)
          return alert("No data to export");
        const keys = [
          "roCode",
          "roName",
          "zone",
          "region",
          "phase",
          "engineer",
          "amcQtr",
          "siteStatus",
          "siteActivestatus",
          "lastAMCqtr",
        ];
        const header = keys.join(",");
        const rows = filteredData.map((r) =>
          keys
            .map((k) => `"${String(r[k] || "").replaceAll('"', '""')}"`)
            .join(",")
        );
        const csv = [header, ...rows].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `romaster_export_${new Date()
          .toISOString()
          .slice(0, 10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // refresh button
      document.getElementById("refreshBtn").addEventListener("click", loadData);

      // initial load
      loadData();
    </script>
  </body>
</html>
