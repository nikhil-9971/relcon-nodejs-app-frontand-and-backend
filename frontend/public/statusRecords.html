<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Status Records</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 12px;
      }
      th,
      td {
        white-space: nowrap;
      }
      thead th {
        position: sticky;
        top: 0;
        background-color: #f3f4f6;
        z-index: 1;
      }
    </style>
  </head>
  <body class="p-6 bg-gray-100 text-[9px]">
    <div class="max-w-7xl mx-auto bg-white p-6 shadow rounded">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold">üìù Status Records</h1>
        <div class="relative">
          <button
            onclick="toggleExportMenu()"
            class="bg-green-600 text-white px-4 py-2 rounded"
          >
            üì§ Export to CSV
          </button>
          <div
            id="exportMenu"
            class="absolute right-0 mt-2 hidden bg-white border rounded shadow z-50 text-[9px]"
          >
            <button
              onclick="exportToCSV()"
              class="block px-4 py-2 hover:bg-purple-400 w-full text-left"
            >
              üîÑ Export All
            </button>
            <button
              onclick="exportSelectedFields()"
              class="block px-4 py-2 hover:bg-orange-400 w-full text-left"
            >
              üßæ Export Jay
            </button>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-4 mb-4">
        <div>
          <label
            for="fromDate"
            class="block text-[12px] font-medium text-gray-700"
            >üìÖ From:</label
          >
          <input
            type="date"
            id="fromDate"
            class="border border-gray-300 rounded px-2 py-1 text-[12px]"
            onchange="applyDateRangeFilter()"
          />
        </div>
        <div>
          <label
            for="toDate"
            class="block text-[12px] font-medium text-gray-700"
            >üìÖ To:</label
          >
          <input
            type="date"
            id="toDate"
            class="border border-gray-300 rounded px-2 py-1 text-[12px]"
            onchange="applyDateRangeFilter()"
          />
        </div>
        <div class="self-end">
          <button
            onclick="clearDateRangeFilter()"
            class="bg-yellow-500 text-white px-4 py-2 rounded"
          >
            ‚ôªÔ∏è Clear Filter
          </button>
        </div>
      </div>

      <div class="mb-4">
        <input
          type="text"
          id="searchInput"
          oninput="applySearch()"
          placeholder="üîé Search anything..."
          class="w-full border px-3 py-2 rounded"
        />
      </div>

      <div
        class="overflow-x-auto max-h-[75vh] overflow-y-auto border border-gray-300 rounded"
      >
        <table id="statusTable" class="min-w-max table-auto w-full text-[10px]">
          <thead class="bg-gray-200 sticky top-0 z-10">
            <tr id="tableHeader"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Toast -->
    <div
      id="toast"
      class="fixed top-5 right-5 hidden bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50 text-sm"
    ></div>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      const token = localStorage.getItem("token");
      let allStatusData = [],
        filteredData = [];

      async function fetchStatusRecords() {
        const res = await fetch(`${baseUrl}/getMergedStatusRecords`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        allStatusData = data;

        const user = JSON.parse(localStorage.getItem("user")) || {};
        const { username, role } = user;

        filteredData =
          role === "admin" && username === "nikhil.trivedi"
            ? data.filter((r) => r.isVerified)
            : data;

        renderTable(filteredData);
      }

      function renderTable(data) {
        const user = JSON.parse(localStorage.getItem("user")) || {};
        const { username, role } = user;

        const columns = [
          { key: "engineer", label: "Engineer Name" },
          { key: "region", label: "Region" },
          { key: "phase", label: "Phase" },
          { key: "roCode", label: "RO Code" },
          { key: "roName", label: "RO Name" },
          { key: "date", label: "Date" },
          { key: "amcQtr", label: "AMC Qtr" },
          { key: "purpose", label: "Purpose of Visit" },
          { key: "probeMake", label: "Probe Make" },
          { key: "probeSize", label: "Product & Probe Size" },
          { key: "lowProductLock", label: "Low Product Lock" },
          { key: "highWaterSet", label: "Highwater Lock Set" },
          { key: "duSerialNumber", label: "DU Serial Number Updated" },
          { key: "dgStatus", label: "DG Status" },
          { key: "connectivityType", label: "Connectivity Type" },
          { key: "sim1Provider", label: "SIM1 Provider" },
          { key: "sim1Number", label: "SIM1 Number" },
          { key: "sim2Provider", label: "SIM2 Provider" },
          { key: "sim2Number", label: "SIM2 Number" },
          { key: "iemiNumber", label: "IEMI Number" },
          { key: "bosVersion", label: "BOS Version" },
          { key: "fccVersion", label: "FCC Version" },
          { key: "wirelessSlave", label: "Wireless Slave Version" },
          { key: "sftpConfig", label: "SFTP Config" },
          { key: "adminPassword", label: "Admin Password Updated" },
          { key: "workCompletion", label: "Work Completion" },
          { key: "earthingStatus", label: "Earthing Status" },
          { key: "duOffline", label: "DU Offline" },
          { key: "duRemark", label: "DU Remark" },
          { key: "locationField", label: "Location Field" },
          { key: "isVerified", label: "Verified" },
          { key: "actions", label: "Actions" },
        ];

        document.getElementById("tableHeader").innerHTML = columns
          .map(
            (col) =>
              `<th class="border px-3 py-2 bg-gray-100 text-center font-semibold text-gray-700">${col.label}</th>`
          )
          .join("");

        document.getElementById("tableBody").innerHTML = data
          .map((record) => {
            const encoded = btoa(
              unescape(encodeURIComponent(JSON.stringify(record)))
            );
            const row = columns
              .map((col) => {
                if (col.key === "actions") {
                  let actionsHTML = `
                <button class="bg-blue-500 text-white px-2 py-1 rounded mr-1" onclick='handleEditClick("${encoded}")'>‚úèÔ∏è</button>
                <button class="bg-red-600 text-white px-2 py-1 rounded mr-1" onclick='deleteStatus("${record._id}")'>üóëÔ∏è</button>
              `;
                  if (
                    role === "admin" &&
                    username === "anurag.mishra" &&
                    !record.isVerified
                  ) {
                    actionsHTML += `<button class="bg-green-600 text-white px-2 py-1 rounded" onclick='verifyRecord("${record._id}")'>‚úÖ Verify</button>`;
                  }
                  return `<td class="border text-center px-2 py-1">${actionsHTML}</td>`;
                }

                if (col.key === "isVerified") {
                  return `<td class="border text-center px-2 py-1">
                ${
                  record.isVerified
                    ? '<span class="text-green-600 font-semibold">‚úÖ Yes</span>'
                    : '<span class="text-gray-400">‚ùå No</span>'
                }
              </td>`;
                }

                return `<td class="border text-center px-2 py-1">${
                  record[col.key] || ""
                }</td>`;
              })
              .join("");
            return `<tr>${row}</tr>`;
          })
          .join("");
      }

      function handleEditClick(encoded) {
        const json = decodeURIComponent(escape(atob(encoded)));
        const record = JSON.parse(json);
        alert("Edit modal coming soon..."); // Placeholder
      }

      function deleteStatus(id) {
        if (!confirm("Confirm delete?")) return;
        fetch(`${baseUrl}/deleteStatus/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        }).then((res) => {
          if (res.ok) {
            showToast("Deleted ‚úÖ");
            fetchStatusRecords();
          } else {
            alert("Delete failed");
          }
        });
      }

      async function verifyRecord(id) {
        if (!confirm("Mark as verified?")) return;
        const res = await fetch(`${baseUrl}/verifyStatus/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ isVerified: true }),
        });
        if (res.ok) {
          showToast("Verified ‚úÖ");
          fetchStatusRecords();
        } else {
          alert("Verification failed");
        }
      }

      function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 3000);
      }

      function applySearch() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const result = filteredData.filter((row) =>
          Object.values(row).some((val) =>
            String(val).toLowerCase().includes(query)
          )
        );
        renderTable(result);
      }

      function applyDateRangeFilter() {
        const from = new Date(document.getElementById("fromDate").value);
        const to = new Date(document.getElementById("toDate").value);
        const result = allStatusData.filter((row) => {
          const date = new Date(row.date);
          return (
            (!isNaN(from) ? date >= from : true) &&
            (!isNaN(to) ? date <= to : true)
          );
        });
        filteredData = result;
        renderTable(result);
      }

      function clearDateRangeFilter() {
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";
        filteredData = allStatusData;
        renderTable(filteredData);
      }

      function toggleExportMenu() {
        const menu = document.getElementById("exportMenu");
        menu.classList.toggle("hidden");
        setTimeout(
          () => document.addEventListener("click", closeExportMenu),
          10
        );
      }

      function closeExportMenu(e) {
        const menu = document.getElementById("exportMenu");
        if (
          !e.target.closest("#exportMenu") &&
          !e.target.closest("button[onclick^='toggleExportMenu']")
        ) {
          menu.classList.add("hidden");
          document.removeEventListener("click", closeExportMenu);
        }
      }

      fetchStatusRecords();
    </script>
  </body>
</html>
