<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Status Records</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      th,
      td {
        white-space: nowrap;
      }
      thead th {
        position: sticky;
        top: 0;
        background-color: #f3f4f6;
        z-index: 1;
      }
    </style>
  </head>
  <body class="p-6 bg-gray-100 font-sans text-[9px]">
    <div class="max-w-7xl mx-auto bg-white p-6 shadow rounded">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold">üìù Status Records</h1>
        <button
          onclick="exportToCSV()"
          class="bg-green-600 text-white px-4 py-2 rounded"
        >
          üì§ Export to CSV
        </button>
      </div>

      <div class="flex flex-wrap items-center gap-4 mb-4">
        <div>
          <label for="fromDate" class="block text-sm font-medium text-gray-700"
            >üìÖ From:</label
          >
          <input
            type="date"
            id="fromDate"
            class="border border-gray-300 rounded px-2 py-1 text-sm"
            onchange="applyDateRangeFilter()"
          />
        </div>
        <div>
          <label for="toDate" class="block text-sm font-medium text-gray-700"
            >üìÖ To:</label
          >
          <input
            type="date"
            id="toDate"
            class="border border-gray-300 rounded px-2 py-1 text-sm"
            onchange="applyDateRangeFilter()"
          />
        </div>
        <div class="self-end">
          <button
            onclick="clearDateRangeFilter()"
            class="bg-yellow-500 text-white px-4 py-2 rounded"
          >
            ‚ôªÔ∏è Clear Filter
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table
          id="statusTable"
          class="min-w-max table-auto border border-gray-300 text-[9px] whitespace-nowrap"
        >
          <thead class="bg-gray-200">
            <tr id="tableHeader"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div
      id="editModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white p-6 rounded shadow max-h-[80vh] overflow-y-auto w-[90%] max-w-4xl"
      >
        <h2 class="text-lg font-bold mb-4">Edit Status</h2>
        <form id="editForm" class="grid grid-cols-2 gap-4 text-xs"></form>
        <div class="mt-4 flex justify-end">
          <button
            onclick="closeModal()"
            class="bg-gray-500 text-white px-4 py-1 rounded mr-2"
          >
            Cancel
          </button>
          <button
            onclick="saveEdit()"
            class="bg-green-600 text-white px-4 py-1 rounded"
          >
            Save
          </button>
        </div>
      </div>
    </div>

    <script>
      const baseUrl = "https://relcon-backend.onrender.com";
      let allStatusData = [];
      let filteredData = [];

      async function fetchStatusRecords() {
        const res = await fetch(`${baseUrl}/getMergedStatusRecords`, {
          credentials: "include",
        });
        const data = await res.json();
        allStatusData = data;
        applyDateRangeFilter();
      }

      function applyDateRangeFilter() {
        const from = document.getElementById("fromDate").value;
        const to = document.getElementById("toDate").value;
        const fromDate = from ? new Date(from) : null;
        const toDate = to ? new Date(to) : null;

        filteredData = allStatusData.filter((row) => {
          const rowDate = new Date(row.date);
          if (fromDate && rowDate < fromDate) return false;
          if (toDate && rowDate > toDate) return false;
          return true;
        });

        renderTable(filteredData);
      }

      function clearDateRangeFilter() {
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";
        filteredData = allStatusData;
        renderTable(filteredData);
      }

      function exportToCSV() {
        const ws = XLSX.utils.json_to_sheet(filteredData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "StatusRecords");
        XLSX.writeFile(
          wb,
          `Filtered_Status_Records_${new Date().toISOString().slice(0, 10)}.csv`
        );
      }

      function renderTable(data) {
        const columns = [
          { key: "engineer", label: "Engineer Name" },
          { key: "region", label: "Region" },
          { key: "phase", label: "Phase" },
          { key: "roCode", label: "RO Code" },
          { key: "roName", label: "RO Name" },
          { key: "date", label: "Date" },
          { key: "amcQtr", label: "AMC Qtr" },
          { key: "purpose", label: "Purpose of Visit" },
          { key: "probeMake", label: "Probe Make" },
          { key: "lowProductLock", label: "Low Product Lock" },
          { key: "highWaterSet", label: "Highwater Lock Set" },
          { key: "duSerialNumber", label: "DU Serial Number Updated" },
          { key: "dgStatus", label: "DG Status" },
          { key: "connectivityType", label: "Connectivity Type" },
          { key: "sim1Provider", label: "SIM1 Provider" },
          { key: "sim1Number", label: "SIM1 Number" },
          { key: "sim2Provider", label: "SIM2 Provider" },
          { key: "sim2Number", label: "SIM2 Number" },
          { key: "iemiNumber", label: "IEMI Number" },
          { key: "bosVersion", label: "BOS Version" },
          { key: "fccVersion", label: "FCC Version" },
          { key: "wirelessSlave", label: "Wireless Slave Version" },
          { key: "sftpConfig", label: "SFTP Config" },
          { key: "adminPassword", label: "Admin Password Updated" },
          { key: "workCompletion", label: "Work Completion" },
          { key: "earthingStatus", label: "Earthing Status" },
          { key: "duOffline", label: "DU Offline" },
          { key: "duRemark", label: "DU Remark" },
          { key: "locationField", label: "Location Field" },
          { key: "actions", label: "Actions" },
        ];

        const headerRow = document.getElementById("tableHeader");
        headerRow.innerHTML = columns
          .map(
            (col) =>
              `<th class="border px-3 py-2 bg-gray-100 text-center font-semibold text-gray-700">${col.label}</th>`
          )
          .join("");

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = data
          .map((record) => {
            const row = columns
              .map((col) => {
                if (col.key === "actions") {
                  return `<td class="border text-center px-2 py-1">
                <button class="bg-blue-500 text-white px-2 py-1 rounded mr-1" onclick='openEditModal(${JSON.stringify(
                  record
                )})'>‚úèÔ∏è</button>
              <button onclick='deleteStatus("${
                record.planId || record._id
              }")'>üóëÔ∏è</button>
              </td>`;
                }
                return `<td class="border text-center px-2 py-1">${
                  record[col.key] || ""
                }</td>`;
              })
              .join("");
            return `<tr>${row}</tr>`;
          })
          .join("");
      }

      let editingStatus = null;

      function openEditModal(record) {
        editingStatus = record;
        const form = document.getElementById("editForm");
        form.innerHTML = "";

        Object.keys(record).forEach((key) => {
          if (key === "actions") return;
          if (key === "planId" || key === "_id") {
            form.innerHTML += `<input type="hidden" name="${key}" value="${record[key]}" />`;
            return;
          }

          form.innerHTML += `
            <div>
              <label class="block text-gray-700 font-medium mb-1">${key}</label>
              <input type="text" name="${key}" value="${
            record[key] || ""
          }" class="w-full border px-2 py-1 rounded" />
            </div>
          `;
        });

        document.getElementById("editModal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("editModal").classList.add("hidden");
        editingStatus = null;
      }

      async function saveEdit() {
        const form = document.getElementById("editForm");
        const formData = new FormData(form);
        const updated = {};
        formData.forEach((val, key) => (updated[key] = val));

        const updateId = updated.planId || updated._id;

        const res = await fetch(`${baseUrl}/updateStatus/${updateId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updated),
        });

        if (res.ok) {
          await fetchStatusRecords();
          applyDateRangeFilter();
          closeModal();
        } else {
          const text = await res.text();
          alert("Error: " + text);
        }
      }

      async function deleteStatus(id) {
        if (!id || id === "undefined") {
          alert("Invalid ID ‚Äî cannot delete");
          return;
        }

        const res = await fetch(`${baseUrl}/deleteStatus/${id}`, {
          method: "DELETE",
        });

        if (res.ok) {
          await fetchStatusRecords();
          applyDateRangeFilter();
        } else {
          const text = await res.text();
          alert("Delete failed: " + text);
        }
      }

      fetchStatusRecords();
    </script>
  </body>
</html>
