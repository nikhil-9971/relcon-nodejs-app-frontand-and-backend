<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Task Report | RELCON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f9fafb;
        font-size: 12px;
      }
    </style>
  </head>
  <body class="p-6">
    <div class="max-w-7xl mx-auto bg-white p-5 shadow rounded">
      <div class="flex justify-between mb-4">
        <h2 class="text-xl font-semibold">‚úÖ Submitted Tasks Report</h2>
        <button
          onclick="fetchTasks()"
          class="bg-blue-600 text-white px-4 py-1 rounded"
        >
          üîÑ Refresh
        </button>
      </div>

      <div>
        <button
          onclick="exportToCSV()"
          class="bg-green-600 text-white px-2 py-1 rounded ml-2 text-[10px]"
        >
          ‚¨áÔ∏è Export CSV
        </button>
      </div>

      <table class="min-w-full table-auto border text-[11px]">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2 py-1">RO Code</th>
            <th class="border px-2 py-1">RO Name</th>
            <th class="border px-2 py-1">Date</th>
            <th class="border px-2 py-1">Engineer</th>
            <th class="border px-2 py-1">Issue</th>
            <th class="border px-2 py-1">Mail Date</th>
            <th class="border px-2 py-1">Completed By</th>
            <th class="border px-2 py-1">Sent Mail Date</th>
            <th class="border px-2 py-1">Previous Status</th>
            <th class="border px-2 py-1">Current Status</th>
            <th class="border px-2 py-1">Next Follow-up Date</th>
          </tr>
        </thead>
        <tbody id="taskTableBody"></tbody>
      </table>
    </div>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      const token = localStorage.getItem("token");

      function addDays(dateStr, days) {
        const d = new Date(dateStr);
        d.setDate(d.getDate() + days);
        return d.toISOString().split("T")[0];
      }

      async function fetchTasks() {
        const res = await fetch(`${baseUrl}/getTasks`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const tasks = await res.json();
        const tbody = document.getElementById("taskTableBody");
        tbody.innerHTML = "";

        const todayStr = new Date().toISOString().split("T")[0];

        const submittedTasks = tasks.filter(
          (task) => task.status === "Resolved"
        );

        submittedTasks.forEach((task) => {
          const followUpDate = task.mailDate
            ? new Date(
                new Date(task.mailDate).getTime() + 7 * 24 * 60 * 60 * 1000
              )
            : null;
          const followUpDateStr = followUpDate
            ? followUpDate.toISOString().split("T")[0]
            : "-";

          // Auto-assign Follow-up if today is follow-up date
          if (
            followUpDateStr === todayStr &&
            (!task.followUpDates || !task.followUpDates.includes(todayStr))
          ) {
            updateTaskStatus(task._id, "Follow-up", true); // Add third param
          }

          let mailReplyDisplay = "-";
          if (task.mailDate) {
            mailReplyDisplay = task.mailDate;
            if (task.followUpDates && Array.isArray(task.followUpDates)) {
              mailReplyDisplay += ", " + task.followUpDates.join(", ");
            }
          }

          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="border px-2 py-1">${task.roCode}</td>
            <td class="border px-2 py-1">${task.roName}</td>
            <td class="border px-2 py-1">${task.date}</td>
            <td class="border px-2 py-1">${task.engineer}</td>
            <td class="border px-2 py-1 text-red-600">${task.issue}</td>
            <td class="border px-2 py-1">${task.mailDate || "-"}</td>
            <td class="border px-2 py-1">${task.completedBy || "-"}</td>
            <td class="border px-2 py-1">${mailReplyDisplay}</td>
            <td class="border px-2 py-1 text-green-600 font-medium">Mailed</td>
            <td class="border px-2 py-1">
              <select onchange="updateTaskStatus('${
                task._id
              }', this.value)" class="border px-2 py-1 rounded">
                <option value="Pending">Pending</option>
                <option value="Resolved" ${
                  task.status === "Resolved" ? "selected" : ""
                }>In Process</option>
                <option value="Done">Resolved</option>
              </select>
            </td>
            <td class="border px-2 py-1">${followUpDateStr}</td>
          `;
          tbody.appendChild(row);
        });
      }

      async function updateTaskStatus(id, status, followUp = false) {
        await fetch(`${baseUrl}/updateTask/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ status, followUp }),
        });
        fetchTasks();
      }

      function exportToCSV() {
        const rows = [
          [
            "RO Code",
            "RO Name",
            "Date",
            "Engineer",
            "Issue",
            "Mail Date",
            "Completed By",
            "Sent Mail Dates",
            "Previous Status",
            "Current Status",
            "Next Follow-up Date",
          ],
        ];
        const table = document.getElementById("taskTableBody");
        const trs = table.querySelectorAll("tr");

        trs.forEach((tr) => {
          const row = [];
          const tds = tr.querySelectorAll("td");

          tds.forEach((td, index) => {
            let text = "";

            // Handle select dropdown (Current Status)
            const select = td.querySelector("select");
            if (select) {
              text = select.options[select.selectedIndex].text;
            }
            // Handle input
            else if (td.querySelector("input")) {
              text = td.querySelector("input").value;
            }
            // Handle textarea
            else if (td.querySelector("textarea")) {
              text = td.querySelector("textarea").value;
            }
            // Handle plain text or HTML
            else {
              text = td.textContent.trim().replace(/\n/g, " ");
            }

            row.push(text);
          });

          rows.push(row);
        });

        const csvContent = rows.map((e) => e.join(",")).join("\n");

        const blob = new Blob(["\ufeff" + csvContent], {
          type: "text/csv;charset=utf-8;",
        });

        const today = new Date().toISOString().split("T")[0];
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `TaskReport-${today}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      window.onload = fetchTasks;
    </script>
  </body>
</html>
