<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Incident Admin Panel</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div class="p-4">
      <h2 class="text-2xl font-bold mb-4">
        <span class="mr-2">üìã</span>Incident Admin Panel
      </h2>

      <div class="flex items-center gap-4 mb-4">
        <input
          type="file"
          id="excelFile"
          accept=".xlsx, .xls"
          class="p-2 border rounded w-full max-w-xs"
        />
        <button
          onclick="exportToExcel()"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded"
        >
          Export
        </button>
      </div>

      <table class="table-auto w-full text-sm">
        <thead class="bg-green-600 text-white">
          <tr>
            <th class="px-2 py-2">RO Code</th>
            <th class="px-2 py-2">Site Name</th>
            <th class="px-2 py-2">Region</th>
            <th class="px-2 py-2">Incident ID</th>
            <th class="px-2 py-2">Incident Date</th>
            <th class="px-2 py-2">Status</th>
          </tr>
        </thead>
        <tbody id="incidentTable" class="bg-white"></tbody>
      </table>
    </div>

    <div
      id="toast"
      class="hidden fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded shadow-lg"
    ></div>

    <script>
      const BASE_URL = "https://relcon-backend-jwt.onrender.com";
      let excelPreviewData = [];

      document
        .getElementById("excelFile")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data);
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);
          excelPreviewData = json.map((item) => ({
            roCode: item["RO Code"] || "",
            siteName: item["Site Name"] || "",
            region: item["Region"] || "",
            incidentId: item["Incident ID"] || "",
            incidentDate: item["Incident Date"] || "",
            status: item["Status"] || "Pending",
          }));
          renderIncidentTable(excelPreviewData);
          syncToBackend(excelPreviewData);
        });

      function renderIncidentTable(data) {
        const tbody = document.getElementById("incidentTable");
        tbody.innerHTML = "";
        data.forEach((item, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="border px-2 py-1">${item.roCode}</td>
            <td class="border px-2 py-1">${item.siteName}</td>
            <td class="border px-2 py-1">${item.region}</td>
            <td class="border px-2 py-1">${item.incidentId}</td>
            <td class="border px-2 py-1">${item.incidentDate}</td>
            <td class="border px-2 py-1">
              <select class="border px-2 py-1 rounded" onchange="updateStatus(${index}, this.value)">
                <option ${
                  item.status === "Pending" ? "selected" : ""
                }>Pending</option>
                <option ${
                  item.status === "Close" ? "selected" : ""
                }>Close</option>
              </select>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      function updateStatus(index, newStatus) {
        excelPreviewData[index].status = newStatus;
        fetch(`${BASE_URL}/updateIncidentStatus`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            incidentId: excelPreviewData[index].incidentId,
            status: newStatus,
          }),
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.success) showToast("‚úÖ Status updated");
          });
      }

      function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.innerText = msg;
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 3000);
      }

      async function syncToBackend(data) {
        try {
          const response = await fetch(`${BASE_URL}/bulkImportIncident`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ incidents: data }),
          });
          const res = await response.json();
          if (res.success) showToast("‚úÖ Data imported successfully");
          else showToast("‚ùå Import failed");
        } catch (err) {
          console.error(err);
          showToast("‚ùå Server error");
        }
      }

      function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(excelPreviewData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Incidents");
        XLSX.writeFile(wb, "incident-report-export.xlsx");
      }
    </script>
  </body>
</html>
