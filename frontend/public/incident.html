<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Incident Admin</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mini.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-sm">
    <div class="p-4">
      <h2 class="text-xl font-bold mb-4">ðŸ“‹ Incident Admin Panel</h2>

      <div class="flex gap-4 items-center mb-4">
        <input
          type="file"
          id="excelInput"
          accept=".xlsx,.xls"
          class="border rounded px-3 py-2"
        />
        <button
          onclick="exportToExcel()"
          class="bg-green-600 text-white px-4 py-2 rounded"
        >
          Export
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded shadow">
          <thead class="bg-green-600 text-white">
            <tr>
              <th class="px-4 py-2">RO Code</th>
              <th class="px-4 py-2">Site Name</th>
              <th class="px-4 py-2">Region</th>
              <th class="px-4 py-2">Incident ID</th>
              <th class="px-4 py-2">Incident Date</th>
              <th class="px-4 py-2">Status</th>
            </tr>
          </thead>
          <tbody id="incidentBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const baseUrl = "https://relcon-backend-jwt.onrender.com";
      const token = localStorage.getItem("token");
      const role = localStorage.getItem("role");
      let currentIncidentData = [];

      if (role !== "admin") {
        alert("Access denied. Only admin can view this page.");
        window.location.href = "dashboard.html";
      }

      document.getElementById("excelInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = (evt) => {
          const wb = XLSX.read(evt.target.result, { type: "binary" });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet);
          currentIncidentData = data;
          renderIncidentTable(data);
          syncToBackend(data);
        };

        reader.readAsBinaryString(file);
      });

      function renderIncidentTable(data) {
        const tbody = document.getElementById("incidentBody");
        tbody.innerHTML = "";

        data.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.className = i % 2 === 0 ? "bg-gray-50" : "bg-white";

          tr.innerHTML = `
            <td class="border px-4 py-2">${row.roCode || ""}</td>
            <td class="border px-4 py-2">${row.siteName || ""}</td>
            <td class="border px-4 py-2">${row.region || ""}</td>
            <td class="border px-4 py-2">${row.incidentId || ""}</td>
            <td class="border px-4 py-2">${row.incidentdate || ""}</td>
            <td class="border px-4 py-2">
              <select onchange="updateStatus(${i}, this.value)" class="border p-1 rounded">
                <option ${
                  row.status === "Pending" ? "selected" : ""
                }>Pending</option>
                <option ${
                  row.status === "Close" ? "selected" : ""
                }>Close</option>
              </select>
            </td>
          `;

          tbody.appendChild(tr);
        });
      }

      function updateStatus(index, newStatus) {
        currentIncidentData[index].status = newStatus;

        fetch(`${baseUrl}/incident/update-status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            incidentId: currentIncidentData[index].incidentId,
            status: newStatus,
          }),
        });
      }

      function syncToBackend(data) {
        fetch(`${baseUrl}/incident/bulk-import`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ incidents: data }),
        });
      }

      function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(currentIncidentData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Incidents");
        XLSX.writeFile(wb, "incident_export.xlsx");
      }
    </script>
  </body>
</html>
