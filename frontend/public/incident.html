<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Incident Admin Panel</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f1f5f9;
        font-size: 12px;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="p-4">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-2">
          <h1 class="text-xl font-bold">üìã Incident Records</h1>
          <img src="./assets/HPCL.png" alt="HPCL" class="h-6" />
          <img src="./assets/JioBP.png" alt="JioBP" class="h-6" />
          <img src="./assets/BPCL.png" alt="BPCL" class="h-6" />
        </div>
        <!-- Add Incident Button -->
        <button
          onclick="openIncidentModal()"
          class="bg-red-600 hover:bg-green-700 text-white px-4 py-2 rounded mb-4"
        >
          ‚ûï Add Incident
        </button>
      </div>

      <!-- Search Box -->
      <div class="flex items-center gap-2 mb-4">
        <input
          type="text"
          id="searchInput"
          placeholder="üîç Search Incident..."
          class="border p-2 rounded w-full max-w-xs"
          onkeyup="searchTable()"
        />
      </div>

      <!-- Modal -->
      <div
        id="incidentModal"
        class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50"
      >
        <div class="bg-white p-6 rounded shadow w-[90%] max-w-lg">
          <h2 class="text-lg font-bold mb-4">Add New Incident</h2>

          <div class="grid grid-cols-2 gap-4">
            <input
              id="newRoCode"
              placeholder="RO Code"
              class="border p-2 rounded"
            />
            <input
              id="newSiteName"
              placeholder="Site Name"
              class="border p-2 rounded"
            />
            <input
              id="newRegion"
              placeholder="Region"
              class="border p-2 rounded"
            />
            <input
              id="newIncidentId"
              placeholder="Incident ID"
              class="border p-2 rounded"
            />
            <input
              id="newIncidentDate"
              type="date"
              class="border p-2 rounded"
            />
            <input
              id="newComplaintRemark"
              placeholder="Complaint Remark"
              class="border p-2 rounded"
            />
          </div>

          <div class="mt-4 flex justify-end gap-2">
            <button
              onclick="closeIncidentModal()"
              class="bg-gray-500 text-white px-4 py-1 rounded"
            >
              Cancel
            </button>
            <button
              onclick="saveNewIncident()"
              class="bg-green-600 text-white px-4 py-1 rounded"
            >
              Save
            </button>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-4 mb-4">
        <input
          type="file"
          id="excelFile"
          accept=".xlsx, .xls"
          class="p-2 border rounded w-full max-w-xs"
        />
        <button
          onclick="exportToExcel()"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded"
        >
          Export
        </button>
      </div>

      <div class="overflow-x-auto overflow-y-auto max-h-[600px] border rounded">
        <table class="table-auto min-w-max text-[11px]">
          <thead class="bg-green-600 text-white sticky top-0 z-10">
            <tr>
              <th class="px-2 py-1">RO Code</th>
              <th class="px-2 py-1">Site Name</th>
              <th class="px-2 py-1">Region</th>
              <th class="px-2 py-1">Incident ID</th>
              <th class="px-2 py-1">Incident Date</th>
              <th class="px-2 py-1">Complain Remark</th>
              <th class="px-2 py-1">Assign to Engineer</th>
              <th class="px-2 py-1">Incident Close Remark</th>
              <th class="px-2 py-1">Incident Close date</th>
              <th class="px-2 py-1">Status</th>
              <th class="px-2 py-1">Action</th>
            </tr>
          </thead>
          <tbody id="incidentTable" class="bg-white"></tbody>
        </table>
      </div>
    </div>

    <div
      id="toast"
      class="hidden fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded shadow-lg"
    ></div>

    <script>
      const BASE_URL = "https://relcon-backend-jwt.onrender.com";
      let excelPreviewData = [];

      window.onload = fetchIncidents;

      document
        .getElementById("excelFile")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data);
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);
          excelPreviewData = json.map((item) => ({
            roCode: item["RO Code"] || "",
            siteName: item["Site Name"] || "",
            region: item["Region"] || "",
            incidentId: item["Incident ID"] || "",
            incidentDate: formatExcelDate(item["Incident Date"]),
            complaintRemark: item["Complain Remark"] || "",
            assignEngineer: item["Assign to Engineer"] || "",
            closeRemark: item["Incident Close Remark"] || "",
            incidentcloseDate: formatExcelDate(item["Incident Close Date"]),
            status: item["Status"] || "Pending",
          }));
          renderIncidentTable(excelPreviewData);
          syncToBackend(excelPreviewData);
        });

      function formatExcelDate(excelDate) {
        if (typeof excelDate === "number") {
          const date = new Date((excelDate - 25569) * 86400 * 1000);
          return date.toISOString().split("T")[0];
        }
        return excelDate || "";
      }

      function searchTable() {
        const input = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const filteredData = excelPreviewData.filter((item) =>
          Object.values(item).some((val) =>
            String(val).toLowerCase().includes(input)
          )
        );
        renderIncidentTable(filteredData);
      }

      function renderIncidentTable(data) {
        const engineerNames = [
          "Abhishek Pathak",
          "Amit Kumar",
          "Banti Kumar",
          "Gautam Kumar",
          "Gautam Kumar (Purnia)",
          "Kaushal Pandey",
          "Prabhat Mishra",
          "Raushan Kumar",
          "Shaurav Kumar",
          "Vinit Kumar",
          "Rajan Pandey",
          "Shubhendu Giri",
          "Prerak Singh",
          "Kirtivardhan",
          "Kuldeep Kumar",
          "RAVI PRATAP",
        ];

        const user = JSON.parse(localStorage.getItem("user")) || {};
        const isAdminUser =
          user.username === "nikhil.trivedi" && user.role === "admin";

        const tbody = document.getElementById("incidentTable");
        tbody.innerHTML = "";

        data.forEach((item, index) => {
          const isClosed = item.status === "Close";
          const row = document.createElement("tr");

          row.innerHTML = `
      <td class="border px-2 py-1">${item.roCode}</td>
      <td class="border px-2 py-1">${item.siteName}</td>
      <td class="border px-2 py-1">${item.region}</td>
      <td class="border px-2 py-1">${item.incidentId}</td>
      <td class="border px-2 py-1">${item.incidentDate}</td>
      <td class="border px-2 py-1">${item.complaintRemark}</td>

      <td class="border px-2 py-1">
        <select id="engineer-${index}" class="border rounded px-2 py-1" ${
            isClosed ? "disabled" : ""
          } onchange="checkFields(${index})">
          <option value="">--Select--</option>
          ${engineerNames
            .map(
              (name) =>
                `<option value="${name}" ${
                  item.assignEngineer === name ? "selected" : ""
                }>${name}</option>`
            )
            .join("")}
        </select>
      </td>

      <td class="border px-2 py-1">
        <input type="text" id="remark-${index}" value="${
            item.closeRemark || ""
          }"
          class="border rounded px-2 py-1 w-full" ${
            isClosed ? "readonly" : ""
          }   onchange="checkFields(${index})">
      </td>

      <td class="border px-2 py-1">
        <input type="date" id="date-${index}" value="${
            item.incidentcloseDate || ""
          }"
          class="border rounded px-2 py-1" ${
            isClosed ? "readonly" : ""
          }   onchange="checkFields(${index})">
      </td>

      <td class="border px-2 py-1">
        <select id="status-${index}" class="border px-2 py-1 rounded" ${
            isClosed ? "disabled" : ""
          }   onchange="checkFields(${index})">
          <option ${
            item.status === "Pending" ? "selected" : ""
          }>Pending</option>
          <option ${item.status === "Close" ? "selected" : ""}>Close</option>
          <option ${
            item.status === "HPCL Action Required" ? "selected" : ""
          }>HPCL Action Required</option>
        </select>
      </td>

     <td class="border px-2 py-1">
  ${
    isAdminUser
      ? `
    <button id="editBtn-${index}" onclick="toggleEditMode(${index}, true)" 
      class="bg-blue-500 text-white px-2 py-1 rounded mr-1">‚úèÔ∏è</button>
    <button id="saveEdit-${index}" onclick="saveEdit(${index})" 
      class="bg-green-500 text-white px-2 py-1 rounded mr-1 hidden">Save Changes</button>
    <button id="saveBtn-${index}" onclick="saveRow(${index})" 
      class="bg-green-500 text-white px-2 py-1 rounded mr-1 hidden">Save</button>
    <button onclick="deleteIncident(${index})" 
      class="bg-red-500 text-white px-2 py-1 rounded">üóëÔ∏è</button>
  `
      : ""
  }
</td>

    `;
          tbody.appendChild(row);
        });
      }

      // Update Assign Engineer
      function updateAssignEngineer(index, value) {
        excelPreviewData[index].assignEngineer = value;
        saveFieldChange(index, { assignEngineer: value });
      }

      // Update Close Remark
      function updateCloseRemark(index, value) {
        excelPreviewData[index].closeRemark = value;
        saveFieldChange(index, { closeRemark: value });
      }

      // Update Close Date
      function updateCloseDate(index, value) {
        excelPreviewData[index].incidentcloseDate = value;
        saveFieldChange(index, { incidentcloseDate: value });
      }

      function checkFields(index) {
        const engineer = document
          .getElementById(`engineer-${index}`)
          .value.trim();
        const remark = document.getElementById(`remark-${index}`).value.trim();
        const date = document.getElementById(`date-${index}`).value.trim();
        const status = document.getElementById(`status-${index}`).value.trim();

        const saveBtn = document.getElementById(`saveBtn-${index}`);

        if (engineer && remark && date && status) {
          saveBtn.classList.remove("hidden");
        } else {
          saveBtn.classList.add("hidden");
        }
      }

      // Common Save Function
      function saveFieldChange(index, updateObj) {
        fetch(`${BASE_URL}/updateIncidentStatus`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            incidentId: excelPreviewData[index].incidentId,
            ...updateObj,
          }),
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.success) showToast("‚úÖ Updated successfully");
          });
      }

      function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.innerText = msg;
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 3000);
      }

      async function syncToBackend(data) {
        try {
          const response = await fetch(`${BASE_URL}/bulkImportIncident`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ incidents: data }),
          });
          const res = await response.json();
          if (res.success) showToast("‚úÖ Data imported successfully");
          else showToast("‚ùå Import failed");
        } catch (err) {
          console.error(err);
          showToast("‚ùå Server error");
        }
      }

      function fetchIncidents() {
        try {
          fetch(`${BASE_URL}/getAllIncidents`)
            .then((res) => res.json())
            .then((result) => {
              if (result.success && result.incidents) {
                excelPreviewData = result.incidents;
                const searchVal = document
                  .getElementById("searchInput")
                  .value.toLowerCase();
                if (searchVal) {
                  searchTable(); // ‡§Ö‡§ó‡§∞ search box ‡§Æ‡•á‡§Ç value ‡§π‡•à ‡§§‡•ã filter ‡§≤‡§ó‡§æ‡§ì
                } else {
                  renderIncidentTable(excelPreviewData);
                }
              }
            });
        } catch (err) {
          console.error("Failed to fetch incident data:", err);
        }
      }

      function handleStatusChange(index) {
        const status = document.getElementById(`status-${index}`).value;
        toggleSaveButton(index, status);
      }

      function toggleSaveButton(index, status) {
        const engineer = document
          .getElementById(`engineer-${index}`)
          .value.trim();
        const remark = document.getElementById(`remark-${index}`).value.trim();
        const date = document.getElementById(`date-${index}`).value.trim();

        const saveBtn = document.getElementById(`saveBtn-${index}`);

        if (status === "Close" && engineer && remark && date) {
          saveBtn.classList.remove("hidden");
        } else {
          saveBtn.classList.add("hidden");
        }
      }

      function saveRow(index) {
        const payload = {
          incidentId: excelPreviewData[index].incidentId,
          assignEngineer: document.getElementById(`engineer-${index}`).value,
          closeRemark: document.getElementById(`remark-${index}`).value,
          incidentcloseDate: document.getElementById(`date-${index}`).value,
          status: document.getElementById(`status-${index}`).value,
        };

        fetch(`${BASE_URL}/updateIncidentStatus`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.success) {
              showToast("‚úÖ Incident closed successfully");
              excelPreviewData[index] = {
                ...excelPreviewData[index],
                ...payload,
              };

              // Disable fields after save
              document.getElementById(`engineer-${index}`).disabled = true;
              document.getElementById(`remark-${index}`).readOnly = true;
              document.getElementById(`date-${index}`).readOnly = true;
              document.getElementById(`status-${index}`).disabled = true;
              document
                .getElementById(`saveBtn-${index}`)
                .classList.add("hidden");
            } else {
              showToast("‚ùå Failed to update");
            }
          });
      }

      //edit toggle

      function toggleEditMode(index, enable) {
        const engineer = document.getElementById(`engineer-${index}`);
        const remark = document.getElementById(`remark-${index}`);
        const date = document.getElementById(`date-${index}`);
        const status = document.getElementById(`status-${index}`);

        engineer.disabled = !enable;
        remark.readOnly = !enable;
        date.readOnly = !enable;
        status.disabled = !enable;

        document
          .getElementById(`editBtn-${index}`)
          .classList.toggle("hidden", enable);
        document
          .getElementById(`saveEdit-${index}`)
          .classList.toggle("hidden", !enable);
      }

      function saveEdit(index) {
        const payload = {
          incidentId: excelPreviewData[index].incidentId,
          assignEngineer: document.getElementById(`engineer-${index}`).value,
          closeRemark: document.getElementById(`remark-${index}`).value,
          incidentcloseDate: document.getElementById(`date-${index}`).value,
          status: document.getElementById(`status-${index}`).value,
        };

        fetch(`${BASE_URL}/updateIncidentStatus`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.success) {
              showToast("‚úÖ Incident updated successfully");

              // Update local data
              excelPreviewData[index] = {
                ...excelPreviewData[index],
                ...payload,
              };

              // Always disable fields after saving, even if status is still Pending
              toggleEditMode(index, false);
            } else {
              showToast("‚ùå Failed to update");
            }
          })
          .catch(() => showToast("‚ùå Server error"));
      }

      function deleteIncident(index) {
        if (!confirm("Are you sure you want to delete this incident?")) return;

        fetch(
          `${BASE_URL}/deleteIncident/${excelPreviewData[index].incidentId}`,
          {
            method: "DELETE",
          }
        )
          .then((res) => res.json())
          .then((res) => {
            if (res.success) {
              showToast("‚úÖ Incident deleted");
              excelPreviewData.splice(index, 1);
              renderIncidentTable(excelPreviewData);
            } else {
              showToast("‚ùå Delete failed");
            }
          });
      }

      function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(excelPreviewData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Incidents");
        XLSX.writeFile(wb, "incident-report-export.xlsx");
      }

      //MANUAL INCIDENT ADD

      function openIncidentModal() {
        document.getElementById("incidentModal").classList.remove("hidden");
        document.getElementById("incidentModal").classList.add("flex");
      }

      function closeIncidentModal() {
        document.getElementById("incidentModal").classList.add("hidden");
      }

      function saveNewIncident() {
        const payload = {
          roCode: document.getElementById("newRoCode").value.trim(),
          siteName: document.getElementById("newSiteName").value.trim(),
          region: document.getElementById("newRegion").value.trim(),
          incidentId: document.getElementById("newIncidentId").value.trim(),
          incidentDate: document.getElementById("newIncidentDate").value.trim(),
          complaintRemark: document
            .getElementById("newComplaintRemark")
            .value.trim(),
          assignEngineer: "",
          closeRemark: "",
          incidentcloseDate: "",
          status: "Pending",
        };

        // Basic validation
        if (
          !payload.roCode ||
          !payload.siteName ||
          !payload.incidentId ||
          !payload.incidentDate
        ) {
          showToast("‚ö† Please fill all required fields");
          return;
        }

        fetch(`${BASE_URL}/addIncident`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.success) {
              showToast("‚úÖ Incident added successfully");
              closeIncidentModal();
              fetchIncidents(); // refresh table
            } else {
              showToast("‚ùå Failed to add incident");
            }
          })
          .catch(() => showToast("‚ùå Server error"));
      }
    </script>
  </body>
</html>
